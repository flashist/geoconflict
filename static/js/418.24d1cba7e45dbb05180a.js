(()=>{var t,e,i={38001:(t,e,i)=>{"use strict";const s="AllPlayers";var r;!function(t){t.Easy="Easy",t.Medium="Medium",t.Hard="Hard",t.Impossible="Impossible"}(r||(r={}));const n="Duos",a="Trios",o="Quads",h="Blue",l="Teal",c="Purple",u="Yellow",d="Orange",g="Green",p="Bot";var m,f,y,w,b,T;!function(t){t.World="World",t.GiantWorldMap="Giant World Map",t.Europe="Europe",t.EuropeClassic="Europe Classic",t.Mena="Mena",t.NorthAmerica="North America",t.SouthAmerica="South America",t.Oceania="Oceania",t.BlackSea="Black Sea",t.Africa="Africa",t.Pangaea="Pangaea",t.Asia="Asia",t.Mars="Mars",t.Britannia="Britannia",t.GatewayToTheAtlantic="Gateway to the Atlantic",t.Australia="Australia",t.Iceland="Iceland",t.EastAsia="East Asia",t.BetweenTwoSeas="Between Two Seas",t.FaroeIslands="Faroe Islands",t.DeglaciatedAntarctica="Deglaciated Antarctica",t.FalklandIslands="Falkland Islands",t.Baikal="Baikal",t.Halkidiki="Halkidiki",t.StraitOfGibraltar="Strait of Gibraltar",t.Italia="Italia",t.Japan="Japan",t.Yenisei="Yenisei",t.Pluto="Pluto",t.Montreal="Montreal"}(m||(m={})),m.World,m.GiantWorldMap,m.NorthAmerica,m.SouthAmerica,m.Europe,m.EuropeClassic,m.Asia,m.Africa,m.Oceania,m.BlackSea,m.Britannia,m.GatewayToTheAtlantic,m.BetweenTwoSeas,m.Iceland,m.EastAsia,m.Mena,m.Australia,m.FaroeIslands,m.FalklandIslands,m.Baikal,m.Halkidiki,m.StraitOfGibraltar,m.Italia,m.Japan,m.Yenisei,m.Montreal,m.Pangaea,m.Pluto,m.Mars,m.DeglaciatedAntarctica,function(t){t.Singleplayer="Singleplayer",t.Public="Public",t.Private="Private"}(f||(f={})),function(t){t.FFA="Free For All",t.Team="Team"}(y||(y={})),function(t){t.Compact="Compact",t.Normal="Normal"}(w||(w={})),function(t){t.TransportShip="Transport",t.Warship="Warship",t.Shell="Shell",t.SAMMissile="SAMMissile",t.Port="Port",t.AtomBomb="Atom Bomb",t.HydrogenBomb="Hydrogen Bomb",t.TradeShip="Trade Ship",t.MissileSilo="Missile Silo",t.DefensePost="Defense Post",t.SAMLauncher="SAM Launcher",t.City="City",t.MIRV="MIRV",t.MIRVWarhead="MIRV Warhead",t.Construction="Construction",t.Train="Train",t.Factory="Factory"}(b||(b={})),function(t){t.Engine="Engine",t.Carriage="Carriage"}(T||(T={}));const M=new Set([b.City,b.Construction,b.DefensePost,b.SAMLauncher,b.MissileSilo,b.Port]);var v,_,A,S,k,E;b.AtomBomb,b.HydrogenBomb,b.MIRVWarhead,b.MIRV,function(t){t[t.Hostile=0]="Hostile",t[t.Distrustful=1]="Distrustful",t[t.Neutral=2]="Neutral",t[t.Friendly=3]="Friendly"}(v||(v={}));class I{constructor(t,e,i){this.spawnCell=t,this.strength=e,this.playerInfo=i}}class D{constructor(t,e){this.x=t,this.y=e,this.strRepr=`Cell[${this.x},${this.y}]`}pos(){return{x:this.x,y:this.y}}toString(){return this.strRepr}}!function(t){t[t.Plains=0]="Plains",t[t.Highland=1]="Highland",t[t.Mountain=2]="Mountain",t[t.Lake=3]="Lake",t[t.Ocean=4]="Ocean"}(_||(_={})),function(t){t.Bot="BOT",t.Human="HUMAN",t.FakeHuman="FAKEHUMAN"}(A||(A={}));class x{constructor(t,e,i,s,r){if(this.name=t,this.playerType=e,this.clientID=i,this.id=s,this.nation=r,t.startsWith("[")&&t.includes("]")){const e=t.match(/^\[([a-zA-Z]{2,5})\]/);this.clan=e?e[1]:null}else this.clan=null}}function C(t){return t&&"object"==typeof t&&"isUnit"in t&&"function"==typeof t.isUnit&&t.isUnit()}function P(t,e,i){return Math.min(Math.max(t,e),i)}function R(t,e){const i="number"==typeof e?e:e.tile();return(e,s)=>t.manhattanDist(e.tile(),i)-t.manhattanDist(s.tile(),i)}function j(t){let e=0;for(let i=0;i<t.length;i++)e=(e<<5)-e+t.charCodeAt(i),e&=e;return Math.abs(e)}function N(t,e){let i=1/0,s=1/0,r=-1/0,n=-1/0;return e.forEach((e=>{const a=t.cell(e);i=Math.min(i,a.x),s=Math.min(s,a.y),r=Math.max(r,a.x),n=Math.max(n,a.y)})),{min:new D(i,s),max:new D(r,n)}}function B(t,e,i){const s=[],r=t.x(e),n=t.y(e),a=r-i,o=r+i,h=n-i,l=n+i;for(let e=a;e<=o;e++)t.isValidCoord(e,h)&&s.push(t.ref(e,h)),t.isValidCoord(e,l)&&h!==l&&s.push(t.ref(e,l));for(let e=h+1;e<l;e++)t.isValidCoord(a,e)&&s.push(t.ref(a,e)),t.isValidCoord(o,e)&&a!==o&&s.push(t.ref(o,e));return s}function O(t,e){return t.min.x<=e.min.x&&t.min.y<=e.min.y&&t.max.x>=e.max.x&&t.max.y>=e.max.y}function U(t){return Array.from(t).join("").replace(/[^\p{L}\p{N}\s\p{Emoji}\p{Emoji_Component}[\]_]/gu,"")}function F(t){throw new Error("Unexpected value: "+t)}function L(t){return t===1/0?BigInt(Number.MAX_SAFE_INTEGER):t===-1/0?BigInt(Number.MIN_SAFE_INTEGER):BigInt(Math.floor(t))}function q(t,e){return t<e?t:e}(E=S||(S={}))[E.ATTACK_FAILED=0]="ATTACK_FAILED",E[E.ATTACK_CANCELLED=1]="ATTACK_CANCELLED",E[E.ATTACK_REQUEST=2]="ATTACK_REQUEST",E[E.CONQUERED_PLAYER=3]="CONQUERED_PLAYER",E[E.MIRV_INBOUND=4]="MIRV_INBOUND",E[E.NUKE_INBOUND=5]="NUKE_INBOUND",E[E.HYDROGEN_BOMB_INBOUND=6]="HYDROGEN_BOMB_INBOUND",E[E.NAVAL_INVASION_INBOUND=7]="NAVAL_INVASION_INBOUND",E[E.SAM_MISS=8]="SAM_MISS",E[E.SAM_HIT=9]="SAM_HIT",E[E.CAPTURED_ENEMY_UNIT=10]="CAPTURED_ENEMY_UNIT",E[E.UNIT_CAPTURED_BY_ENEMY=11]="UNIT_CAPTURED_BY_ENEMY",E[E.UNIT_DESTROYED=12]="UNIT_DESTROYED",E[E.ALLIANCE_ACCEPTED=13]="ALLIANCE_ACCEPTED",E[E.ALLIANCE_REJECTED=14]="ALLIANCE_REJECTED",E[E.ALLIANCE_REQUEST=15]="ALLIANCE_REQUEST",E[E.ALLIANCE_BROKEN=16]="ALLIANCE_BROKEN",E[E.ALLIANCE_EXPIRED=17]="ALLIANCE_EXPIRED",E[E.SENT_GOLD_TO_PLAYER=18]="SENT_GOLD_TO_PLAYER",E[E.RECEIVED_GOLD_FROM_PLAYER=19]="RECEIVED_GOLD_FROM_PLAYER",E[E.RECEIVED_GOLD_FROM_TRADE=20]="RECEIVED_GOLD_FROM_TRADE",E[E.SENT_TROOPS_TO_PLAYER=21]="SENT_TROOPS_TO_PLAYER",E[E.RECEIVED_TROOPS_FROM_PLAYER=22]="RECEIVED_TROOPS_FROM_PLAYER",E[E.CHAT=23]="CHAT",E[E.RENEW_ALLIANCE=24]="RENEW_ALLIANCE",function(t){t.ATTACK="ATTACK",t.NUKE="NUKE",t.ALLIANCE="ALLIANCE",t.TRADE="TRADE",t.CHAT="CHAT"}(k||(k={})),S.ATTACK_FAILED,k.ATTACK,S.ATTACK_CANCELLED,k.ATTACK,S.ATTACK_REQUEST,k.ATTACK,S.CONQUERED_PLAYER,k.ATTACK,S.MIRV_INBOUND,k.NUKE,S.NUKE_INBOUND,k.NUKE,S.HYDROGEN_BOMB_INBOUND,k.NUKE,S.NAVAL_INVASION_INBOUND,k.ATTACK,S.SAM_MISS,k.ATTACK,S.SAM_HIT,k.ATTACK,S.CAPTURED_ENEMY_UNIT,k.ATTACK,S.UNIT_CAPTURED_BY_ENEMY,k.ATTACK,S.UNIT_DESTROYED,k.ATTACK,S.ALLIANCE_ACCEPTED,k.ALLIANCE,S.ALLIANCE_REJECTED,k.ALLIANCE,S.ALLIANCE_REQUEST,k.ALLIANCE,S.ALLIANCE_BROKEN,k.ALLIANCE,S.ALLIANCE_EXPIRED,k.ALLIANCE,S.RENEW_ALLIANCE,k.ALLIANCE,S.SENT_GOLD_TO_PLAYER,k.TRADE,S.RECEIVED_GOLD_FROM_PLAYER,k.TRADE,S.RECEIVED_GOLD_FROM_TRADE,k.TRADE,S.SENT_TROOPS_TO_PLAYER,k.TRADE,S.RECEIVED_TROOPS_FROM_PLAYER,k.TRADE,S.CHAT,k.CHAT,i(99418);const $=[["üòÄ","üòä","ü•∞","üòá","üòé"],["üòû","ü•∫","üò≠","üò±","üò°"],["üòà","ü§°","üñï","ü•±","ü§¶‚Äç‚ôÇÔ∏è"],["üëã","üëè","ü§å","üí™","ü´°"],["üëç","üëé","‚ùì","üêî","üêÄ"],["ü§ù","üÜò","üïäÔ∏è","üè≥Ô∏è","‚è≥"],["üî•","üí•","üíÄ","‚ò¢Ô∏è","‚ö†Ô∏è"],["‚ÜñÔ∏è","‚¨ÜÔ∏è","‚ÜóÔ∏è","üëë","ü•á"],["‚¨ÖÔ∏è","üéØ","‚û°Ô∏è","ü•à","ü•â"],["‚ÜôÔ∏è","‚¨áÔ∏è","‚ÜòÔ∏è","‚ù§Ô∏è","üíî"],["üí∞","‚öì","‚õµ","üè°","üõ°Ô∏è"]].flat();function W(t,e,i){return 1/(1+Math.exp(-e*(t-i)))}function H(t,e){const i=e.largestClusterBoundingBox??N(t,e.borderTiles());let s=1;const r=i.max.x-i.min.x,n=i.max.y-i.min.y,a=Math.min(r,n);s=a<25?1:a<50?2:a<100?4:a<250?8:a<500?16:32;const o=function(t,e,i,s){const r={min:{x:Math.floor(i.min.x/s),y:Math.floor(i.min.y/s)},max:{x:Math.floor(i.max.x/s),y:Math.floor(i.max.y/s)}},n=r.max.x-r.min.x+1,a=r.max.y-r.min.y+1,o=Array(n).fill(null).map((()=>Array(a).fill(!1)));for(let i=r.min.x;i<=r.max.x;i++)for(let n=r.min.y;n<=r.max.y;n++){const a=new D(i*s,n*s);if(t.isOnMap(a)){const s=t.ref(a.x,a.y);o[i-r.min.x][n-r.min.y]=t.isLake(s)||t.owner(s)===e||t.hasFallout(s)}}return o}(t,e,i,s),h=function(t){const e=t[0].length,i=t.length,s=new Array(i).fill(0);let r={x:0,y:0,width:0,height:0};for(let n=0;n<e;n++){for(let e=0;e<i;e++)t[e][n]?s[e]++:s[e]=0;const e=G(s);e.width*e.height>r.width*r.height&&(r={x:e.x,y:n-e.height+1,width:e.width,height:e.height})}return r}(o);h.x=h.x*s,h.y=h.y*s,h.width=h.width*s,h.height=h.height*s;let l=new D(Math.floor(h.x+h.width/2+i.min.x),Math.floor(h.y+h.height/2+i.min.y));const c=function(t,e){const i=t.width/e.length*2,s=t.height/3;return Math.min(i,s)}(h,e.name());return l=new D(l.x,l.y-c/3),{x:Math.ceil(l.x),y:Math.ceil(l.y),size:c}}function G(t){const e=[];let i=0,s={x:0,y:0,width:0,height:0};for(let r=0;r<=t.length;r++){const n=r===t.length?0:t[r];for(;e.length>0&&n<t[e[e.length-1]];){const n=t[e.pop()],a=0===e.length?r:r-e[e.length-1]-1;n*a>i&&(i=n*a,s={x:0===e.length?0:e[e.length-1]+1,y:0,width:a,height:n})}e.push(r)}return s}var V;!function(t){t[t.Dev=0]="Dev",t[t.Preprod=1]="Preprod",t[t.Prod=2]="Prod"}(V||(V={}));var z=i(88399),K=i(73371),Y=i(83640),X=i(7391),Q=i.n(X);class J{constructor(t){this.rng=Q()(String(t))}next(){return this.rng()}nextInt(t,e){return Math.floor(this.rng()*(e-t))+t}nextFloat(t,e){return this.rng()*(e-t)+t}nextID(){return Math.floor(this.rng()*J.POW36_8).toString(36).padStart(8,"0")}randElement(t){if(0===t.length)throw new Error("array must not be empty");return t[this.nextInt(0,t.length)]}randFromSet(t){const e=t.size;if(0===e)throw new Error("set must not be empty");const i=this.nextInt(0,e);let s=0;for(const e of t){if(s===i)return e;s++}throw new Error("Unexpected error selecting element from set")}chance(t){return 0===this.nextInt(0,t)}shuffleArray(t){const e=[...t];for(let t=e.length-1;t>0;t--){const i=this.nextInt(0,t+1);[e[t],e[i]]=[e[i],e[t]]}return e}}J.POW36_8=Math.pow(36,8);var Z=i(20008),tt=i(9908),et=i(94792);(0,Y.X$)([tt.A]),(0,Y.X$)([Z.A]);const it=(0,Y.Mj)({h:0,s:82,l:56}),st=(0,Y.Mj)({h:224,s:100,l:58}),rt=(0,Y.Mj)({h:172,s:66,l:50}),nt=(0,Y.Mj)({h:271,s:81,l:56}),at=(0,Y.Mj)({h:45,s:93,l:47}),ot=(0,Y.Mj)({h:25,s:95,l:53}),ht=(0,Y.Mj)({h:128,s:49,l:50}),lt=(0,Y.Mj)({h:36,s:10,l:80}),ct=wt(it),ut=wt(st),dt=wt(rt),gt=wt(nt),pt=wt(at),mt=wt(ot),ft=wt(ht),yt=[(0,Y.Mj)(lt)];function wt(t){const{h:e,s:i,l:s}=t.toHsl();return Array.from({length:64},((t,r)=>{const n=r/63,a=i*(1-.3*n),o=Math.min(100,s+30*n);return(0,Y.Mj)({h:e,s:a,l:o})}))}const bt=[(0,Y.Mj)({r:230,g:100,b:100}),(0,Y.Mj)({r:100,g:180,b:230}),(0,Y.Mj)({r:230,g:180,b:80}),(0,Y.Mj)({r:180,g:100,b:230}),(0,Y.Mj)({r:80,g:200,b:120}),(0,Y.Mj)({r:230,g:130,b:180}),(0,Y.Mj)({r:100,g:160,b:80}),(0,Y.Mj)({r:230,g:150,b:100}),(0,Y.Mj)({r:80,g:130,b:190}),(0,Y.Mj)({r:210,g:210,b:100}),(0,Y.Mj)({r:190,g:100,b:130}),(0,Y.Mj)({r:100,g:210,b:210}),(0,Y.Mj)({r:210,g:140,b:80}),(0,Y.Mj)({r:150,g:110,b:190}),(0,Y.Mj)({r:180,g:210,b:120}),(0,Y.Mj)({r:210,g:100,b:160}),(0,Y.Mj)({r:100,g:140,b:110}),(0,Y.Mj)({r:230,g:180,b:180}),(0,Y.Mj)({r:120,g:120,b:190}),(0,Y.Mj)({r:190,g:170,b:100}),(0,Y.Mj)({r:100,g:180,b:160}),(0,Y.Mj)({r:210,g:160,b:200}),(0,Y.Mj)({r:170,g:190,b:100}),(0,Y.Mj)({r:100,g:130,b:150}),(0,Y.Mj)({r:230,g:140,b:140}),(0,Y.Mj)({r:140,g:180,b:220}),(0,Y.Mj)({r:200,g:160,b:110}),(0,Y.Mj)({r:180,g:130,b:180}),(0,Y.Mj)({r:130,g:200,b:130}),(0,Y.Mj)({r:220,g:120,b:120}),(0,Y.Mj)({r:120,g:160,b:200}),(0,Y.Mj)({r:200,g:200,b:140}),(0,Y.Mj)({r:160,g:120,b:160}),(0,Y.Mj)({r:140,g:180,b:140}),(0,Y.Mj)({r:200,g:130,b:110}),(0,Y.Mj)({r:130,g:170,b:190}),(0,Y.Mj)({r:190,g:180,b:160}),(0,Y.Mj)({r:170,g:140,b:190}),(0,Y.Mj)({r:160,g:190,b:160}),(0,Y.Mj)({r:190,g:150,b:130}),(0,Y.Mj)({r:140,g:150,b:180}),(0,Y.Mj)({r:180,g:170,b:140}),(0,Y.Mj)({r:150,g:130,b:150}),(0,Y.Mj)({r:170,g:190,b:180}),(0,Y.Mj)({r:190,g:140,b:150}),(0,Y.Mj)({r:130,g:180,b:170}),(0,Y.Mj)({r:180,g:160,b:180}),(0,Y.Mj)({r:160,g:180,b:140}),(0,Y.Mj)({r:170,g:150,b:170}),(0,Y.Mj)({r:100,g:180,b:230}),(0,Y.Mj)({r:230,g:180,b:80}),(0,Y.Mj)({r:180,g:100,b:230}),(0,Y.Mj)({r:80,g:200,b:120}),(0,Y.Mj)({r:230,g:130,b:180}),(0,Y.Mj)({r:100,g:160,b:80}),(0,Y.Mj)({r:230,g:150,b:100}),(0,Y.Mj)({r:80,g:130,b:190}),(0,Y.Mj)({r:210,g:210,b:100}),(0,Y.Mj)({r:190,g:100,b:130}),(0,Y.Mj)({r:100,g:210,b:210}),(0,Y.Mj)({r:210,g:140,b:80}),(0,Y.Mj)({r:150,g:110,b:190}),(0,Y.Mj)({r:180,g:210,b:120}),(0,Y.Mj)({r:210,g:100,b:160}),(0,Y.Mj)({r:100,g:140,b:110}),(0,Y.Mj)({r:230,g:180,b:180}),(0,Y.Mj)({r:120,g:120,b:190}),(0,Y.Mj)({r:190,g:170,b:100}),(0,Y.Mj)({r:100,g:180,b:160}),(0,Y.Mj)({r:210,g:160,b:200}),(0,Y.Mj)({r:170,g:190,b:100}),(0,Y.Mj)({r:100,g:130,b:150}),(0,Y.Mj)({r:230,g:140,b:140}),(0,Y.Mj)({r:140,g:180,b:220}),(0,Y.Mj)({r:200,g:160,b:110}),(0,Y.Mj)({r:180,g:130,b:180}),(0,Y.Mj)({r:130,g:200,b:130}),(0,Y.Mj)({r:220,g:120,b:120}),(0,Y.Mj)({r:120,g:160,b:200}),(0,Y.Mj)({r:200,g:200,b:140}),(0,Y.Mj)({r:160,g:120,b:160}),(0,Y.Mj)({r:140,g:180,b:140}),(0,Y.Mj)({r:200,g:130,b:110}),(0,Y.Mj)({r:130,g:170,b:190}),(0,Y.Mj)({r:190,g:180,b:160}),(0,Y.Mj)({r:170,g:140,b:190}),(0,Y.Mj)({r:160,g:190,b:160}),(0,Y.Mj)({r:190,g:150,b:130}),(0,Y.Mj)({r:140,g:150,b:180}),(0,Y.Mj)({r:180,g:170,b:140}),(0,Y.Mj)({r:150,g:130,b:150}),(0,Y.Mj)({r:170,g:190,b:180}),(0,Y.Mj)({r:190,g:140,b:150}),(0,Y.Mj)({r:130,g:180,b:170}),(0,Y.Mj)({r:180,g:160,b:180}),(0,Y.Mj)({r:160,g:180,b:140}),(0,Y.Mj)({r:170,g:150,b:170})],Tt=[(0,Y.Mj)({r:16,g:185,b:129}),(0,Y.Mj)({r:34,g:197,b:94}),(0,Y.Mj)({r:45,g:212,b:191}),(0,Y.Mj)({r:48,g:178,b:180}),(0,Y.Mj)({r:52,g:211,b:153}),(0,Y.Mj)({r:56,g:189,b:248}),(0,Y.Mj)({r:59,g:130,b:246}),(0,Y.Mj)({r:67,g:190,b:84}),(0,Y.Mj)({r:74,g:222,b:128}),(0,Y.Mj)({r:79,g:70,b:229}),(0,Y.Mj)({r:82,g:183,b:136}),(0,Y.Mj)({r:96,g:165,b:250}),(0,Y.Mj)({r:99,g:202,b:253}),(0,Y.Mj)({r:110,g:231,b:183}),(0,Y.Mj)({r:124,g:58,b:237}),(0,Y.Mj)({r:125,g:211,b:252}),(0,Y.Mj)({r:132,g:204,b:22}),(0,Y.Mj)({r:133,g:77,b:14}),(0,Y.Mj)({r:134,g:239,b:172}),(0,Y.Mj)({r:147,g:51,b:234}),(0,Y.Mj)({r:147,g:197,b:253}),(0,Y.Mj)({r:151,g:255,b:187}),(0,Y.Mj)({r:163,g:230,b:53}),(0,Y.Mj)({r:167,g:139,b:250}),(0,Y.Mj)({r:168,g:85,b:247}),(0,Y.Mj)({r:179,g:136,b:255}),(0,Y.Mj)({r:186,g:255,b:201}),(0,Y.Mj)({r:190,g:92,b:251}),(0,Y.Mj)({r:192,g:132,b:252}),(0,Y.Mj)({r:202,g:138,b:4}),(0,Y.Mj)({r:202,g:225,b:255}),(0,Y.Mj)({r:204,g:204,b:255}),(0,Y.Mj)({r:217,g:70,b:239}),(0,Y.Mj)({r:220,g:38,b:38}),(0,Y.Mj)({r:220,g:220,b:255}),(0,Y.Mj)({r:220,g:240,b:250}),(0,Y.Mj)({r:230,g:250,b:210}),(0,Y.Mj)({r:230,g:255,b:250}),(0,Y.Mj)({r:233,g:213,b:255}),(0,Y.Mj)({r:234,g:88,b:12}),(0,Y.Mj)({r:234,g:179,b:8}),(0,Y.Mj)({r:235,g:75,b:75}),(0,Y.Mj)({r:236,g:72,b:153}),(0,Y.Mj)({r:239,g:68,b:68}),(0,Y.Mj)({r:240,g:171,b:252}),(0,Y.Mj)({r:240,g:240,b:200}),(0,Y.Mj)({r:244,g:114,b:182}),(0,Y.Mj)({r:245,g:101,b:101}),(0,Y.Mj)({r:245,g:158,b:11}),(0,Y.Mj)({r:248,g:113,b:113}),(0,Y.Mj)({r:249,g:115,b:22}),(0,Y.Mj)({r:250,g:215,b:225}),(0,Y.Mj)({r:250,g:250,b:210}),(0,Y.Mj)({r:251,g:113,b:133}),(0,Y.Mj)({r:251,g:146,b:60}),(0,Y.Mj)({r:251,g:191,b:36}),(0,Y.Mj)({r:251,g:235,b:245}),(0,Y.Mj)({r:252,g:165,b:165}),(0,Y.Mj)({r:252,g:211,b:77}),(0,Y.Mj)({r:253,g:164,b:175}),(0,Y.Mj)({r:255,g:204,b:229}),(0,Y.Mj)({r:255,g:223,b:186}),(0,Y.Mj)({r:255,g:240,b:200})],Mt=[(0,Y.Mj)({r:190,g:120,b:120}),(0,Y.Mj)({r:120,g:160,b:190}),(0,Y.Mj)({r:190,g:160,b:100}),(0,Y.Mj)({r:160,g:120,b:190}),(0,Y.Mj)({r:100,g:170,b:130}),(0,Y.Mj)({r:190,g:130,b:160}),(0,Y.Mj)({r:120,g:150,b:100}),(0,Y.Mj)({r:190,g:140,b:120}),(0,Y.Mj)({r:100,g:120,b:160}),(0,Y.Mj)({r:170,g:170,b:120}),(0,Y.Mj)({r:160,g:120,b:130}),(0,Y.Mj)({r:120,g:170,b:170}),(0,Y.Mj)({r:170,g:140,b:100}),(0,Y.Mj)({r:140,g:120,b:160}),(0,Y.Mj)({r:150,g:170,b:130}),(0,Y.Mj)({r:170,g:120,b:140}),(0,Y.Mj)({r:120,g:140,b:120}),(0,Y.Mj)({r:180,g:160,b:160}),(0,Y.Mj)({r:130,g:130,b:160}),(0,Y.Mj)({r:160,g:150,b:120}),(0,Y.Mj)({r:120,g:160,b:150}),(0,Y.Mj)({r:170,g:150,b:170}),(0,Y.Mj)({r:150,g:160,b:120}),(0,Y.Mj)({r:120,g:130,b:140}),(0,Y.Mj)({r:180,g:140,b:140}),(0,Y.Mj)({r:140,g:160,b:170}),(0,Y.Mj)({r:170,g:150,b:130}),(0,Y.Mj)({r:160,g:130,b:160}),(0,Y.Mj)({r:130,g:170,b:130}),(0,Y.Mj)({r:170,g:130,b:130}),(0,Y.Mj)({r:130,g:150,b:170}),(0,Y.Mj)({r:170,g:170,b:140}),(0,Y.Mj)({r:150,g:130,b:150}),(0,Y.Mj)({r:140,g:160,b:140}),(0,Y.Mj)({r:170,g:130,b:120}),(0,Y.Mj)({r:130,g:150,b:160}),(0,Y.Mj)({r:160,g:160,b:150}),(0,Y.Mj)({r:150,g:140,b:160}),(0,Y.Mj)({r:150,g:170,b:150}),(0,Y.Mj)({r:160,g:140,b:130}),(0,Y.Mj)({r:140,g:150,b:160}),(0,Y.Mj)({r:160,g:150,b:140}),(0,Y.Mj)({r:140,g:130,b:140}),(0,Y.Mj)({r:150,g:160,b:160}),(0,Y.Mj)({r:160,g:140,b:150}),(0,Y.Mj)({r:130,g:160,b:150}),(0,Y.Mj)({r:160,g:150,b:160}),(0,Y.Mj)({r:150,g:160,b:140}),(0,Y.Mj)({r:150,g:140,b:150})],vt=[(0,Y.Mj)({r:0,g:5,b:0}),(0,Y.Mj)({r:0,g:15,b:0}),(0,Y.Mj)({r:0,g:25,b:0}),(0,Y.Mj)({r:0,g:35,b:0}),(0,Y.Mj)({r:0,g:45,b:0}),(0,Y.Mj)({r:0,g:55,b:0}),(0,Y.Mj)({r:0,g:65,b:0}),(0,Y.Mj)({r:0,g:75,b:0}),(0,Y.Mj)({r:0,g:85,b:0}),(0,Y.Mj)({r:0,g:95,b:0}),(0,Y.Mj)({r:0,g:105,b:0}),(0,Y.Mj)({r:0,g:115,b:0}),(0,Y.Mj)({r:0,g:125,b:0}),(0,Y.Mj)({r:0,g:135,b:0}),(0,Y.Mj)({r:0,g:145,b:0}),(0,Y.Mj)({r:0,g:155,b:0}),(0,Y.Mj)({r:0,g:165,b:0}),(0,Y.Mj)({r:0,g:175,b:0}),(0,Y.Mj)({r:0,g:185,b:0}),(0,Y.Mj)({r:0,g:195,b:5}),(0,Y.Mj)({r:0,g:205,b:10}),(0,Y.Mj)({r:0,g:215,b:15}),(0,Y.Mj)({r:0,g:225,b:20}),(0,Y.Mj)({r:0,g:235,b:25}),(0,Y.Mj)({r:0,g:245,b:30}),(0,Y.Mj)({r:0,g:255,b:35}),(0,Y.Mj)({r:10,g:255,b:45}),(0,Y.Mj)({r:20,g:255,b:55}),(0,Y.Mj)({r:30,g:255,b:65}),(0,Y.Mj)({r:40,g:255,b:75}),(0,Y.Mj)({r:50,g:255,b:85}),(0,Y.Mj)({r:60,g:255,b:95}),(0,Y.Mj)({r:70,g:255,b:105}),(0,Y.Mj)({r:80,g:255,b:115}),(0,Y.Mj)({r:90,g:255,b:125}),(0,Y.Mj)({r:100,g:255,b:135}),(0,Y.Mj)({r:110,g:255,b:145}),(0,Y.Mj)({r:120,g:255,b:155}),(0,Y.Mj)({r:130,g:255,b:165}),(0,Y.Mj)({r:140,g:255,b:175}),(0,Y.Mj)({r:150,g:200,b:255}),(0,Y.Mj)({r:150,g:255,b:185}),(0,Y.Mj)({r:160,g:215,b:255}),(0,Y.Mj)({r:160,g:255,b:195}),(0,Y.Mj)({r:170,g:190,b:255}),(0,Y.Mj)({r:170,g:225,b:255}),(0,Y.Mj)({r:170,g:255,b:205}),(0,Y.Mj)({r:180,g:180,b:255}),(0,Y.Mj)({r:180,g:235,b:250}),(0,Y.Mj)({r:180,g:255,b:215}),(0,Y.Mj)({r:190,g:140,b:195}),(0,Y.Mj)({r:190,g:245,b:240}),(0,Y.Mj)({r:190,g:255,b:225}),(0,Y.Mj)({r:195,g:145,b:200}),(0,Y.Mj)({r:200,g:150,b:205}),(0,Y.Mj)({r:200,g:170,b:255}),(0,Y.Mj)({r:200,g:255,b:215}),(0,Y.Mj)({r:200,g:255,b:235}),(0,Y.Mj)({r:205,g:155,b:210}),(0,Y.Mj)({r:210,g:160,b:215}),(0,Y.Mj)({r:210,g:255,b:245}),(0,Y.Mj)({r:215,g:165,b:220}),(0,Y.Mj)({r:215,g:255,b:200}),(0,Y.Mj)({r:220,g:160,b:255}),(0,Y.Mj)({r:220,g:170,b:225}),(0,Y.Mj)({r:220,g:255,b:255}),(0,Y.Mj)({r:225,g:175,b:230}),(0,Y.Mj)({r:225,g:255,b:175}),(0,Y.Mj)({r:230,g:180,b:235}),(0,Y.Mj)({r:230,g:250,b:255}),(0,Y.Mj)({r:235,g:150,b:255}),(0,Y.Mj)({r:235,g:185,b:240}),(0,Y.Mj)({r:240,g:190,b:245}),(0,Y.Mj)({r:240,g:240,b:255}),(0,Y.Mj)({r:240,g:250,b:160}),(0,Y.Mj)({r:245,g:160,b:240}),(0,Y.Mj)({r:245,g:195,b:250}),(0,Y.Mj)({r:245,g:245,b:175}),(0,Y.Mj)({r:250,g:200,b:255}),(0,Y.Mj)({r:250,g:230,b:255}),(0,Y.Mj)({r:255,g:170,b:225}),(0,Y.Mj)({r:255,g:185,b:215}),(0,Y.Mj)({r:255,g:195,b:235}),(0,Y.Mj)({r:255,g:200,b:220}),(0,Y.Mj)({r:255,g:205,b:245}),(0,Y.Mj)({r:255,g:205,b:255}),(0,Y.Mj)({r:255,g:210,b:230}),(0,Y.Mj)({r:255,g:210,b:250}),(0,Y.Mj)({r:255,g:210,b:255}),(0,Y.Mj)({r:255,g:215,b:195}),(0,Y.Mj)({r:255,g:215,b:245}),(0,Y.Mj)({r:255,g:220,b:235}),(0,Y.Mj)({r:255,g:220,b:250}),(0,Y.Mj)({r:255,g:225,b:180}),(0,Y.Mj)({r:255,g:225,b:255}),(0,Y.Mj)({r:255,g:230,b:245}),(0,Y.Mj)({r:255,g:235,b:200}),(0,Y.Mj)({r:255,g:235,b:235}),(0,Y.Mj)({r:255,g:240,b:220}),(0,Y.Mj)({r:255,g:245,b:210})];(0,Y.X$)([tt.A]),(0,Y.X$)([Z.A]);class _t{constructor(t,e){this.assigned=new Map,this.teamPlayerColors=new Map,this.availableColors=[...t],this.fallbackColors=[...t,...e]}getTeamColorVariations(t){switch(t){case h:return ut;case"Red":return ct;case l:return dt;case c:return gt;case u:return pt;case d:return mt;case g:return ft;case p:return yt;default:return[this.assignColor(t)]}}assignColor(t){if(this.assigned.has(t))return this.assigned.get(t);0===this.availableColors.length&&(this.availableColors=[...this.fallbackColors]);let e=0;if(0===this.assigned.size||this.assigned.size>50)e=new J(j(t)).nextInt(0,this.availableColors.length);else{const t=Array.from(this.assigned.values());e=function(t,e){if(0===e.length)throw new Error("No assigned colors");const i=e.map(St);let s=0,r=0;for(let e=0;e<t.length;e++){const n=At(St(t[e]),i);n>s&&(s=n,r=e)}return r}(this.availableColors,t)??0}const i=this.availableColors.splice(e,1)[0];return this.assigned.set(t,i),i}assignTeamColor(t){return this.getTeamColorVariations(t)[0]}assignTeamPlayerColor(t,e){if(this.teamPlayerColors.has(e))return this.teamPlayerColors.get(e);const i=this.getTeamColorVariations(t),s=i[j(e)%i.length];return this.teamPlayerColors.set(e,s),s}}function At(t,e){return e.reduce(((e,i)=>{return Math.min(e,(s=i,t.deltaE(s,"2000")));var s}),1/0)}function St(t){const e=t.toLab();return new et.A("lab",[e.l,e.a,e.b])}class kt{constructor(){this.borderColorCache=new Map,this.rand=new J(123),this.humanColorAllocator=new _t(Tt,vt),this.botColorAllocator=new _t(Mt,Mt),this.teamColorAllocator=new _t(Tt,vt),this.nationColorAllocator=new _t(bt,bt),this.background=(0,Y.Mj)({r:60,g:60,b:60}),this.shore=(0,Y.Mj)({r:204,g:203,b:158}),this.falloutColors=[(0,Y.Mj)({r:120,g:255,b:71}),(0,Y.Mj)({r:130,g:255,b:85}),(0,Y.Mj)({r:110,g:245,b:65}),(0,Y.Mj)({r:125,g:255,b:75}),(0,Y.Mj)({r:115,g:250,b:68})],this.water=(0,Y.Mj)({r:70,g:132,b:180}),this.shorelineWater=(0,Y.Mj)({r:100,g:143,b:255}),this._selfColor=(0,Y.Mj)({r:0,g:255,b:0}),this._allyColor=(0,Y.Mj)({r:255,g:255,b:0}),this._neutralColor=(0,Y.Mj)({r:128,g:128,b:128}),this._enemyColor=(0,Y.Mj)({r:255,g:0,b:0}),this._spawnHighlightColor=(0,Y.Mj)({r:255,g:213,b:79})}teamColor(t){return this.teamColorAllocator.assignTeamColor(t)}territoryColor(t){const e=t.team();return null!==e?this.teamColorAllocator.assignTeamPlayerColor(e,t.id()):t.type()===A.Human?this.humanColorAllocator.assignColor(t.id()):t.type()===A.Bot?this.botColorAllocator.assignColor(t.id()):this.nationColorAllocator.assignColor(t.id())}borderColor(t){return t.darken(.125)}defendedBorderColors(t){return{light:t.darken(.2),dark:t.darken(.4)}}focusedBorderColor(){return(0,Y.Mj)({r:230,g:230,b:230})}textColor(t){return t.type()===A.Human?"#000000":"#4D4D4D"}terrainColor(t,e){const i=t.magnitude(e);if(t.isShore(e))return this.shore;switch(t.terrainType(e)){case _.Ocean:case _.Lake:{const s=this.water.rgba;return t.isShoreline(e)&&t.isWater(e)?this.shorelineWater:(0,Y.Mj)({r:Math.max(s.r-10+(11-Math.min(i,10)),0),g:Math.max(s.g-10+(11-Math.min(i,10)),0),b:Math.max(s.b-10+(11-Math.min(i,10)),0)})}case _.Plains:return(0,Y.Mj)({r:190,g:220-2*i,b:138});case _.Highland:return(0,Y.Mj)({r:200+2*i,g:183+2*i,b:138+2*i});case _.Mountain:return(0,Y.Mj)({r:230+i/2,g:230+i/2,b:230+i/2})}}backgroundColor(){return this.background}falloutColor(){return this.rand.randElement(this.falloutColors)}font(){return"Overpass, sans-serif"}selfColor(){return this._selfColor}allyColor(){return this._allyColor}neutralColor(){return this._neutralColor}enemyColor(){return this._enemyColor}spawnHighlightColor(){return this._spawnHighlightColor}}class Et extends kt{constructor(){super(...arguments),this.darkShore=(0,Y.Mj)({r:134,g:133,b:88}),this.darkWater=(0,Y.Mj)({r:14,g:11,b:30}),this.darkShorelineWater=(0,Y.Mj)({r:50,g:50,b:50})}terrainColor(t,e){const i=t.magnitude(e);if(t.isShore(e))return this.darkShore;switch(t.terrainType(e)){case _.Ocean:case _.Lake:{const s=this.darkWater.rgba;return t.isShoreline(e)&&t.isWater(e)?this.darkShorelineWater:t.magnitude(e)<10?(0,Y.Mj)({r:Math.max(s.r+9-i,0),g:Math.max(s.g+9-i,0),b:Math.max(s.b+9-i,0)}):this.darkWater}case _.Plains:return(0,Y.Mj)({r:140,g:170-2*i,b:88});case _.Highland:return(0,Y.Mj)({r:150+2*i,g:133+2*i,b:88+2*i});case _.Mountain:return(0,Y.Mj)({r:180+i/2,g:180+i/2,b:180+i/2})}}}const It=Math.LN2/5e4,Dt=z.Ik({keys:z.Ik({alg:z.eu("EdDSA"),crv:z.eu("Ed25519"),kty:z.eu("OKP"),x:z.Yj()}).array().min(1)}),xt={[m.Africa]:[100,70,50],[m.Asia]:[50,40,30],[m.Australia]:[70,40,30],[m.Baikal]:[100,70,50],[m.BetweenTwoSeas]:[70,50,40],[m.BlackSea]:[50,30,30],[m.Britannia]:[50,30,20],[m.DeglaciatedAntarctica]:[50,40,30],[m.EastAsia]:[50,30,20],[m.Europe]:[100,70,50],[m.EuropeClassic]:[50,30,30],[m.FalklandIslands]:[50,30,20],[m.FaroeIslands]:[20,15,10],[m.GatewayToTheAtlantic]:[100,70,50],[m.GiantWorldMap]:[100,70,50],[m.Halkidiki]:[100,50,40],[m.Iceland]:[50,40,30],[m.Italia]:[50,30,20],[m.Japan]:[20,15,10],[m.Mars]:[70,40,30],[m.Mena]:[70,50,40],[m.Montreal]:[60,40,30],[m.NorthAmerica]:[70,40,30],[m.Oceania]:[10,10,10],[m.Pangaea]:[20,15,10],[m.Pluto]:[100,70,50],[m.SouthAmerica]:[70,50,40],[m.StraitOfGibraltar]:[100,70,50],[m.World]:[50,30,20],[m.Yenisei]:[150,100,70]};class Ct{allowedFlares(){}stripePublishableKey(){return""}domain(){return process.env.DOMAIN??""}subdomain(){return process.env.SUBDOMAIN??""}cloudflareAccountId(){return process.env.CF_ACCOUNT_ID??""}cloudflareApiToken(){return process.env.CF_API_TOKEN??""}cloudflareConfigPath(){return process.env.CF_CONFIG_PATH??""}cloudflareCredsPath(){return process.env.CF_CREDS_PATH??""}jwtIssuer(){const t=this.jwtAudience();return"localhost"===t?"http://localhost:8787":`https://api.${t}`}async jwkPublicKey(){if(this.publicKey)return this.publicKey;const t=this.jwtIssuer()+"/.well-known/jwks.json";console.log(`Fetching JWKS from ${t}`);const e=await fetch(t),i=Dt.safeParse(await e.json());if(!i.success){const t=K.S1(i.error);throw console.error("Error parsing JWKS",t),new Error("Invalid JWKS")}return this.publicKey=i.data.keys[0],this.publicKey}otelEnabled(){return this.env()!==V.Dev&&Boolean(this.otelEndpoint())&&Boolean(this.otelAuthHeader())}otelEndpoint(){return process.env.OTEL_EXPORTER_OTLP_ENDPOINT??""}otelAuthHeader(){return process.env.OTEL_AUTH_HEADER??""}gitCommit(){return"73bf5834520daef3eec6c59d0db246d59fc0a486"}r2Endpoint(){return`https://${process.env.CF_ACCOUNT_ID}.r2.cloudflarestorage.com`}r2AccessKey(){return process.env.R2_ACCESS_KEY??""}r2SecretKey(){return process.env.R2_SECRET_KEY??""}r2Bucket(){return process.env.R2_BUCKET??""}apiKey(){return process.env.API_KEY??""}adminHeader(){return"x-admin-key"}adminToken(){return process.env.ADMIN_TOKEN??"dummy-admin-token"}turnIntervalMs(){return 100}gameCreationRate(){return 6e4}lobbyMaxPlayers(t,e,i){const[s,r,h]=xt[t]??[50,30,20],l=Math.random(),c=l<.3?s:l<.6?r:h;let u=Math.min(e===y.Team?Math.ceil(1.5*c):c,s);if(void 0===i)return u;switch(i){case n:u-=u%2;break;case a:u-=u%3;break;case o:u-=u%4;break;default:u-=u%i}return u}workerIndex(t){return j(t)%this.numWorkers()}workerPath(t){return`w${this.workerIndex(t)}`}workerPort(t){return this.workerPortByIndex(this.workerIndex(t))}workerPortByIndex(t){return 3001+t}}class Pt{constructor(t,e,i,s){this._serverConfig=t,this._gameConfig=e,this._userSettings=i,this._isReplay=s,this.pastelTheme=new kt,this.pastelThemeDark=new Et}stripePublishableKey(){return""}isReplay(){return this._isReplay}samHittingChance(){return.8}samWarheadHittingChance(){return.5}traitorDefenseDebuff(){return.5}traitorSpeedDebuff(){return.8}traitorDuration(){return 300}spawnImmunityDuration(){return 50}gameConfig(){return this._gameConfig}serverConfig(){return this._serverConfig}userSettings(){if(null===this._userSettings)throw new Error("userSettings is null");return this._userSettings}difficultyModifier(t){switch(t){case r.Easy:return 1;case r.Medium:return 3;case r.Hard:return 9;case r.Impossible:return 18}}cityTroopIncrease(){return 25e4}falloutDefenseModifier(t){return 5-2*t}SAMCooldown(){return 75}SiloCooldown(){return 75}defensePostRange(){return 30}defensePostDefenseBonus(){return 5}defensePostSpeedBonus(){return 3}playerTeams(){return this._gameConfig.playerTeams??0}spawnNPCs(){return!this._gameConfig.disableNPCs}isUnitDisabled(t){return this._gameConfig.disabledUnits?.includes(t)??!1}bots(){return this._gameConfig.bots}instantBuild(){return this._gameConfig.instantBuild}infiniteGold(){return this._gameConfig.infiniteGold}donateGold(){return this._gameConfig.donateGold}infiniteTroops(){return this._gameConfig.infiniteTroops}donateTroops(){return this._gameConfig.donateTroops}trainSpawnRate(t){return 20*(t+10)}trainGold(t){switch(t){case"ally":return 50000n;case"team":case"other":return 25000n;case"self":return 10000n}}trainStationMinRange(){return 15}trainStationMaxRange(){return 100}railroadMaxSize(){return 120}tradeShipGold(t,e){const i=Math.floor(1e5+100*t),s=e-1,r=1+s/(s+5)*2;return BigInt(Math.floor(i*r))}tradeShipSpawnRate(t,e,i){const s=Math.sqrt(this.tradeShipBaseSpawn(t,i)*this.tradeShipPortMultiplier(e));return Math.floor(25/s)}tradeShipBaseSpawn(t,e){return e<3?1:1-W(t,Math.LN2/10,55)}tradeShipPortMultiplier(t){return 1/(1+.1*t)}unitInfo(t){switch(t){case b.TransportShip:return{cost:()=>0n,territoryBound:!1};case b.Warship:return{cost:this.costWrapper((t=>Math.min(1e6,25e4*(t+1))),b.Warship),territoryBound:!1,maxHealth:1e3};case b.Shell:return{cost:()=>0n,territoryBound:!1,damage:250};case b.SAMMissile:return{cost:()=>0n,territoryBound:!1};case b.Port:return{cost:this.costWrapper((t=>Math.min(1e6,125e3*Math.pow(2,t))),b.Port,b.Factory),territoryBound:!0,constructionDuration:this.instantBuild()?0:20,upgradable:!0,canBuildTrainStation:!0};case b.AtomBomb:return{cost:this.costWrapper((()=>75e4),b.AtomBomb),territoryBound:!1};case b.HydrogenBomb:return{cost:this.costWrapper((()=>5e6),b.HydrogenBomb),territoryBound:!1};case b.MIRV:return{cost:this.costWrapper((()=>35e6),b.MIRV),territoryBound:!1};case b.MIRVWarhead:case b.TradeShip:return{cost:()=>0n,territoryBound:!1};case b.MissileSilo:return{cost:this.costWrapper((()=>1e6),b.MissileSilo),territoryBound:!0,constructionDuration:this.instantBuild()?0:100,upgradable:!0};case b.DefensePost:return{cost:this.costWrapper((t=>Math.min(25e4,5e4*(t+1))),b.DefensePost),territoryBound:!0,constructionDuration:this.instantBuild()?0:50};case b.SAMLauncher:return{cost:this.costWrapper((t=>Math.min(3e6,15e5*(t+1))),b.SAMLauncher),territoryBound:!0,constructionDuration:this.instantBuild()?0:300,upgradable:!0};case b.City:return{cost:this.costWrapper((t=>Math.min(1e6,125e3*Math.pow(2,t))),b.City),territoryBound:!0,constructionDuration:this.instantBuild()?0:20,upgradable:!0,canBuildTrainStation:!0};case b.Factory:return{cost:this.costWrapper((t=>Math.min(1e6,125e3*Math.pow(2,t))),b.Factory,b.Port),territoryBound:!0,constructionDuration:this.instantBuild()?0:20,canBuildTrainStation:!0,experimental:!0,upgradable:!0};case b.Construction:return{cost:()=>0n,territoryBound:!0};case b.Train:return{cost:()=>0n,territoryBound:!1,experimental:!0};default:F(t)}}costWrapper(t,...e){return i=>{if(i.type()===A.Human&&this.infiniteGold())return 0n;const s=e.reduce(((t,e)=>t+Math.min(i.unitsOwned(e),i.unitsConstructed(e))),0);return BigInt(t(s))}}defaultDonationAmount(t){return Math.floor(t.troops()/3)}donateCooldown(){return 100}deleteUnitCooldown(){return 50}emojiMessageDuration(){return 50}emojiMessageCooldown(){return 50}targetDuration(){return 100}targetCooldown(){return 150}allianceRequestDuration(){return 200}allianceRequestCooldown(){return 300}allianceDuration(){return 3e3}temporaryEmbargoDuration(){return 3e3}percentageTilesOwnedToWin(){return this._gameConfig.gameMode===y.Team?95:80}boatMaxNumber(){return 3}numSpawnPhaseTurns(){return this._gameConfig.gameType===f.Singleplayer?100:300}numBots(){return this.bots()}theme(){return this.userSettings()?.darkMode()?this.pastelThemeDark:this.pastelTheme}attackLogic(t,e,i,s,r){let n=0,a=0;const o=t.terrainType(r);switch(o){case _.Plains:n=80,a=16.5;break;case _.Highland:n=100,a=20;break;case _.Mountain:n=120,a=25;break;default:throw new Error(`terrain type ${o} not supported`)}if(s.isPlayer())for(const e of t.nearbyUnits(r,t.config().defensePostRange(),b.DefensePost))if(e.unit.owner()===s){n*=this.defensePostDefenseBonus(),a*=this.defensePostSpeedBonus();break}if(t.hasFallout(r)){const e=t.numTilesWithFallout()/t.numLandTiles();n*=this.falloutDefenseModifier(e),a*=this.falloutDefenseModifier(e)}if(i.isPlayer()&&s.isPlayer()&&(s.isDisconnected()&&i.isOnSameTeam(s)&&(n=0),i.type()===A.Human&&s.type()===A.Bot&&(n*=.8),i.type()===A.FakeHuman&&s.type()===A.Bot&&(n*=.8)),s.isPlayer()){const t=1-W(s.numTilesOwned(),It,15e4),r=.7+.3*t,o=.7+.3*t;let h=1;i.numTilesOwned()>1e5&&(h=Math.sqrt(1e5/i.numTilesOwned())**.7);let l=1;return i.numTilesOwned()>1e5&&(l=(1e5/i.numTilesOwned())**.6),{attackerTroopLoss:P(s.troops()/e,.6,2)*n*.8*o*h*(s.isTraitor()?this.traitorDefenseDebuff():1),defenderTroopLoss:s.troops()/s.numTilesOwned(),tilesPerTickUsed:P(s.troops()/(5*e),.2,1.5)*a*r*l*(s.isTraitor()?this.traitorSpeedDebuff():1)}}return{attackerTroopLoss:i.type()===A.Bot?n/10:n/5,defenderTroopLoss:0,tilesPerTickUsed:P(2e3*Math.max(10,a)/e,5,100)}}attackTilesPerTick(t,e,i,s){return i.isPlayer()?P(5*t/i.troops()*2,.01,.5)*s*3:2*s}boatAttackAmount(t,e){return Math.floor(t.troops()/5)}warshipShellLifetime(){return 20}radiusPortSpawn(){return 20}proximityBonusPortsNb(t){return P(t/3,4,t)}attackAmount(t,e){return t.type()===A.Bot?t.troops()/20:t.troops()/5}startManpower(t){if(t.playerType===A.Bot)return 1e4;if(t.playerType===A.FakeHuman)switch(this._gameConfig.difficulty){case r.Easy:return 2500*(t?.nation?.strength??1);case r.Medium:return 5e3*(t?.nation?.strength??1);case r.Hard:return 2e4*(t?.nation?.strength??1);case r.Impossible:return 5e4*(t?.nation?.strength??1)}return this.infiniteTroops()?1e6:25e3}maxTroops(t){const e=t.type()===A.Human&&this.infiniteTroops()?1e9:2*(1e3*Math.pow(t.numTilesOwned(),.6)+5e4)+t.units(b.City).map((t=>t.level())).reduce(((t,e)=>t+e),0)*this.cityTroopIncrease();if(t.type()===A.Bot)return e/3;if(t.type()===A.Human)return e;switch(this._gameConfig.difficulty){case r.Easy:return.5*e;case r.Medium:return 1*e;case r.Hard:return 1.5*e;case r.Impossible:return 2*e}}troopIncreaseRate(t){const e=this.maxTroops(t);let i=10+Math.pow(t.troops(),.73)/4;if(i*=1-t.troops()/e,t.type()===A.Bot&&(i*=.6),t.type()===A.FakeHuman)switch(this._gameConfig.difficulty){case r.Easy:i*=.9;break;case r.Medium:i*=1;break;case r.Hard:i*=1.1;break;case r.Impossible:i*=1.2}return Math.min(t.troops()+i,e)-t.troops()}goldAdditionRate(t){return t.type()===A.Bot?50n:100n}nukeMagnitudes(t){switch(t){case b.MIRVWarhead:return{inner:12,outer:18};case b.AtomBomb:return{inner:12,outer:30};case b.HydrogenBomb:return{inner:80,outer:100}}throw new Error(`Unknown nuke type: ${t}`)}nukeAllianceBreakThreshold(){return 100}defaultNukeSpeed(){return 6}defaultNukeTargetableRange(){return 150}defaultSamRange(){return 70}defaultSamMissileSpeed(){return 12}nukeDeathFactor(t,e,i,s){if(t!==b.MIRVWarhead)return 5*e/Math.max(1,i);const r=.03*s,n=Math.max(0,e-r)/s;return 500*(1-Math.exp(-2*n))}structureMinDist(){return 15}shellLifetime(){return 50}warshipPatrolRange(){return 100}warshipTargettingRange(){return 130}warshipShellAttackRate(){return 20}defensePostShellAttackRate(){return 100}safeFromPiratesCooldownMax(){return 20}defensePostTargettingRange(){return 75}allianceExtensionPromptOffset(){return 300}}class Rt extends Ct{adminToken(){return"WARNING_DEV_ADMIN_KEY_DO_NOT_USE_IN_PRODUCTION"}apiKey(){return"WARNING_DEV_API_KEY_DO_NOT_USE_IN_PRODUCTION"}env(){return V.Dev}gameCreationRate(){return 5e3}samWarheadHittingChance(){return 1}samHittingChance(){return 1}numWorkers(){return 2}jwtAudience(){return"localhost"}gitCommit(){return"DEV"}domain(){return"localhost"}subdomain(){return""}}class jt extends Pt{constructor(t,e,i,s){super(t,e,i,s)}unitInfo(t){const e=super.unitInfo(t);return e.cost,e}}const Nt=new class extends Ct{env(){return V.Preprod}numWorkers(){return 2}jwtAudience(){return"openfront.dev"}allowedFlares(){}},Bt=new class extends Ct{numWorkers(){return 20}env(){return V.Prod}jwtAudience(){return"openfront.io"}};let Ot=null;async function Ut(t,e,i=!1){const s=await async function(){if(Ot)return Ot;const t=await fetch("/api/env");if(!t.ok)throw new Error(`Failed to fetch server config: ${t.status} ${t.statusText}`);const e=await t.json();return console.log("Server config loaded:",e),Ot=function(t){switch(t){case"dev":return console.log("using dev server config"),new Rt;case"staging":return console.log("using preprod server config"),Nt;case"prod":return console.log("using prod server config"),Bt;default:throw Error(`unsupported server configuration: ${t}`)}}(e.game_env),Ot}();switch(s.env()){case V.Dev:return new jt(s,t,e,i);case V.Preprod:case V.Prod:return console.log("using prod config"),new Pt(s,t,e,i);default:throw Error("unsupported server configuration: prod")}}class Ft{constructor(t,e){this.from=t,this.toID=e}init(t,e){if(!t.hasPlayer(this.toID))return void console.warn(`[AllianceExtensionExecution] Player ${this.toID} not found`);const i=t.player(this.toID);if(!this.from.isAlive()||!i.isAlive())return void console.info(`[AllianceExtensionExecution] Player ${this.from.id()} or ${this.toID} is not alive`);const s=this.from.allianceWith(i);s?(s.addExtensionRequest(this.from),s.bothAgreedToExtend()&&(s.extend(),t.displayMessage("events_display.alliance_renewed",S.ALLIANCE_ACCEPTED,this.from.id(),void 0,{name:i.displayName()}),t.displayMessage("events_display.alliance_renewed",S.ALLIANCE_ACCEPTED,this.toID,void 0,{name:this.from.displayName()}))):console.warn(`[AllianceExtensionExecution] No alliance to extend between ${this.from.id()} and ${this.toID}`)}tick(t){}isActive(){return!1}activeDuringSpawnPhase(){return!1}}class Lt{constructor(t,e){this.requestor=t,this.recipientID=e,this.req=null,this.active=!0}init(t,e){if(this.mg=t,!t.hasPlayer(this.recipientID))return void console.warn(`AllianceRequestExecution recipient ${this.recipientID} not found`);const i=t.player(this.recipientID);if(this.requestor.canSendAllianceRequest(i)){const t=i.outgoingAllianceRequests().find((t=>t.recipient()===this.requestor));t?(this.active=!1,t.accept()):this.req=this.requestor.createAllianceRequest(i)}else console.warn("cannot send alliance request"),this.active=!1}tick(t){"accepted"!==this.req?.status()&&"rejected"!==this.req?.status()?this.mg.ticks()-(this.req?.createdAt()??0)>this.mg.config().allianceRequestDuration()&&(this.req?.reject(),this.active=!1):this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class qt{constructor(t,e,i){this.requestorID=t,this.recipient=e,this.accept=i,this.active=!0,this.requestor=null}init(t,e){if(!t.hasPlayer(this.requestorID))return console.warn(`AllianceRequestReplyExecution requester ${this.requestorID} not found`),void(this.active=!1);this.requestor=t.player(this.requestorID)}tick(t){if(null===this.requestor)throw new Error("Not initialized");if(this.requestor.isFriendly(this.recipient))console.warn("already allied");else{const t=this.requestor.outgoingAllianceRequests().find((t=>t.recipient()===this.recipient));void 0===t?console.warn("no alliance request found"):this.accept?(t.accept(),this.requestor.updateRelation(this.recipient,100),this.recipient.updateRelation(this.requestor,100)):t.reject()}this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class $t{constructor(t,e){this.requestor=t,this.recipientID=e,this.active=!0,this.recipient=null,this.mg=null}init(t,e){if(!t.hasPlayer(this.recipientID))return console.warn(`BreakAllianceExecution: recipient ${this.recipientID} not found`),void(this.active=!1);this.recipient=t.player(this.recipientID),this.mg=t}tick(t){if(null===this.mg||null===this.requestor||null===this.recipient)throw new Error("Not initialized");const e=this.requestor.allianceWith(this.recipient);if(null===e)console.warn("cant break alliance, not allied");else{this.requestor.breakAlliance(e),this.recipient.updateRelation(this.requestor,-200);for(const t of this.mg.players())t===this.requestor||t.isOnSameTeam(this.requestor)||t.updateRelation(this.requestor,-40)}this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}function Wt(t){return Ht(t/10)}function Ht(t,e){return t=Number(t),(t=Math.max(t,0))>=1e7?(Math.floor(t/1e5)/10).toFixed(e??1)+"M":t>=1e6?(Math.floor(t/1e4)/100).toFixed(e??2)+"M":t>=1e5?Math.floor(t/1e3)+"K":t>=1e4?(Math.floor(t/100)/10).toFixed(e??1)+"K":t>=1e3?(Math.floor(t/10)/100).toFixed(e??2)+"K":Math.floor(t).toString()}class Gt{constructor(t=1024){this.len=0,this.pri=new Float32Array(t),this.tiles=new Array(t)}clear(){this.len=0}size(){return this.len}enqueue(t,e){this.len===this.pri.length&&this.grow();let i=this.len++;for(;i>0;){const t=i-1>>1;if(e>=this.pri[t])break;this.pri[i]=this.pri[t],this.tiles[i]=this.tiles[t],i=t}this.pri[i]=e,this.tiles[i]=t}dequeue(){if(0===this.len)throw new Error("heap empty");const t=this.tiles[0],e=this.pri[0],i=this.pri[--this.len],s=this.tiles[this.len];let r=0;for(;;){const t=1+(r<<1);if(t>=this.len)break;const e=t+1,s=e<this.len&&this.pri[e]<this.pri[t]?e:t;if(i<=this.pri[s])break;this.pri[r]=this.pri[s],this.tiles[r]=this.tiles[s],r=s}return this.pri[r]=i,this.tiles[r]=s,[t,e]}grow(){const t=this.pri.length<<1,e=new Float32Array(t);e.set(this.pri),this.pri=e,this.tiles.length=t}}class Vt{constructor(t=null,e,i,s=null,r=!0){this.startTroops=t,this._owner=e,this._targetID=i,this.sourceTile=s,this.removeTroops=r,this.active=!0,this.toConquer=new Gt,this.random=new J(123),this.attack=null}targetID(){return this._targetID}activeDuringSpawnPhase(){return!1}init(t,e){if(this.active){if(this.mg=t,null!==this._targetID&&!t.hasPlayer(this._targetID))return console.warn(`target ${this._targetID} not found`),void(this.active=!1);if(this.target=this._targetID===this.mg.terraNullius().id()?t.terraNullius():t.player(this._targetID),this._owner===this.target)return console.error(`Player ${this._owner} cannot attack itself`),void(this.active=!1);if(this.target.isPlayer()){const t=this.target;if(this._owner.isFriendly(t))return console.warn(`${this._owner.displayName()} cannot attack ${t.displayName()} because they are friendly (allied or same team)`),void(this.active=!1)}if(this.target&&this.target.isPlayer()){const t=this.target;t.type()!==A.Bot&&this._owner.type()!==A.Bot&&(t.addEmbargo(this._owner,!0),this.rejectIncomingAllianceRequests(t))}if(this.target.isPlayer()&&this.mg.config().numSpawnPhaseTurns()+this.mg.config().spawnImmunityDuration()>this.mg.ticks())return console.warn("cannot attack player during immunity phase"),void(this.active=!1);this.startTroops??(this.startTroops=this.mg.config().attackAmount(this._owner,this.target)),this.removeTroops&&(this.startTroops=Math.min(this._owner.troops(),this.startTroops),this._owner.removeTroops(this.startTroops)),this.attack=this._owner.createAttack(this.target,this.startTroops,this.sourceTile,new Set),null!==this.sourceTile?this.addNeighbors(this.sourceTile):this.refreshToConquer(),this.mg.stats().attack(this._owner,this.target,this.startTroops);for(const t of this._owner.incomingAttacks())if(t.attacker()===this.target){if(t.troops()>this.attack.troops())return t.setTroops(t.troops()-this.attack.troops()),this.attack.delete(),void(this.active=!1);this.attack.setTroops(this.attack.troops()-t.troops()),t.delete()}for(const t of this._owner.outgoingAttacks())t!==this.attack&&t.target()===this.attack.target()&&null===this.attack.sourceTile()&&(this.attack.setTroops(this.attack.troops()+t.troops()),t.delete());this.target.isPlayer()&&this.target.updateRelation(this._owner,-80)}}refreshToConquer(){if(null===this.attack)throw new Error("Attack not initialized");this.toConquer.clear(),this.attack.clearBorder();for(const t of this._owner.borderTiles())this.addNeighbors(t)}retreat(t=0){if(null===this.attack)throw new Error("Attack not initialized");const e=this.attack.troops()*(t/100);e&&this.mg.displayMessage(`Attack cancelled, ${Wt(e)} soldiers killed during retreat.`,S.ATTACK_CANCELLED,this._owner.id());const i=this.attack.troops()-e;this._owner.addTroops(i),this.attack.delete(),this.active=!1,this.attack.retreated()&&this.mg.stats().attackCancel(this._owner,this.target,i)}tick(t){if(null===this.attack)throw new Error("Attack not initialized");let e=this.attack.troops();const i=this.target.isPlayer(),s=i?this.target:null;if(this.attack.retreated())return i?this.retreat(25):this.retreat(),void(this.active=!1);if(this.attack.retreating())return;if(!this.attack.isActive())return void(this.active=!1);if(s&&this._owner.isFriendly(s))return void this.retreat();let r=this.mg.config().attackTilesPerTick(e,this._owner,this.target,this.attack.borderSize()+this.random.nextInt(0,5));for(;r>0;){if(e<1)return this.attack.delete(),void(this.active=!1);if(0===this.toConquer.size())return this.refreshToConquer(),void this.retreat();const[t]=this.toConquer.dequeue();this.attack.removeBorderTile(t);let i=!1;for(const e of this.mg.neighbors(t))if(this.mg.owner(e)===this._owner){i=!0;break}if(this.mg.owner(t)!==this.target||!i)continue;this.addNeighbors(t);const{attackerTroopLoss:n,defenderTroopLoss:a,tilesPerTickUsed:o}=this.mg.config().attackLogic(this.mg,e,this._owner,this.target,t);r-=o,e-=n,this.attack.setTroops(e),s&&s.removeTroops(a),this._owner.conquer(t),this.handleDeadDefender()}}rejectIncomingAllianceRequests(t){const e=this._owner.incomingAllianceRequests().find((e=>e.requestor()===t));void 0!==e&&e.reject()}addNeighbors(t){if(null===this.attack)throw new Error("Attack not initialized");const e=this.mg.ticks();for(const i of this.mg.neighbors(t)){if(this.mg.isWater(i)||this.mg.owner(i)!==this.target)continue;this.attack.addBorderTile(i);let t=0;for(const e of this.mg.neighbors(i))this.mg.owner(e)===this._owner&&t++;let s=0;switch(this.mg.terrainType(i)){case _.Plains:s=1;break;case _.Highland:s=1.5;break;case _.Mountain:s=2}const r=(this.random.nextInt(0,7)+10)*(1-.5*t+s/2)+e;this.toConquer.enqueue(i,r)}}handleDeadDefender(){if(this.target.isPlayer()&&this.target.numTilesOwned()<100){this.mg.conquerPlayer(this._owner,this.target);for(let t=0;t<10;t++)for(const t of this.target.tiles())if(this.mg.neighbors(t).some((t=>this.mg.owner(t)===this._owner)))this._owner.conquer(t);else for(const e of this.mg.neighbors(t)){const i=this.mg.owner(e);if(i.isPlayer()&&i!==this.target){this.mg.player(i.id()).conquer(t);break}}}}owner(){return this._owner}isActive(){return this.active}}class zt{constructor(t,e){this.player=t,this.unitID=e,this.active=!0}init(t,e){}tick(t){const e=this.player.units().find((t=>t.id()===this.unitID&&t.type()===b.TransportShip));if(!e)return console.warn(`Didn't find outgoing boat with id ${this.unitID}`),void(this.active=!1);e.orderBoatRetreat(),this.active=!1}owner(){return this.player}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Kt{constructor(t,e,i){this.requestor=t,this.recipientID=e,this.emoji=i,this.active=!0}init(t,e){if(this.recipientID!==s&&!t.hasPlayer(this.recipientID))return console.warn(`EmojiExecution: recipient ${this.recipientID} not found`),void(this.active=!1);this.recipient=this.recipientID===s?s:t.player(this.recipientID)}tick(t){const e=$[this.emoji];void 0===e?console.warn(`cannot send emoji ${this.emoji} from ${this.requestor} to ${this.recipient}`):this.requestor.canSendEmoji(this.recipient)?(this.requestor.sendEmoji(this.recipient,e),"üñï"===e&&this.recipient!==s&&this.recipient.type()===A.FakeHuman&&this.recipient.updateRelation(this.requestor,-100)):console.warn(`cannot send emoji from ${this.requestor} to ${this.recipient}`),this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}const Yt=t=>$.indexOf(t),Xt=["üëç","‚õµ","ü§ù","üéØ"].map(Yt),Qt=["ü•±","ü§¶‚Äç‚ôÇÔ∏è"].map(Yt),Jt=["ü•∫","üíÄ"].map(Yt),Zt=["üïäÔ∏è","üëé"].map(Yt),te=["ü§°","üò°"].map(Yt);class ee{constructor(t,e,i,s,r,n){this.random=t,this.game=e,this.player=i,this.triggerRatio=s,this.reserveRatio=r,this.expandRatio=n,this.enemy=null}handleAllianceRequests(){for(const i of this.player.incomingAllianceRequests())t=this.player,e=i,t.relation(e.requestor())<v.Neutral||e.requestor().isTraitor()||!(e.requestor().numTilesOwned()>3*t.numTilesOwned())&&e.requestor().alliances().length>=3?i.reject():i.accept();var t,e}handleAllianceExtensionRequests(){for(const t of this.player.alliances()){if(!t.onlyOneAgreedToExtend())continue;const e=t.other(this.player);(this.player.type()!==A.FakeHuman||this.player.relation(e)!==v.Neutral||this.random.chance(1.5))&&this.game.addExecution(new Ft(this.player,e.id()))}}emoji(t,e){t.type()===A.Human&&this.game.addExecution(new Kt(this.player,t.id(),e))}setNewEnemy(t,e=!1){(null===t||e||this.shouldAttack(t))&&(this.enemy=t,this.enemyUpdated=this.game.ticks())}shouldAttack(t){if(null===this.player)throw new Error("not initialized");if(this.player.isOnSameTeam(t))return!1;const e=this.attackChance(t);return e&&this.player.isAlliedWith(t)?(this.betray(t),!0):e}betray(t){if(null===this.player)throw new Error("not initialized");const e=this.player.allianceWith(t);e&&this.player.breakAlliance(e)}attackChance(t){if(null===this.player)throw new Error("not initialized");return this.player.isAlliedWith(t)?this.shouldDiscourageAttack(t)?this.random.chance(200):this.random.chance(50):!this.shouldDiscourageAttack(t)||this.random.chance(4)}shouldDiscourageAttack(t){if(t.isTraitor())return!1;const{difficulty:e}=this.game.config().gameConfig();return e!==r.Hard&&e!==r.Impossible&&t.type()===A.Human}clearEnemy(){this.enemy=null}forgetOldEnemies(){this.game.ticks()-(this.enemyUpdated??0)>100&&this.clearEnemy()}hasReserveRatioTroops(){const t=this.game.config().maxTroops(this.player);return this.player.troops()/t>=this.reserveRatio}hasTriggerRatioTroops(){const t=this.game.config().maxTroops(this.player);return this.player.troops()/t>=this.triggerRatio}checkIncomingAttacks(){const t=this.player.incomingAttacks();let e,i=0;for(const s of t)s.troops()<=i||(i=s.troops(),e=s.attacker());void 0!==e&&this.setNewEnemy(e,!0)}getNeighborTraitorToAttack(){const t=this.player.neighbors().filter((t=>t.isPlayer()&&t.isTraitor()));return t.length>0?this.random.randElement(t):null}assistAllies(){for(const t of this.player.allies())if(0!==t.targets().length)if(this.player.relation(t)<v.Friendly)this.emoji(t,this.random.randElement(Qt));else for(const e of t.targets())if(e!==this.player){if(!this.player.isAlliedWith(e))return this.player.updateRelation(t,-20),this.setNewEnemy(e),void this.emoji(t,this.random.randElement(Xt));this.emoji(t,this.random.randElement(Zt))}else this.emoji(t,this.random.randElement(Jt))}selectEnemy(t){if(null===this.enemy){if(!this.hasReserveRatioTroops())return null;if(!this.hasTriggerRatioTroops()&&!this.random.chance(10))return null;const e=this.player.neighbors().filter((t=>t.isPlayer()&&t.type()===A.Bot));if(e.length>0){const t=t=>t.troops()/t.numTilesOwned();let i,s=1/0;for(const r of e){const e=t(r);e<s&&(s=e,i=r)}void 0!==i&&this.setNewEnemy(i)}if(null===this.enemy&&this.checkIncomingAttacks(),null===this.enemy&&this.random.chance(2)){const t=this.player.allRelationsSorted()[0];void 0!==t&&t.relation===v.Hostile&&this.setNewEnemy(t.player)}null===this.enemy&&t.length>0&&this.setNewEnemy(t[0]),null===this.enemy&&t.length>0&&this.setNewEnemy(this.random.randElement(t))}return this.enemySanityCheck()}selectRandomEnemy(){if(null===this.enemy){if(!this.hasTriggerRatioTroops())return null;const t=this.player.neighbors();for(const e of this.random.shuffleArray(t))e.isPlayer()&&(this.player.isFriendly(e)||e.type()===A.FakeHuman&&this.random.chance(2)||this.setNewEnemy(e));if(null===this.enemy&&this.checkIncomingAttacks(),null===this.enemy){const t=this.getNeighborTraitorToAttack();null!==t&&!this.player.isFriendly(t)&&this.random.chance(3)&&this.setNewEnemy(t)}}return this.enemySanityCheck()}enemySanityCheck(){return this.enemy&&this.player.isFriendly(this.enemy)&&this.clearEnemy(),this.enemy}forceSendAttack(t){this.game.addExecution(new Vt(this.player.troops()/2,this.player,t.isPlayer()?t.id():this.game.terraNullius().id()))}sendAttack(t){if(t.isPlayer()&&this.player.isFriendly(t))return;const e=this.game.config().maxTroops(this.player)*(t.isPlayer()?this.reserveRatio:this.expandRatio),i=this.player.troops()-e;i<1||this.game.addExecution(new Vt(i,this.player,t.isPlayer()?t.id():this.game.terraNullius().id()))}}class ie{constructor(t){this.bot=t,this.active=!0,this.neighborsTerraNullius=!0,this.behavior=null,this.random=new J(j(t.id())),this.attackRate=this.random.nextInt(40,80),this.attackTick=this.random.nextInt(0,this.attackRate),this.triggerRatio=this.random.nextInt(50,60)/100,this.reserveRatio=this.random.nextInt(30,40)/100,this.expandRatio=this.random.nextInt(10,20)/100}activeDuringSpawnPhase(){return!1}init(t){this.mg=t}tick(t){if(t%this.attackRate===this.attackTick)if(this.bot.isAlive()){if(null===this.behavior)return this.behavior=new ee(this.random,this.mg,this.bot,this.triggerRatio,this.reserveRatio,this.expandRatio),void this.behavior.sendAttack(this.mg.terraNullius());this.behavior.handleAllianceRequests(),this.behavior.handleAllianceExtensionRequests(),this.maybeAttack()}else this.active=!1}maybeAttack(){if(null===this.behavior)throw new Error("not initialized");const t=this.behavior.getNeighborTraitorToAttack();if(null!==t){const e=this.bot.isFriendly(t)?6:3;if(this.random.chance(e)){const e=this.bot.allianceWith(t);return null!==e&&this.bot.breakAlliance(e),void this.behavior.sendAttack(t)}}if(this.neighborsTerraNullius){if(this.bot.sharesBorderWith(this.mg.terraNullius()))return void this.behavior.sendAttack(this.mg.terraNullius());this.neighborsTerraNullius=!1}this.behavior.forgetOldEnemies();const e=this.behavior.selectRandomEnemy();e&&this.bot.sharesBorderWith(e)&&this.behavior.sendAttack(e)}isActive(){return this.active}}class se{constructor(t){this.player=t,this.ticksPerClusterCalc=20,this.lastCalc=0,this.active=!0}activeDuringSpawnPhase(){return!1}init(t,e){this.mg=t,this.config=t.config(),this.lastCalc=e+j(this.player.name())%this.ticksPerClusterCalc}tick(t){this.player.decayRelations();for(const t of this.player.units()){if(!t.info().territoryBound)continue;const e=this.mg.owner(t.tile());if(!e?.isPlayer()){t.delete();continue}if(e===this.player)continue;const i=this.mg.player(e.id());t.type()===b.DefensePost?(t.decreaseLevel(i),t.isActive()&&i.captureUnit(t)):i.captureUnit(t)}if(!this.player.isAlive()){const e=this.player.gold();return this.player.removeGold(e),this.player.units().forEach((t=>{t.type()!==b.AtomBomb&&t.type()!==b.HydrogenBomb&&t.type()!==b.MIRVWarhead&&t.type()!==b.MIRV&&t.delete()})),this.active=!1,void this.mg.stats().playerKilled(this.player,t)}const e=this.config.troopIncreaseRate(this.player);this.player.addTroops(e);const i=this.config.goldAdditionRate(this.player);this.player.addGold(i),this.mg.stats().goldWork(this.player,i);const s=Array.from(this.player.alliances());for(const t of s)t.expiresAt()<=this.mg.ticks()&&t.expire();const r=this.player.getEmbargoes();for(const t of r)t.isTemporary&&this.mg.ticks()-t.createdAt>this.mg.config().temporaryEmbargoDuration()&&this.player.stopEmbargo(t.target);if(t-this.lastCalc>this.ticksPerClusterCalc&&this.player.lastTileChange()>this.lastCalc){this.lastCalc=t;const e=performance.now();this.removeClusters();const i=performance.now();i-e>1e3&&console.log(`player ${this.player.name()}, took ${i-e}ms`)}}removeClusters(){const t=this.calculateClusters();t.sort(((t,e)=>e.size-t.size));const e=t.shift();if(void 0===e)throw new Error("No clusters");this.player.largestClusterBoundingBox=N(this.mg,e);const i=this.surroundedBySamePlayer(e);i&&!this.player.isFriendly(i)&&this.removeCluster(e);for(const e of t)this.isSurrounded(e)&&this.removeCluster(e)}surroundedBySamePlayer(t){const e=new Set;for(const i of t){const t=this.mg.isOceanShore(i);if(!this.mg.isOceanShore(i)||t){if(t||this.mg.isOnEdgeOfMap(i)||this.mg.neighbors(i).some((t=>!this.mg?.hasOwner(t))))return!1;if(this.mg.neighbors(i).filter((t=>this.mg?.ownerID(t)!==this.player?.smallID())).forEach((t=>this.mg&&e.add(this.mg.ownerID(t)))),1!==e.size)return!1}}if(1!==e.size)return!1;const i=this.mg.playerBySmallID(Array.from(e)[0]);return!!O(N(this.mg,i.borderTiles()),N(this.mg,t))&&i}isSurrounded(t){const e=new Set;for(const i of t){if(this.mg.isShore(i)||this.mg.isOnEdgeOfMap(i))return!1;this.mg.neighbors(i).filter((t=>this.mg?.owner(t).isPlayer()&&this.mg?.ownerID(t)!==this.player?.smallID())).forEach((t=>e.add(t)))}return 0!==e.size&&O(N(this.mg,e),N(this.mg,t))}removeCluster(t){if(Array.from(t).some((t=>this.mg?.ownerID(t)!==this.player?.smallID())))return;const e=this.getCapturingPlayer(t);if(null===e)return;const i=t.values().next().value;if(!i)return;const s=this.mg.bfs(i,((t,e)=>this.mg?.ownerID(e)===this.player?.smallID()));this.player.numTilesOwned()===s.size&&this.mg.conquerPlayer(e,this.player);for(const t of s)e.conquer(t)}getCapturingPlayer(t){const e=new Map;for(const i of t)for(const t of this.mg.neighbors(i)){const i=this.mg.owner(t);i.isPlayer()&&i!==this.player&&!i.isFriendly(this.player)&&e.set(i,(e.get(i)??0)+1)}if(0===e.size)return null;let i=null,s=0;for(const[t]of e)for(const e of t.outgoingAttacks())e.target()===this.player&&e.troops()>s&&(s=e.troops(),i=t);return null!==i?i:function(t){let e=null,i=0;for(const[s,r]of t)r>i&&(i=r,e=s);return e}(e)}calculateClusters(){const t=new Set,e=this.player.borderTiles(),i=[];for(const s of e){if(t.has(s))continue;const r=new Set,n=[s];for(t.add(s);n.length>0;){const i=n.shift();if(void 0===i)throw new Error("curr is undefined");r.add(i);const s=this.mg.neighborsWithDiag(i);for(const i of s)e.has(i)&&!t.has(i)&&(n.push(i),t.add(i))}i.push(r)}return i}owner(){if(null===this.player)throw new Error("Not initialized");return this.player}isActive(){return this.active}}class re{constructor(t,e,i,s){if(this.numLandTiles_=s,this._numTilesWithFallout=0,i.length!==t*e)throw new Error(`Terrain data length ${i.length} doesn't match dimensions ${t}x${e}`);this.width_=t,this.height_=e,this.terrain=i,this.state=new Uint16Array(t*e);let r=0;this.refToX=new Array(t*e),this.refToY=new Array(t*e),this.yToRef=new Array(e);for(let i=0;i<e;i++){this.yToRef[i]=r;for(let e=0;e<t;e++)this.refToX[r]=e,this.refToY[r]=i,r++}}numTilesWithFallout(){return this._numTilesWithFallout}ref(t,e){if(!this.isValidCoord(t,e))throw new Error(`Invalid coordinates: ${t},${e}`);return this.yToRef[e]+t}isValidRef(t){return t>=0&&t<this.refToX.length}x(t){return this.refToX[t]}y(t){return this.refToY[t]}cell(t){return new D(this.x(t),this.y(t))}width(){return this.width_}height(){return this.height_}numLandTiles(){return this.numLandTiles_}isValidCoord(t,e){return t>=0&&t<this.width_&&e>=0&&e<this.height_}isLand(t){return Boolean(this.terrain[t]&1<<re.IS_LAND_BIT)}isOceanShore(t){return this.isLand(t)&&this.neighbors(t).some((t=>this.isOcean(t)))}isOcean(t){return Boolean(this.terrain[t]&1<<re.OCEAN_BIT)}isShoreline(t){return Boolean(this.terrain[t]&1<<re.SHORELINE_BIT)}magnitude(t){return this.terrain[t]&re.MAGNITUDE_MASK}ownerID(t){return this.state[t]&re.PLAYER_ID_MASK}hasOwner(t){return 0!==this.ownerID(t)}setOwnerID(t,e){if(e>re.PLAYER_ID_MASK)throw new Error(`Player ID ${e} exceeds maximum value ${re.PLAYER_ID_MASK}`);this.state[t]=this.state[t]&~re.PLAYER_ID_MASK|e}hasFallout(t){return Boolean(this.state[t]&1<<re.FALLOUT_BIT)}setFallout(t,e){const i=this.hasFallout(t);e?i||(this._numTilesWithFallout++,this.state[t]|=1<<re.FALLOUT_BIT):i&&(this._numTilesWithFallout--,this.state[t]&=~(1<<re.FALLOUT_BIT))}isOnEdgeOfMap(t){const e=this.x(t),i=this.y(t);return 0===e||e===this.width()-1||0===i||i===this.height()-1}isBorder(t){return this.neighbors(t).some((e=>this.ownerID(e)!==this.ownerID(t)))}hasDefenseBonus(t){return Boolean(this.state[t]&1<<re.DEFENSE_BONUS_BIT)}setDefenseBonus(t,e){e?this.state[t]|=1<<re.DEFENSE_BONUS_BIT:this.state[t]&=~(1<<re.DEFENSE_BONUS_BIT)}isWater(t){return!this.isLand(t)}isLake(t){return!this.isLand(t)&&!this.isOcean(t)}isShore(t){return this.isLand(t)&&this.isShoreline(t)}cost(t){return this.magnitude(t)<10?2:1}terrainType(t){if(this.isLand(t)){const e=this.magnitude(t);return e<10?_.Plains:e<20?_.Highland:_.Mountain}return this.isOcean(t)?_.Ocean:_.Lake}neighbors(t){const e=[],i=this.width_,s=this.refToX[t];return t>=i&&e.push(t-i),t<(this.height_-1)*i&&e.push(t+i),0!==s&&e.push(t-1),s!==i-1&&e.push(t+1),e}forEachTile(t){for(let e=0;e<this.width_*this.height_;e++)t(e)}manhattanDist(t,e){return Math.abs(this.x(t)-this.x(e))+Math.abs(this.y(t)-this.y(e))}euclideanDistSquared(t,e){const i=this.x(t)-this.x(e),s=this.y(t)-this.y(e);return i*i+s*s}bfs(t,e){const i=new Set,s=[];for(e(this,t)&&(i.add(t),s.push(t));s.length>0;){const t=s.pop();if(void 0!==t)for(const r of this.neighbors(t))!i.has(r)&&e(this,r)&&(i.add(r),s.push(r))}return i}toTileUpdate(t){return BigInt(t)<<16n|BigInt(this.state[t])}updateTile(t){const e=Number(t>>16n),i=Number(0xffffn&t),s=this.hasFallout(e);this.state[e]=i;const r=this.hasFallout(e);return s&&!r&&this._numTilesWithFallout--,!s&&r&&this._numTilesWithFallout++,e}}function ne(t,e,i=!1){const s=e*e;return i?(e,i)=>{const r=e.x(t)-.5,n=e.y(t)-.5,a=e.x(i)-r,o=e.y(i)-n;return a*a+o*o<=s}:(e,i)=>e.euclideanDistSquared(t,i)<=s}function ae(t,e,i=!1){return i?(i,s)=>{const r=i.x(t)-.5,n=i.y(t)-.5;return Math.abs(i.x(s)-r)+Math.abs(i.y(s)-n)<=e}:(i,s)=>i.manhattanDist(t,s)<=e}function oe(t,e){return(i,s)=>t(i,s)&&e(i,s)}function he(t,e,i){let s=1/0,r=null;for(const n of e){const e=t.manhattanDist(n,i);e<s&&(s=e,r=n)}return[r,s]}function le(t,e,i){const s=Array.from(e).sort(((e,i)=>t.x(e)-t.x(i))),r=Array.from(i).sort(((e,i)=>t.x(e)-t.x(i)));if(0===s.length||0===r.length)return null;let n=0,a=0,o=1/0,h={x:s[0],y:r[0]};for(;n<s.length&&a<r.length;){const e=s[n],i=r[a],l=Math.abs(t.x(e)-t.x(i))+Math.abs(t.y(e)-t.y(i));l<o&&(o=l,h={x:e,y:i}),n===s.length-1?a++:a===r.length-1||t.x(e)<t.x(i)?n++:a++}return h}re.IS_LAND_BIT=7,re.SHORELINE_BIT=6,re.OCEAN_BIT=5,re.MAGNITUDE_MASK=31,re.PLAYER_ID_MASK=4095,re.FALLOUT_BIT=13,re.DEFENSE_BONUS_BIT=14;class ce{constructor(t,e){this.playerInfo=t,this.tile=e,this.active=!0}init(t,e){this.mg=t}tick(t){if(this.active=!1,!this.mg.isValidRef(this.tile))return void console.warn(`SpawnExecution: tile ${this.tile} not valid`);if(!this.mg.inSpawnPhase())return void(this.active=!1);let e=null;var i,s;e=this.mg.hasPlayer(this.playerInfo.id)?this.mg.player(this.playerInfo.id):this.mg.addPlayer(this.playerInfo),e.tiles().forEach((t=>e.relinquish(t))),(i=this.mg,s=this.tile,Array.from(i.bfs(s,ne(s,4,!0))).filter((t=>!i.hasOwner(t)&&i.isLand(t)))).forEach((t=>{e.conquer(t)})),e.hasSpawned()||(this.mg.addExecution(new se(e)),e.type()===A.Bot&&this.mg.addExecution(new ie(e))),e.setHasSpawned(!0)}isActive(){return this.active}activeDuringSpawnPhase(){return!0}}const ue=["Akkadian","Babylonian","Sumerian","Hittite","Phoenician","Canaanite","Minoan","Mycenaean","Etruscan","Scythian","Thracian","Dacian","Illyrian","Median","Chaldean","Roman","Greek","Byzantine","Persian","Parthian","Seleucid","Ptolemaic","Palmyrene","Macedonian","Carthaginian","Ming","Tang","Song","Yuan","Mauryan","Kushan","Rajput","Mughal","Satavahana","Vijayanagara","Egyptian","Nubian","Kushite","Aksumite","Ethiopian","Songhai","Malian","Ghanaian","Benin","Ashanti","Zulu","Tuareg","Berber","Kanem-Bornu","Buganda","Mossi","Swahili","Somali","Wolof","Umayyad","Abbasid","Ayyubid","Fatimid","Mamluk","Seljuk","Safavid","Ottoman","Almoravid","Almohad","Rashidun","Ziyarid","Frankish","Visigothic","Ostrogothic","Viking","Norman","Saxon","Anglo-Saxon","Celtic","Gaulish","Carolingian","Merovingian","Capetian","Plantagenet","Tudor","Stuart","Habsburg","Romanov","Lancaster","York","Bourbon","Napoleonic","British","French","Spanish","Portuguese","Dutch","Russian","German","Italian","Swedish","Norwegian","Danish","Polish","Hungarian","Austrian","Swiss","Czech","Slovak","Serbian","Croatian","Bosnian","Montenegrin","Bulgarian","Romanian","Apache","Sioux","Cherokee","Navajo","Iroquois","Inuit","Arawak","Carib","Taino","Aztec","Mayan","Incan","Mapuche","Guarani","Tupi","Yanomami","Zuni","Hopi","Kiowa","Comanche","Shoshone","Japanese","Ryukyu","Ainu","Cham","Khmer","Thai","Vietnamese","Burmese","Balinese","Malay","Filipino","Mongolian","Korean","Tibetan","Manchu","Uyghur","Hmong","Karen","Pyu","Hawaiian","Fijian","Tongan","Samoan","Maori","Micronesian","Hebrew","Armenian","Circassian","Georgian","Phoenician","Chaldean","Kurdish","Turkic","Kazakh","Uzbek","Kyrgyz","Tajik","Uighur","Pashtun","Baloch","Afghan","Persian","Kenyan","Ugandan","Bhutanese","Latin","Moldovan","Militant","Spartan"],de=["Empire","Dynasty","Kingdom","Queendom","Sultanate","Confederation","Union","Republic","Caliphate","Dominion","Realm","State","Federation","Territory","Commonwealth","League","Duchy","Province","Protectorate","Colony","Mandate","Free State","Canton","Region","Nation","Assembly","Hierarchy","Archduchy","Grand Duchy","Metropolis","Cluster","Alliance","Tribunal","Council","Confederacy","Order","Regime","Dominion","Syndicate","Guild","Corporation","Patriarchy","Matriarchy","Legion","Horde","Clan","Brotherhood","Sisterhood","Ascendancy","Supremacy","Province","Tribe","Dominion","Assembly","Republics","Army","Dictatorship","Country","Oligarchy","Monkdom","Throng","Host","Area","District","Fief","Wilderness","Settlement","Parliament","Anarchy","Democracy","Autocracy"];class ge{constructor(t,e){this.gs=t,this.bots=[],this.random=new J(j(e))}spawnBots(t){let e=0;for(;this.bots.length<t;){if(e>1e4)return console.log("too many retries while spawning bots, giving up"),this.bots;const t=this.randomBotName(),i=this.spawnBot(t);null!==i?this.bots.push(i):e++}return this.bots}spawnBot(t){const e=this.randTile();if(!this.gs.isLand(e))return null;for(const t of this.bots)if(this.gs.manhattanDist(t.tile,e)<30)return null;return new ce(new x(t,A.Bot,null,this.random.nextID()),e)}randomBotName(){const t=this.random.nextInt(0,ue.length),e=this.random.nextInt(0,de.length);return`${ue[t]} ${de[e]}`}randTile(){return this.gs.ref(this.random.nextInt(0,this.gs.width()),this.random.nextInt(0,this.gs.height()))}}var pe,me,fe;!function(t){t[t.Tile=0]="Tile",t[t.Unit=1]="Unit",t[t.Player=2]="Player",t[t.DisplayEvent=3]="DisplayEvent",t[t.DisplayChatEvent=4]="DisplayChatEvent",t[t.AllianceRequest=5]="AllianceRequest",t[t.AllianceRequestReply=6]="AllianceRequestReply",t[t.BrokeAlliance=7]="BrokeAlliance",t[t.AllianceExpired=8]="AllianceExpired",t[t.AllianceExtension=9]="AllianceExtension",t[t.TargetPlayer=10]="TargetPlayer",t[t.Emoji=11]="Emoji",t[t.Win=12]="Win",t[t.Hash=13]="Hash",t[t.UnitIncoming=14]="UnitIncoming",t[t.BonusEvent=15]="BonusEvent",t[t.RailroadEvent=16]="RailroadEvent",t[t.ConquestEvent=17]="ConquestEvent",t[t.EmbargoEvent=18]="EmbargoEvent"}(pe||(pe={})),function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.TOP_LEFT=2]="TOP_LEFT",t[t.TOP_RIGHT=3]="TOP_RIGHT",t[t.BOTTOM_LEFT=4]="BOTTOM_LEFT",t[t.BOTTOM_RIGHT=5]="BOTTOM_RIGHT"}(me||(me={}));class ye{onStop(t,e,i){const s=e.unit.owner(),r=i.owner(),n=t.config().trainGold(_e(r,s));r!==s&&s.addGold(n,e.tile()),r.addGold(n,e.tile())}}class we{constructor(t){this.random=t}onStop(t,e,i){const s=e.unit.owner(),r=i.owner(),n=t.config().trainGold(_e(r,s));r.addGold(n,e.tile()),r!==s&&s.addGold(n,e.tile())}}class be{onStop(t,e,i){}}class Te{constructor(t,e){var i;this.mg=t,this.unit=e,this.stopHandlers={},this.railroads=new Set,this.stopHandlers=(i=new J(t.ticks()),{[b.City]:new ye,[b.Port]:new we(i),[b.Factory]:new be})}tradeAvailable(t){const e=this.unit.owner();return t===e||e.canTrade(t)}clearRailroads(){this.railroads.clear()}addRailroad(t){this.railroads.add(t)}removeNeighboringRails(t){const e=[...this.railroads].find((e=>e.from===t||e.to===t));if(e){const t=e.tiles.map((t=>({tile:t,railType:me.VERTICAL})));this.mg.addUpdate({type:pe.RailroadEvent,isActive:!1,railTiles:t}),this.railroads.delete(e)}}neighbors(){const t=[];for(const e of this.railroads)e.from!==this?t.push(e.from):t.push(e.to);return t}tile(){return this.unit.tile()}isActive(){return this.unit.isActive()}getRailroads(){return this.railroads}setCluster(t){this.cluster=t}getCluster(){return this.cluster}onTrainStop(t){const e=this.unit.type(),i=this.stopHandlers[e];i&&i.onStop(this.mg,this,t)}}class Me{constructor(t){this.game=t}neighbors(t){return t.neighbors()}cost(t){return 1}position(t){return{x:this.game.x(t.tile()),y:this.game.y(t.tile())}}isTraversable(t,e){return!0}}class ve{constructor(){this.stations=new Set}has(t){return this.stations.has(t)}addStation(t){this.stations.add(t),t.setCluster(this)}removeStation(t){this.stations.delete(t)}addStations(t){for(const e of t)this.addStation(e)}merge(t){for(const e of t.stations)this.addStation(e)}availableForTrade(t){const e=new Set;for(const i of this.stations)i.unit.type()!==b.City&&i.unit.type()!==b.Port||!i.tradeAvailable(t)||e.add(i);return e}size(){return this.stations.size}clear(){this.stations.clear()}}function _e(t,e){return t===e?"self":t.isOnSameTeam(e)?"team":t.isAlliedWith(e)?"ally":"other"}class Ae{constructor(t,e,i){this.from=t,this.to=e,this.tiles=i}delete(t){const e=this.tiles.map((t=>({tile:t,railType:me.VERTICAL})));t.addUpdate({type:pe.RailroadEvent,isActive:!1,railTiles:e}),this.from.getRailroads().delete(this),this.to.getRailroads().delete(this)}}function Se(t,e){for(const i of t.getRailroads()){if(i.from===e)return new ke(i,!1);if(i.to===e)return new ke(i,!0)}return null}class ke{constructor(t,e){this.railroad=t,this.forward=e,this.tiles=[],this.tiles=this.forward?this.railroad.tiles:[...this.railroad.tiles].reverse()}getTiles(){return this.tiles}getStart(){return this.forward?this.railroad.from:this.railroad.to}getEnd(){return this.forward?this.railroad.to:this.railroad.from}}class Ee{constructor(t,e,i,s,r){this.railNetwork=t,this.player=e,this.source=i,this.destination=s,this.numCars=r,this.active=!0,this.mg=null,this.train=null,this.cars=[],this.hasCargo=!1,this.currentTile=0,this.spacing=2,this.usedTiles=[],this.stations=[],this.currentRailroad=null,this.speed=2}owner(){return this.player}init(t,e){this.mg=t;const i=this.railNetwork.findStationsPath(this.source,this.destination);if(!i||i.length<=1)return void(this.active=!1);this.stations=i;const s=Se(this.stations[0],this.stations[1]);if(!s)return void(this.active=!1);this.currentRailroad=s;const r=this.player.canBuild(b.Train,this.stations[0].tile());if(!1===r)return console.warn("cannot build train"),void(this.active=!1);this.train=this.createTrainUnits(r)}tick(t){if(null===this.train)throw new Error("Not initialized");if(!this.train.isActive()||!this.activeSourceOrDestination())return void this.deleteTrain();const e=this.getNextTile();e?this.updateCarsPositions(e):(this.targetReached(),this.deleteTrain())}loadCargo(){if(!this.hasCargo&&null!==this.train){this.hasCargo=!0;for(let t=1;t<this.cars.length;t++)this.cars[t].setLoaded(!0)}}targetReached(){null!==this.train&&(this.train.setReachedTarget(),this.cars.forEach((t=>{t.setReachedTarget()})))}createTrainUnits(t){const e=this.player.buildUnit(b.Train,t,{targetUnit:this.destination.unit,trainType:T.Engine});this.cars.push(this.player.buildUnit(b.Train,t,{targetUnit:this.destination.unit,trainType:T.Engine}));for(let e=0;e<this.numCars;e++)this.cars.push(this.player.buildUnit(b.Train,t,{trainType:T.Carriage,loaded:this.hasCargo}));return e}deleteTrain(){this.active=!1,this.train?.isActive()&&this.train.delete(!1);for(const t of this.cars)t.isActive()&&t.delete(!1)}activeSourceOrDestination(){return this.stations.length>1&&this.stations[1].isActive()&&this.stations[0].isActive()}saveTraversedTiles(t,e){if(!this.currentRailroad)return;let i=t;for(let t=0;t<e&&i<this.currentRailroad.getTiles().length;t++)this.saveTile(this.currentRailroad.getTiles()[i]),i+=1}saveTile(t){this.usedTiles.push(t),this.usedTiles.length>this.cars.length*this.spacing+3&&this.usedTiles.shift()}updateCarsPositions(t){if(this.cars.length>0)for(let t=this.cars.length-1;t>=0;--t){const e=(t+1)*this.spacing+2;this.usedTiles.length>e&&this.cars[t].move(this.usedTiles[e])}null!==this.train&&this.train.move(t)}nextStation(){if(this.stations.length>2){this.stations.shift();const t=Se(this.stations[0],this.stations[1]);if(t)return this.currentRailroad=t,!0}return!1}canTradeWithDestination(){return this.stations.length>1&&this.stations[1].tradeAvailable(this.player)}getNextTile(){if(null===this.currentRailroad||!this.canTradeWithDestination())return null;this.saveTraversedTiles(this.currentTile,this.speed),this.currentTile=this.currentTile+this.speed;const t=this.currentTile-this.currentRailroad.getTiles().length;if(t>=0){if(this.stationReached(),!this.nextStation())return null;this.currentTile=t,this.saveTraversedTiles(0,t)}return this.currentRailroad.getTiles()[this.currentTile]}stationReached(){if(null===this.mg||null===this.player)throw new Error("Not initialized");this.stations[1].onTrainStop(this)}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Ie{constructor(t,e){this.unit=t,this.spawnTrains=e,this.active=!0,this.station=null,this.numCars=5,this.lastSpawnTick=0,this.ticksCooldown=10,this.unit.setTrainStation(!0)}isActive(){return this.active}init(t,e){this.mg=t,this.spawnTrains&&(this.random=new J(t.ticks()))}tick(t){if(void 0===this.mg)throw new Error("Not initialized");this.isActive()&&void 0!==this.unit&&(null===this.station&&(this.station=new Te(this.mg,this.unit),this.mg.railNetwork().connectStation(this.station)),this.station.isActive()?this.spawnTrain(this.station,t):this.active=!1)}shouldSpawnTrain(){const t=this.mg.config().trainSpawnRate(this.unit.owner().unitCount(b.Factory));for(let e=0;e<this.unit.level();e++)if(this.random.chance(t))return!0;return!1}spawnTrain(t,e){if(void 0===this.mg)throw new Error("Not initialized");if(!this.spawnTrains)return;if(void 0===this.random)throw new Error("Not initialized");if(e<this.lastSpawnTick+this.ticksCooldown)return;const i=t.getCluster();if(null===i)return;const s=i.availableForTrade(this.unit.owner());if(0===s.size)return;if(!this.shouldSpawnTrain())return;const r=this.random.randFromSet(s);r!==t&&(this.mg.addExecution(new Ee(this.mg.railNetwork(),this.unit.owner(),t,r,this.numCars)),this.lastSpawnTick=e)}activeDuringSpawnPhase(){return!1}}class De{constructor(t,e){this.player=t,this.tile=e,this.city=null,this.active=!0}init(t,e){this.mg=t}tick(t){if(null===this.city){const t=this.player.canBuild(b.City,this.tile);if(!1===t)return console.warn("cannot build city"),void(this.active=!1);this.city=this.player.buildUnit(b.City,t,{}),this.createStation()}this.city.isActive()?this.player!==this.city.owner()&&(this.player=this.city.owner()):this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}createStation(){null!==this.city&&this.mg.hasUnitNearby(this.city.tile(),this.mg.config().trainStationMaxRange(),b.Factory)&&this.mg.addExecution(new Ie(this.city))}}class xe{constructor(t,e,i,s){this.p0=t,this.p1=e,this.p2=i,this.p3=s}getPointAt(t){const e=1-t,i=e*e,s=i*e,r=t*t,n=r*t;return{x:s*this.p0.x+3*i*t*this.p1.x+3*e*r*this.p2.x+n*this.p3.x,y:s*this.p0.y+3*i*t*this.p1.y+3*e*r*this.p2.y+n*this.p3.y}}}class Ce extends xe{constructor(t,e,i,s,r){super(t,e,i,s),this.totalDistance=0,this.cachedPoints=[],this.currentIndex=0,this.computeAllPoints(r,.002)}getAllPoints(){return this.cachedPoints}increment(t){for(this.totalDistance+=t;this.currentIndex<this.cachedPoints.length-1&&this.getDistanceUpToIndex(this.currentIndex+1)<this.totalDistance;)this.currentIndex++;return this.currentIndex>=this.cachedPoints.length-1?null:this.cachedPoints[this.currentIndex]}getCurrentIndex(){return this.currentIndex}computeAllPoints(t,e){this.cachedPoints=[],this.totalDistance=0,this.currentIndex=0;let i=0,s=this.getPointAt(i);this.cachedPoints.push(s);let r=0;for(;i<1;){i=Math.min(i+e,1);const n=this.getPointAt(i),a=n.x-s.x,o=n.y-s.y;r+=Math.sqrt(a*a+o*o),r>=t&&(this.cachedPoints.push(n),r=0),s=n}const n=this.getPointAt(1);0!==this.cachedPoints.length&&n.x===this.cachedPoints[this.cachedPoints.length-1].x&&n.y===this.cachedPoints[this.cachedPoints.length-1].y||this.cachedPoints.push(n)}getDistanceUpToIndex(t){let e=0;for(let i=1;i<=t;i++){const t=this.cachedPoints[i-1],s=this.cachedPoints[i],r=s.x-t.x,n=s.y-t.y;e+=Math.sqrt(r*r+n*n)}return e}}!function(t){t[t.NextTile=0]="NextTile",t[t.Pending=1]="Pending",t[t.Completed=2]="Completed",t[t.PathNotFound=3]="PathNotFound"}(fe||(fe={}));var Pe=i(71451),Re=i.n(Pe);class je{constructor(t,e,i,s,r,n=0){this.dst=e,this.iterations=i,this.maxTries=s,this.graph=r,this.directionChangePenalty=n,this.fwdCameFrom=new Map,this.bwdCameFrom=new Map,this.fwdGScore=new Map,this.bwdGScore=new Map,this.meetingPoint=null,this.completed=!1,this.fwdOpenSet=new(Re())(((t,e)=>t.fScore<e.fScore)),this.bwdOpenSet=new(Re())(((t,e)=>t.fScore<e.fScore)),this.sources=Array.isArray(t)?t:[t],this.closestSource=this.findClosestSource(e),this.sources.forEach((t=>{this.fwdGScore.set(t,0),this.fwdOpenSet.add({tile:t,fScore:this.heuristic(t,e)})})),this.bwdGScore.set(e,0),this.bwdOpenSet.add({tile:e,fScore:this.heuristic(e,this.findClosestSource(e))})}findClosestSource(t){return this.sources.reduce(((e,i)=>this.heuristic(t,i)<this.heuristic(t,e)?i:e))}compute(){if(this.completed)return fe.Completed;this.maxTries-=1;let t=this.iterations;for(;!this.fwdOpenSet.isEmpty()&&!this.bwdOpenSet.isEmpty();){if(t--,t<=0)return this.maxTries<=0?fe.PathNotFound:fe.Pending;const e=this.fwdOpenSet.poll().tile;if(this.bwdGScore.has(e))return this.meetingPoint=e,this.completed=!0,fe.Completed;this.expandNode(e,!0);const i=this.bwdOpenSet.poll().tile;if(this.fwdGScore.has(i))return this.meetingPoint=i,this.completed=!0,fe.Completed;this.expandNode(i,!1)}return this.completed?fe.Completed:fe.PathNotFound}expandNode(t,e){for(const i of this.graph.neighbors(t)){if(i!==(e?this.dst:this.closestSource)&&!this.graph.isTraversable(t,i))continue;const s=e?this.fwdGScore:this.bwdGScore,r=e?this.fwdOpenSet:this.bwdOpenSet,n=e?this.fwdCameFrom:this.bwdCameFrom,a=s.get(t)+this.graph.cost(i);let o=0;if(this.directionChangePenalty>0){const e=n.get(t);e&&this.getDirection(e,t)!==this.getDirection(t,i)&&(o=this.directionChangePenalty)}const h=a+o;if(!s.has(i)||h<s.get(i)){n.set(i,t),s.set(i,h);const a=h+this.heuristic(i,e?this.dst:this.closestSource);r.add({tile:i,fScore:a})}}}heuristic(t,e){const i=this.graph.position(t),s=this.graph.position(e);return 2*(Math.abs(i.x-s.x)+Math.abs(i.y-s.y))}getDirection(t,e){const i=this.graph.position(t),s=this.graph.position(e),r=s.x-i.x,n=s.y-i.y;return`${Math.sign(r)},${Math.sign(n)}`}reconstructPath(){if(!this.meetingPoint)return[];const t=[this.meetingPoint];let e=this.meetingPoint;for(;this.fwdCameFrom.has(e);)e=this.fwdCameFrom.get(e),t.unshift(e);for(e=this.meetingPoint;this.bwdCameFrom.has(e);)e=this.bwdCameFrom.get(e),t.push(e);return t}}class Ne{constructor(t,e){this.gameMap=t,this.waterPath=e,this.waterPenalty=3}neighbors(t){return this.gameMap.neighbors(t)}cost(t){let e=this.gameMap.cost(t);return!this.waterPath&&this.gameMap.isWater(t)&&(e+=this.waterPenalty),e}position(t){return{x:this.gameMap.x(t),y:this.gameMap.y(t)}}isTraversable(t,e){const i=this.gameMap.isWater(e);if(this.waterPath)return i;const s=this.gameMap.isShoreline(t),r=this.gameMap.isShoreline(e);return!i||s||r}}class Be{constructor(t,e,i,s,r,n,a=!0,o=0){this.gameMap=t,this.miniMap=e,this.src=i,this.dst=s;const h=(Array.isArray(i)?i:[i]).map((e=>this.miniMap.ref(Math.floor(t.x(e)/2),Math.floor(t.y(e)/2)))),l=this.miniMap.ref(Math.floor(t.x(s)/2),Math.floor(t.y(s)/2));this.aStar=new je(h,l,r,n,new Ne(e,a),o)}compute(){return this.aStar.compute()}reconstructPath(){let t;Array.isArray(this.src)||(t=new D(this.gameMap.x(this.src),this.gameMap.y(this.src)));const e=new D(this.gameMap.x(this.dst),this.gameMap.y(this.dst)),i=function(t,e,i){if(void 0!==i){const e=Oe(t,i);-1===e?t.unshift(i):0!==e&&(t=t.slice(e))}const s=Oe(t,e);return-1===s?t.push(e):s!==t.length-1&&(t=t.slice(0,s+1)),t}(function(t,e=2){const i=t.map((t=>new D(t.x*e,t.y*e))),s=[];for(let t=0;t<i.length-1;t++){const e=i[t],r=i[t+1];s.push(e);const n=r.x-e.x,a=r.y-e.y,o=Math.max(Math.abs(n),Math.abs(a));for(let t=1;t<o;t++)s.push(new D(Math.round(e.x+n*t/o),Math.round(e.y+a*t/o)))}return i.length>0&&s.push(i[i.length-1]),s}(this.aStar.reconstructPath().map((t=>new D(this.miniMap.x(t),this.miniMap.y(t))))),e,t);return i.map((t=>this.gameMap.ref(t.x,t.y)))}}function Oe(t,e){for(let i=0;i<t.length;i++)if(t[i].x===e.x&&t[i].y===e.y)return i;return-1}class Ue{constructor(t){this.mg=t}computeControlPoints(t,e,i=3,s=!0){const r={x:this.mg.x(t),y:this.mg.y(t)},n={x:this.mg.x(e),y:this.mg.y(e)},a=n.x-r.x,o=n.y-r.y,h=Math.sqrt(a*a+o*o),l=s?Math.max(h/3,50):0,c={x:r.x+(n.x-r.x)/4,y:Math.max(r.y+(n.y-r.y)/4-l,0)},u={x:r.x+3*(n.x-r.x)/4,y:Math.max(r.y+3*(n.y-r.y)/4-l,0)};this.curve=new Ce(r,c,u,n,i)}nextTile(t){if(!this.curve)throw new Error("ParabolaPathFinder not initialized");const e=this.curve.increment(t);return!e||this.mg.ref(Math.floor(e.x),Math.floor(e.y))}currentIndex(){return this.curve?this.curve.getCurrentIndex():0}allTiles(){return this.curve?this.curve.getAllPoints().map((t=>this.mg.ref(Math.floor(t.x),Math.floor(t.y)))):[]}}class Fe{constructor(t,e){this.mg=t,this.random=e}nextTile(t,e){const i=this.mg.x(t),s=this.mg.y(t),r=this.mg.x(e),n=this.mg.y(e);if(i===r&&s===n)return!0;let a=i,o=s;const h=Math.floor(1+Math.abs(n-s)/(Math.abs(r-i)+1));return this.random.chance(h)&&i!==r?i<r?a++:i>r&&a--:s<n?o++:s>n&&o--,a===i&&o===s||this.mg.ref(a,o)}}class Le{constructor(t,e){this.game=t,this.newAStar=e,this.curr=null,this.dst=null,this.path=null,this.computeFinished=!0}static Mini(t,e,i=!0,s=20){return new Le(t,((r,n)=>new Be(t.map(),t.miniMap(),r,n,e,s,i)))}nextTile(t,e,i=1){if(null===t)return console.error("curr is null"),{type:fe.PathNotFound};if(null===e)return console.error("dst is null"),{type:fe.PathNotFound};if(this.game.manhattanDist(t,e)<i)return{type:fe.Completed,node:t};if(this.computeFinished){if(this.shouldRecompute(t,e))return this.curr=t,this.dst=e,this.path=null,this.aStar=this.newAStar(t,e),this.computeFinished=!1,this.nextTile(t,e);{const t=this.path?.shift();if(void 0===t)throw new Error("missing tile");return{type:fe.NextTile,node:t}}}switch(this.aStar.compute()){case fe.Completed:return this.computeFinished=!0,this.path=this.aStar.reconstructPath(),this.path.shift(),this.nextTile(t,e);case fe.Pending:return{type:fe.Pending};case fe.PathNotFound:return{type:fe.PathNotFound};default:throw new Error("unexpected compute result")}}shouldRecompute(t,e){if(null===this.path||null===this.curr||null===this.dst)return!0;const i=this.game.manhattanDist(t,e);let s=10;return s=i>50?10:i>25?5:0,this.game.manhattanDist(this.dst,e)>s}}class qe{constructor(t,e,i,s){this.spawn=t,this._owner=e,this.ownerUnit=i,this.target=s,this.active=!0,this.destroyAtTick=-1}init(t,e){this.pathFinder=new Fe(t,new J(t.ticks())),this.mg=t,this.random=new J(t.ticks())}tick(t){if(this.shell??(this.shell=this._owner.buildUnit(b.Shell,this.spawn,{})),this.shell.isActive()){if(!this.target.isActive()||this.target.owner()===this.shell.owner()||-1!==this.destroyAtTick&&this.mg.ticks()>=this.destroyAtTick)return this.shell.delete(!1),void(this.active=!1);-1!==this.destroyAtTick||this.ownerUnit.isActive()||(this.destroyAtTick=this.mg.ticks()+this.mg.config().shellLifetime());for(let t=0;t<3;t++){const t=this.pathFinder.nextTile(this.shell.tile(),this.target.tile());if(!0===t)return this.active=!1,this.target.modifyHealth(-this.effectOnTarget(),this._owner),this.shell.setReachedTarget(),void this.shell.delete(!1);this.shell.move(t)}}else this.active=!1}effectOnTarget(){const{damage:t}=this.mg.config().unitInfo(b.Shell),e=t??250,i=25*(this.random.nextInt(1,6)-1)+200;return Math.round(e/250*i)}getEffectOnTargetForTesting(){return this.effectOnTarget()}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class $e{constructor(t,e){this.player=t,this.tile=e,this.post=null,this.active=!0,this.target=null,this.lastShellAttack=0,this.alreadySentShell=new Set}init(t,e){this.mg=t}shoot(){if(null===this.post)return;if(null===this.target)return;const t=this.mg.config().defensePostShellAttackRate();return this.mg.ticks()-this.lastShellAttack>t&&(this.lastShellAttack=this.mg.ticks(),this.mg.addExecution(new qe(this.post.tile(),this.post.owner(),this.post,this.target)),!this.target.hasHealth())?(this.alreadySentShell.add(this.target),void(this.target=null)):void 0}tick(t){if(null===this.post){const t=this.player.canBuild(b.DefensePost,this.tile);if(!1===t)return console.warn("cannot build Defense Post"),void(this.active=!1);this.post=this.player.buildUnit(b.DefensePost,t,{})}this.post.isActive()?(this.player!==this.post.owner()&&(this.player=this.post.owner()),null===this.target||this.target.isActive()||(this.target=null)):this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class We{constructor(t,e){this.player=t,this.tile=e,this.factory=null,this.active=!0}init(t,e){this.game=t}tick(t){if(!this.factory){const t=this.player.canBuild(b.Factory,this.tile);if(!1===t)return console.warn("cannot build factory"),void(this.active=!1);this.factory=this.player.buildUnit(b.Factory,t,{}),this.createStation()}this.factory.isActive()?this.player!==this.factory.owner()&&(this.player=this.factory.owner()):this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}createStation(){if(null!==this.factory){const t=this.game.nearbyUnits(this.factory.tile(),this.game.config().trainStationMaxRange(),[b.City,b.Port,b.Factory]);this.game.addExecution(new Ie(this.factory,!0));for(const{unit:e}of t)e.hasTrainStation()||this.game.addExecution(new Ie(e))}}}class He{constructor(t,e,i,s,r=-1,n=0){this.nukeType=t,this.player=e,this.dst=i,this.src=s,this.speed=r,this.waitTicks=n,this.active=!0,this.nuke=null}init(t,e){this.mg=t,-1===this.speed&&(this.speed=this.mg.config().defaultNukeSpeed()),this.pathFinder=new Ue(t)}target(){return this.mg.owner(this.dst)}tilesToDestroy(){if(void 0!==this.tilesToDestroyCache)return this.tilesToDestroyCache;if(null===this.nuke)throw new Error("Not initialized");const t=this.mg.config().nukeMagnitudes(this.nuke.type()),e=new J(this.mg.ticks()),i=t.inner*t.inner,s=t.outer*t.outer;return this.tilesToDestroyCache=this.mg.bfs(this.dst,((t,r)=>{const n=this.mg?.euclideanDistSquared(this.dst,r)??0;return n<=s&&(n<=i||e.chance(2))})),this.tilesToDestroyCache}maybeBreakAlliances(t){if(null===this.nuke)throw new Error("Not initialized");const e=new Map;for(const i of t){const t=this.mg.owner(i);if(t.isPlayer()){const i=e.get(t)??0;e.set(t,i+1)}}const i=this.mg.config().nukeAllianceBreakThreshold();for(const[t,s]of e)if(s>i&&this.nuke.type()!==b.MIRVWarhead){const e=t.incomingAllianceRequests().find((t=>t.requestor()===this.player));e&&e?.reject();const i=this.player.allianceWith(t);null!==i&&this.player.breakAlliance(i),t!==this.player&&t.updateRelation(this.player,-100)}}tick(t){if(null===this.nuke){const t=this.src??this.player.canBuild(this.nukeType,this.dst);if(!1===t)return console.warn("cannot build Nuke"),void(this.active=!1);if(this.src=t,this.pathFinder.computeControlPoints(t,this.dst,this.speed,this.nukeType!==b.MIRVWarhead),this.nuke=this.player.buildUnit(this.nukeType,t,{targetTile:this.dst,trajectory:this.getTrajectory(this.dst)}),this.maybeBreakAlliances(this.tilesToDestroy()),this.mg.hasOwner(this.dst)){const t=this.mg.owner(this.dst);t.isPlayer()&&(this.nukeType===b.AtomBomb?this.mg.displayIncomingUnit(this.nuke.id(),`${this.player.name()} - atom bomb inbound`,S.NUKE_INBOUND,t.id()):this.nukeType===b.HydrogenBomb&&this.mg.displayIncomingUnit(this.nuke.id(),`${this.player.name()} - hydrogen bomb inbound`,S.HYDROGEN_BOMB_INBOUND,t.id())),this.mg.stats().bombLaunch(this.player,t,this.nukeType)}const e=this.player.units(b.MissileSilo).find((e=>e.tile()===t));return void(e&&e.launch())}if(!this.nuke.isActive())return console.log("Nuke destroyed before reaching target"),void(this.active=!1);if(this.waitTicks>0)return void this.waitTicks--;const e=this.pathFinder.nextTile(this.speed);!0!==e?(this.updateNukeTargetable(),this.nuke.move(e),this.nuke.setTrajectoryIndex(this.pathFinder.currentIndex())):this.detonate()}getNuke(){return this.nuke}getTrajectory(t){const e=[],i=this.mg.config().defaultNukeTargetableRange()**2,s=this.pathFinder.allTiles();for(const r of s)e.push({tile:r,targetable:this.isTargetable(t,r,i)});return e}isTargetable(t,e,i){return this.mg.euclideanDistSquared(e,t)<i||void 0!==this.src&&null!==this.src&&this.mg.euclideanDistSquared(this.src,e)<i}updateNukeTargetable(){if(null===this.nuke||void 0===this.nuke.targetTile())return;const t=this.mg.config().defaultNukeTargetableRange()**2,e=this.nuke.targetTile();this.nuke.setTargetable(this.isTargetable(e,this.nuke.tile(),t))}detonate(){if(null===this.nuke)throw new Error("Not initialized");const t=this.mg.config().nukeMagnitudes(this.nuke.type()),e=this.tilesToDestroy();this.maybeBreakAlliances(e);const i=this.target().isPlayer()?this.mg.config().maxTroops(this.target()):1;for(const t of e){const e=this.mg.owner(t);e.isPlayer()&&(e.relinquish(t),e.removeTroops(this.mg.config().nukeDeathFactor(this.nukeType,e.troops(),e.numTilesOwned(),i)),e.outgoingAttacks().forEach((t=>{const s=this.mg?.config().nukeDeathFactor(this.nukeType,t.troops(),e.numTilesOwned(),i)??0;t.setTroops(t.troops()-s)})),e.units(b.TransportShip).forEach((t=>{const s=this.mg?.config().nukeDeathFactor(this.nukeType,t.troops(),e.numTilesOwned(),i)??0;t.setTroops(t.troops()-s)}))),this.mg.isLand(t)&&this.mg.setFallout(t,!0)}const s=t.outer*t.outer;for(const t of this.mg.units())t.type()!==b.AtomBomb&&t.type()!==b.HydrogenBomb&&t.type()!==b.MIRVWarhead&&t.type()!==b.MIRV&&this.mg.euclideanDistSquared(this.dst,t.tile())<s&&t.delete(!0,this.player);this.redrawBuildings(t.outer+16),this.active=!1,this.nuke.setReachedTarget(),this.nuke.delete(!1),this.mg.stats().bombLand(this.player,this.target(),this.nuke.type())}redrawBuildings(t){const e=t*t;for(const t of this.mg.units())i=t.type(),M.has(i)&&this.mg.euclideanDistSquared(this.dst,t.tile())<e&&t.touch();var i}owner(){return this.player}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Ge{constructor(t,e){this.player=t,this.dst=e,this.active=!0,this.nuke=null,this.mirvRange=1500,this.warheadCount=350,this.speed=-1}init(t,e){if(this.random=new J(t.ticks()+j(this.player.id())),this.mg=t,this.pathFinder=new Ue(t),this.targetPlayer=this.mg.owner(this.dst),this.speed=this.mg.config().defaultNukeSpeed(),this.mg.stats().bombLaunch(this.player,this.targetPlayer,b.MIRV),this.targetPlayer.isPlayer()){const t=this.player.allianceWith(this.targetPlayer);null!==t&&this.player.breakAlliance(t),this.targetPlayer!==this.player&&this.targetPlayer.updateRelation(this.player,-100)}}tick(t){if(null===this.nuke){const t=this.player.canBuild(b.MIRV,this.dst);if(!1===t)return console.warn("cannot build MIRV"),void(this.active=!1);this.nuke=this.player.buildUnit(b.MIRV,t,{});const e=Math.floor((this.mg.x(this.dst)+this.mg.x(this.mg.x(this.nuke.tile())))/2),i=Math.max(0,this.mg.y(this.dst)-500)+50;this.separateDst=this.mg.ref(e,i),this.pathFinder.computeControlPoints(t,this.separateDst),this.mg.displayIncomingUnit(this.nuke.id(),`‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ${this.player.name()} - MIRV INBOUND ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è`,S.MIRV_INBOUND,this.targetPlayer.id())}const e=this.pathFinder.nextTile(this.speed);if(!0===e)return this.separate(),this.active=!1,void this.mg.stats().bombLand(this.player,this.targetPlayer,b.MIRV);this.nuke.move(e)}separate(){if(null===this.nuke)throw new Error("uninitialized");const t=[this.dst];let e=1e3;for(;e>0&&t.length<this.warheadCount;){e--;const i=this.randomLand(this.dst,t);null!==i&&t.push(i)}console.log(`dsts: ${t.length}`),t.sort(((t,e)=>this.mg.manhattanDist(e,this.dst)-this.mg.manhattanDist(t,this.dst))),console.log(`got ${t.length} dsts!!`);for(const[e,i]of t.entries())this.mg.addExecution(new He(b.MIRVWarhead,this.player,i,this.nuke.tile(),15+Math.floor(e/this.warheadCount*5),this.random.nextInt(0,15)));this.nuke.delete(!1)}randomLand(t,e){let i=0;const s=this.mirvRange*this.mirvRange;for(;i<100;){i++;const r=this.random.nextInt(this.mg.x(t)-this.mirvRange,this.mg.x(t)+this.mirvRange),n=this.random.nextInt(this.mg.y(t)-this.mirvRange,this.mg.y(t)+this.mirvRange);if(!this.mg.isValidCoord(r,n))continue;const a=this.mg.ref(r,n);if(this.mg.isLand(a)&&!(this.mg.euclideanDistSquared(a,t)>s||this.mg.owner(a)!==this.targetPlayer||this.proximityCheck(a,e)))return a}return console.log("couldn't find place, giving up"),null}proximityCheck(t,e){for(const i of e)if(this.mg.manhattanDist(t,i)<55)return!0;return!1}owner(){return this.player}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Ve{constructor(t,e){this.player=t,this.tile=e,this.active=!0,this.silo=null}init(t,e){this.mg=t}tick(t){if(null===this.silo){const t=this.player.canBuild(b.MissileSilo,this.tile);if(!1===t)return console.warn(`player ${this.player} cannot build missile silo at ${this.tile}`),void(this.active=!1);this.silo=this.player.buildUnit(b.MissileSilo,t,{}),this.player!==this.silo.owner()&&(this.player=this.silo.owner())}const e=this.silo.missileTimerQueue()[0];void 0!==e&&this.mg.config().SiloCooldown()-(this.mg.ticks()-e)<=0&&this.silo.reloadMissile()}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class ze{constructor(t,e,i){this.origOwner=t,this.srcPort=e,this._dstPort=i,this.active=!0,this.wasCaptured=!1,this.tilesTraveled=0}init(t,e){this.mg=t,this.pathFinder=Le.Mini(t,2500)}tick(t){if(void 0===this.tradeShip){const e=this.origOwner.canBuild(b.TradeShip,this.srcPort.tile());if(!1===e)return console.warn("cannot build trade ship"),void(this.active=!1);this.tradeShip=this.origOwner.buildUnit(b.TradeShip,e,{targetUnit:this._dstPort,lastSetSafeFromPirates:t}),this.mg.stats().boatSendTrade(this.origOwner,this._dstPort.owner())}if(!this.tradeShip.isActive())return void(this.active=!1);const e=this.tradeShip.owner(),i=this._dstPort.owner();if(!0!==this.wasCaptured&&this.origOwner!==e&&(this.wasCaptured=!0),i.id()===this.srcPort.owner().id())return this.tradeShip.delete(!1),void(this.active=!1);if(!(this.wasCaptured||this._dstPort.isActive()&&e.canTrade(i)))return this.tradeShip.delete(!1),void(this.active=!1);if(this.wasCaptured&&(e!==i||!this._dstPort.isActive())){const t=this.tradeShip.owner().units(b.Port).sort(R(this.mg,this.tradeShip));if(0===t.length)return this.tradeShip.delete(!1),void(this.active=!1);this._dstPort=t[0],this.tradeShip.setTargetUnit(this._dstPort)}const s=this.tradeShip.tile();if(s===this.dstPort())return void this.complete();const r=this.pathFinder.nextTile(s,this._dstPort.tile());switch(r.type){case fe.Pending:this.tradeShip.move(s);break;case fe.NextTile:this.mg.isWater(r.node)&&this.mg.isShoreline(r.node)&&this.tradeShip.setSafeFromPirates(),this.tradeShip.move(r.node),this.tilesTraveled++;break;case fe.Completed:this.complete();break;case fe.PathNotFound:console.warn("captured trade ship cannot find route"),this.tradeShip.isActive()&&this.tradeShip.delete(!1),this.active=!1}}complete(){this.active=!1,this.tradeShip.delete(!1);const t=this.mg.config().tradeShipGold(this.tilesTraveled,this.tradeShip.owner().unitCount(b.Port));this.wasCaptured?(this.tradeShip.owner().addGold(t,this._dstPort.tile()),this.mg.displayMessage(`Received ${Ht(t)} gold from ship captured from ${this.origOwner.displayName()}`,S.CAPTURED_ENEMY_UNIT,this.tradeShip.owner().id(),t)):(this.srcPort.owner().addGold(t),this._dstPort.owner().addGold(t,this._dstPort.tile()),this.mg.displayMessage(`Received ${Ht(t)} gold from trade with ${this.srcPort.owner().displayName()}`,S.RECEIVED_GOLD_FROM_TRADE,this._dstPort.owner().id(),t),this.mg.displayMessage(`Received ${Ht(t)} gold from trade with ${this._dstPort.owner().displayName()}`,S.RECEIVED_GOLD_FROM_TRADE,this.srcPort.owner().id(),t))}isActive(){return this.active}activeDuringSpawnPhase(){return!1}dstPort(){return this._dstPort.tile()}}class Ke{constructor(t,e){this.player=t,this.tile=e,this.active=!0,this.port=null}init(t,e){this.mg=t,this.random=new J(t.ticks()),this.checkOffset=t.ticks()%10}tick(t){if(null===this.mg||null===this.random||null===this.checkOffset)throw new Error("Not initialized");if(null===this.port){const t=this.tile,e=this.player.canBuild(b.Port,t);if(!1===e)return console.warn(`player ${this.player.id()} cannot build port at ${this.tile}`),void(this.active=!1);this.port=this.player.buildUnit(b.Port,e,{}),this.createStation()}if(!this.port.isActive())return void(this.active=!1);if(this.player.id()!==this.port.owner().id()&&(this.player=this.port.owner()),(this.mg.ticks()+this.checkOffset)%10!=0)return;if(!this.shouldSpawnTradeShip())return;const e=this.player.tradingPorts(this.port);if(0===e.length)return;const i=this.random.randElement(e);this.mg.addExecution(new ze(this.player,this.port,i))}isActive(){return this.active}activeDuringSpawnPhase(){return!1}shouldSpawnTradeShip(){const t=this.mg.unitCount(b.TradeShip),e=this.player.unitCount(b.Port),i=this.player.unitCount(b.TradeShip),s=this.mg.config().tradeShipSpawnRate(t,e,i);for(let t=0;t<this.port.level();t++)if(this.random.chance(s))return!0;return!1}createStation(){null!==this.port&&this.mg.hasUnitNearby(this.port.tile(),this.mg.config().trainStationMaxRange(),b.Factory)&&this.mg.addExecution(new Ie(this.port))}}class Ye{constructor(t,e,i,s,r){this.spawn=t,this._owner=e,this.ownerUnit=i,this.target=s,this.targetTile=r,this.active=!0,this.speed=0}init(t,e){this.pathFinder=new Fe(t,new J(t.ticks())),this.mg=t,this.speed=this.mg.config().defaultSamMissileSpeed()}tick(t){if(this.SAMMissile??(this.SAMMissile=this._owner.buildUnit(b.SAMMissile,this.spawn,{})),!this.SAMMissile.isActive())return void(this.active=!1);const e=[b.AtomBomb,b.HydrogenBomb];if(!this.target.isActive()||!this.ownerUnit.isActive()||this.target.owner()===this.SAMMissile.owner()||!e.includes(this.target.type()))return this.SAMMissile.delete(!1),void(this.active=!1);for(let t=0;t<this.speed;t++){const t=this.pathFinder.nextTile(this.SAMMissile.tile(),this.targetTile);if(!0===t)return this.mg.displayMessage(`Missile intercepted ${this.target.type()}`,S.SAM_HIT,this._owner.id()),this.active=!1,this.target.delete(!0,this._owner),this.SAMMissile.delete(!1),void this.mg.stats().bombIntercept(this._owner,this.target.type(),1);this.SAMMissile.move(t)}}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Xe{constructor(t,e){this.mg=t,this.sam=e,this.precomputedNukes=new Map,this.missileSpeed=this.mg.config().defaultSamMissileSpeed()}updateUnreachableNukes(t){const e=new Set(t.map((t=>t.unit.id())));for(const t of this.precomputedNukes.keys())e.has(t)||this.precomputedNukes.delete(t)}isInRange(t){const e=this.sam.tile(),i=this.mg.config().defaultSamRange(),s=i*i;return this.mg.euclideanDistSquared(e,t)<=s}tickToReach(t,e){return Math.ceil(this.mg.manhattanDist(t,e)/this.missileSpeed)}computeInterceptionTile(t){const e=t.trajectory(),i=this.sam.tile(),s=t.trajectoryIndex(),r=e.length-s;for(let t=s;t<e.length;t++){const n=e[t];if(n.targetable&&this.isInRange(n.tile)){const e=t-s,a=this.tickToReach(i,n.tile),o=e-a;if(a<r&&o>=0)return{tick:o,tile:n.tile}}}}getSingleTarget(t){const e=2*this.mg.config().defaultSamRange(),i=this.mg.nearbyUnits(this.sam.tile(),e,[b.AtomBomb,b.HydrogenBomb],(({unit:t})=>C(t)&&t.owner()!==this.sam.owner()&&!this.sam.owner().isFriendly(t.owner())));this.updateUnreachableNukes(i);const s=[];for(const e of i){const i=e.unit.id(),r=this.precomputedNukes.get(i);if(void 0!==r){if(null===r)continue;if(r.tick===t){s.push({tile:r.tile,unit:e.unit}),this.precomputedNukes.delete(i);continue}if(r.tick>t)continue;this.precomputedNukes.delete(i)}const n=this.computeInterceptionTile(e.unit);void 0!==n?n.tick<=1?s.push({unit:e.unit,tile:n.tile}):this.precomputedNukes.set(i,{tick:n.tick+t,tile:n.tile}):this.precomputedNukes.set(i,null)}return s.sort(((t,e)=>t.unit.type()===b.HydrogenBomb&&e.unit.type()!==b.HydrogenBomb?-1:t.unit.type()!==b.HydrogenBomb&&e.unit.type()===b.HydrogenBomb?1:0))[0]??null}}class Qe{constructor(t,e,i=null){this.player=t,this.tile=e,this.sam=i,this.active=!0,this.MIRVWarheadSearchRadius=400,this.MIRVWarheadProtectionRadius=50,null!==i&&(this.tile=i.tile())}init(t,e){this.mg=t}isHit(t,e){return t===b.AtomBomb||(t===b.MIRVWarhead?e<this.mg.config().samWarheadHittingChance():e<this.mg.config().samHittingChance())}tick(t){if(null===this.mg||null===this.player)throw new Error("Not initialized");if(null===this.sam){if(null===this.tile)throw new Error("tile is null");const t=this.player.canBuild(b.SAMLauncher,this.tile);if(!1===t)return console.warn("cannot build SAM Launcher"),void(this.active=!1);this.sam=this.player.buildUnit(b.SAMLauncher,t,{})}if(this.targetingSystem??(this.targetingSystem=new Xe(this.mg,this.sam)),this.sam.isInCooldown()){const t=this.sam.missileTimerQueue()[0];if(void 0===t)return;return void(this.mg.config().SAMCooldown()-(this.mg.ticks()-t)<=0&&this.sam.reloadMissile())}if(!this.sam.isActive())return void(this.active=!1);this.player!==this.sam.owner()&&(this.player=this.sam.owner()),this.pseudoRandom??(this.pseudoRandom=new J(this.sam.id()));const e=this.mg.nearbyUnits(this.sam.tile(),this.MIRVWarheadSearchRadius,b.MIRVWarhead,(({unit:t})=>{if(!C(t))return!1;if(t.owner()===this.player)return!1;if(this.player.isFriendly(t.owner()))return!1;const e=t.targetTile();return null!==this.sam&&void 0!==e&&this.mg.manhattanDist(e,this.sam.tile())<this.MIRVWarheadProtectionRadius}));let i=null;if(0===e.length&&(i=this.targetingSystem.getSingleTarget(t),null!==i&&console.log("Target acquired")),i&&!i.unit.targetedBySAM()||e.length>0){this.sam.launch();const t=e.length>0?b.MIRVWarhead:i?.unit.type();if(void 0===t)throw new Error("Unknown unit type");const s=this.pseudoRandom.next();if(this.isHit(t,s))if(e.length>0){const t=this.sam.owner();this.mg.displayMessage(`${e.length} MIRV warheads intercepted`,S.SAM_HIT,t.id()),e.forEach((({unit:t})=>{t.delete()})),this.mg.stats().bombIntercept(t,b.MIRVWarhead,e.length)}else{if(null===i)throw new Error("target is null");i.unit.setTargetedBySAM(!0),this.mg.addExecution(new Ye(this.sam.tile(),this.sam.owner(),this.sam,i.unit,i.tile))}else this.mg.displayMessage(`Missile failed to intercept ${t}`,S.SAM_MISS,this.sam.owner().id())}}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Je{constructor(t){this.input=t,this.lastShellAttack=0,this.alreadySentShell=new Set}init(t,e){if(this.mg=t,this.pathfinder=Le.Mini(t,1e4,!0,100),this.random=new J(t.ticks()),C(this.input))this.warship=this.input;else{const t=this.input.owner.canBuild(b.Warship,this.input.patrolTile);if(!1===t)return void console.warn(`Failed to spawn warship for ${this.input.owner.name()} at ${this.input.patrolTile}`);this.warship=this.input.owner.buildUnit(b.Warship,t,this.input)}}tick(t){this.warship.health()<=0||this.warship.owner().isDisconnected()?this.warship.delete():(this.warship.owner().unitCount(b.Port)>0&&this.warship.modifyHealth(1),this.warship.setTargetUnit(this.findTargetUnit()),this.warship.targetUnit()?.type()!==b.TradeShip?(this.patrol(),void 0===this.warship.targetUnit()||this.shootTarget()):this.huntDownTradeShip())}findTargetUnit(){const t=this.warship.owner().unitCount(b.Port)>0,e=this.mg.config().warshipPatrolRange()**2,i=this.mg.nearbyUnits(this.warship.tile(),this.mg.config().warshipTargettingRange(),[b.TransportShip,b.Warship,b.TradeShip]),s=[];for(const{unit:r,distSquared:n}of i)if(r.owner()!==this.warship.owner()&&r!==this.warship&&!r.owner().isFriendly(this.warship.owner())&&!this.alreadySentShell.has(r)){if(r.type()===b.TradeShip){if(!t||r.isSafeFromPirates()||r.targetUnit()?.owner()===this.warship.owner()||r.targetUnit()?.owner().isFriendly(this.warship.owner()))continue;if(this.mg.euclideanDistSquared(this.warship.patrolTile(),r.tile())>e)continue}s.push({unit:r,distSquared:n})}return s.sort(((t,e)=>{const{unit:i,distSquared:s}=t,{unit:r,distSquared:n}=e;return i.type()===b.TransportShip&&r.type()!==b.TransportShip?-1:i.type()!==b.TransportShip&&r.type()===b.TransportShip?1:i.type()===b.Warship&&r.type()!==b.Warship?-1:i.type()!==b.Warship&&r.type()===b.Warship?1:s-n}))[0]?.unit}shootTarget(){const t=this.mg.config().warshipShellAttackRate();if(this.mg.ticks()-this.lastShellAttack>t&&(this.warship.targetUnit()?.type()!==b.TransportShip&&(this.lastShellAttack=this.mg.ticks()),this.mg.addExecution(new qe(this.warship.tile(),this.warship.owner(),this.warship,this.warship.targetUnit())),!this.warship.targetUnit().hasHealth()))return this.alreadySentShell.add(this.warship.targetUnit()),void this.warship.setTargetUnit(void 0)}huntDownTradeShip(){for(let t=0;t<2;t++){const t=this.pathfinder.nextTile(this.warship.tile(),this.warship.targetUnit().tile(),5);switch(t.type){case fe.Completed:return this.warship.owner().captureUnit(this.warship.targetUnit()),this.warship.setTargetUnit(void 0),void this.warship.move(this.warship.tile());case fe.NextTile:this.warship.move(t.node);break;case fe.Pending:this.warship.touch();break;case fe.PathNotFound:console.log("path not found to target")}}}patrol(){if(void 0===this.warship.targetTile()&&(this.warship.setTargetTile(this.randomTile()),void 0===this.warship.targetTile()))return;const t=this.pathfinder.nextTile(this.warship.tile(),this.warship.targetTile());switch(t.type){case fe.Completed:this.warship.setTargetTile(void 0),this.warship.move(t.node);break;case fe.NextTile:this.warship.move(t.node);break;case fe.Pending:return void this.warship.touch();case fe.PathNotFound:console.warn("path not found to target tile"),this.warship.setTargetTile(void 0)}}isActive(){return this.warship?.isActive()}activeDuringSpawnPhase(){return!1}randomTile(t=!1){let e=this.mg.config().warshipPatrolRange(),i=0,s=0;for(;s<3;){const r=this.mg.x(this.warship.patrolTile())+this.random.nextInt(-e/2,e/2),n=this.mg.y(this.warship.patrolTile())+this.random.nextInt(-e/2,e/2);if(!this.mg.isValidCoord(r,n))continue;const a=this.mg.ref(r,n);if(this.mg.isOcean(a)&&(t||!this.mg.isShoreline(a)))return a;i++,500===i&&(s++,i=0,e+=Math.floor(e/2))}if(console.warn(`Failed to find random tile for warship for ${this.warship.owner().name()}`),!t)return this.randomTile(!0)}}class Ze{constructor(t,e,i){this.player=t,this.constructionType=e,this.tile=i,this.construction=null,this.active=!0}init(t,e){return this.mg=t,this.mg.config().isUnitDisabled(this.constructionType)?(console.warn(`cannot build construction ${this.constructionType} because it is disabled`),void(this.active=!1)):this.mg.isValidRef(this.tile)?void 0:(console.warn(`cannot build construction invalid tile ${this.tile}`),void(this.active=!1))}tick(t){if(null===this.construction){const t=this.mg.unitInfo(this.constructionType);if(void 0===t.constructionDuration)return this.completeConstruction(),void(this.active=!1);const e=this.player.canBuild(this.constructionType,this.tile);return!1===e?(console.warn(`cannot build ${this.constructionType}`),void(this.active=!1)):(this.construction=this.player.buildUnit(b.Construction,e,{}),this.cost=this.mg.unitInfo(this.constructionType).cost(this.player),this.player.removeGold(this.cost),this.construction.setConstructionType(this.constructionType),void(this.ticksUntilComplete=t.constructionDuration))}if(this.construction.isActive()){if(this.player!==this.construction.owner()&&(this.player=this.construction.owner()),0===this.ticksUntilComplete)return this.player=this.construction.owner(),this.construction.delete(!1),this.player.addGold(this.cost),this.completeConstruction(),void(this.active=!1);this.ticksUntilComplete--}else this.active=!1}completeConstruction(){const t=this.player;switch(this.constructionType){case b.AtomBomb:case b.HydrogenBomb:this.mg.addExecution(new He(this.constructionType,t,this.tile));break;case b.MIRV:this.mg.addExecution(new Ge(t,this.tile));break;case b.Warship:this.mg.addExecution(new Je({owner:t,patrolTile:this.tile}));break;case b.Port:this.mg.addExecution(new Ke(t,this.tile));break;case b.MissileSilo:this.mg.addExecution(new Ve(t,this.tile));break;case b.DefensePost:this.mg.addExecution(new $e(t,this.tile));break;case b.SAMLauncher:this.mg.addExecution(new Qe(t,this.tile));break;case b.City:this.mg.addExecution(new De(t,this.tile));break;case b.Factory:this.mg.addExecution(new We(t,this.tile));break;default:console.warn(`unit type ${this.constructionType} cannot be constructed`)}}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class ti{constructor(t,e){this.player=t,this.unitId=e,this.active=!0}activeDuringSpawnPhase(){return!1}init(t,e){if(!this.active)return;this.mg=t;const i=this.player.units().find((t=>t.id()===this.unitId));if(!i)return console.warn(`SECURITY: unit ${this.unitId} not found or not owned by player ${this.player.displayName()}`),void(this.active=!1);if(!i.isActive())return console.warn(`SECURITY: unit ${this.unitId} is not active`),void(this.active=!1);const s=t.owner(i.tile());return s.isPlayer()&&s.id()===this.player.id()?t.isLand(i.tile())?t.inSpawnPhase()?(console.warn("SECURITY: cannot delete units during spawn phase"),void(this.active=!1)):this.player.canDeleteUnit()?(i.delete(!1),this.player.recordDeleteUnit(),this.mg.displayMessage("events_display.unit_voluntarily_deleted",S.UNIT_DESTROYED,this.player.id()),void(this.active=!1)):(console.warn("SECURITY: delete unit cooldown not expired"),void(this.active=!1)):(console.warn(`SECURITY: unit ${this.unitId} is not on land`),void(this.active=!1)):(console.warn(`SECURITY: unit ${this.unitId} is not on player's territory`),void(this.active=!1))}tick(t){}isActive(){return this.active}}class ei{constructor(t,e,i){this.sender=t,this.recipientID=e,this.active=!0,this.gold=L(i??0)}init(t,e){if(!t.hasPlayer(this.recipientID))return console.warn(`DonateExecution recipient ${this.recipientID} not found`),void(this.active=!1);this.recipient=t.player(this.recipientID),this.gold??(this.gold=this.sender.gold()/3n)}tick(t){if(null===this.gold)throw new Error("not initialized");this.sender.canDonateGold(this.recipient)&&this.sender.donateGold(this.recipient,this.gold)?this.recipient.updateRelation(this.sender,50):console.warn(`cannot send gold from ${this.sender.name()} to ${this.recipient.name()}`),this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class ii{constructor(t,e,i){this.sender=t,this.recipientID=e,this.troops=i,this.active=!0}init(t,e){if(!t.hasPlayer(this.recipientID))return console.warn(`DonateExecution recipient ${this.recipientID} not found`),void(this.active=!1);this.recipient=t.player(this.recipientID),this.troops??(this.troops=t.config().defaultDonationAmount(this.sender));const i=t.config().maxTroops(this.recipient)-this.recipient.troops();this.troops=Math.min(this.troops,i)}tick(t){if(null===this.troops)throw new Error("not initialized");this.sender.canDonateTroops(this.recipient)&&this.sender.donateTroops(this.recipient,this.troops)?this.recipient.updateRelation(this.sender,50):console.warn(`cannot send troops from ${this.sender} to ${this.recipient}`),this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class si{constructor(t,e,i){this.player=t,this.targetID=e,this.action=i,this.active=!0}init(t,e){if(!t.hasPlayer(this.targetID))return console.warn(`EmbargoExecution recipient ${this.targetID} not found`),void(this.active=!1);this.target=t.player(this.targetID)}tick(t){"start"===this.action?this.player.addEmbargo(this.target,!1):this.player.stopEmbargo(this.target),this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}function ri(t,e,i){if(!t.isShore(i))return!1;const s=ai(t,e,i);return null!==s&&s}function ni(t,e){const i=t.playerBySmallID(t.ownerID(e));let s=null;return s=i.isPlayer()?ai(t,i,e):function(t,e,i){const s=Array.from(t.bfs(e,oe(((e,i)=>!t.hasOwner(i)),ae(e,i)))).filter((e=>t.isShore(e))).sort(((i,s)=>t.manhattanDist(e,i)-t.manhattanDist(e,s)));return 0===s.length?null:s[0]}(t,e,50),s}function ai(t,e,i){const s=Array.from(e.borderTiles()).filter((e=>t.isShore(e)));return 0===s.length?null:s.reduce(((e,s)=>{const r=t.manhattanDist(i,e);return t.manhattanDist(i,s)<r?s:e}))}class oi{constructor(t,e,i,s,r){this.attacker=t,this.targetID=e,this.ref=i,this.startTroops=s,this.src=r,this.ticksPerMove=1,this.active=!0}activeDuringSpawnPhase(){return!1}init(t,e){if(null!==this.targetID&&!t.hasPlayer(this.targetID))return console.warn(`TransportShipExecution: target ${this.targetID} not found`),void(this.active=!1);if(!t.isValidRef(this.ref))return console.warn(`TransportShipExecution: ref ${this.ref} not valid`),void(this.active=!1);if(null!==this.src&&!t.isValidRef(this.src))return console.warn(`TransportShipExecution: src ${this.src} not valid`),void(this.active=!1);if(this.lastMove=e,this.mg=t,this.pathFinder=Le.Mini(t,1e4,!0,100),this.attacker.unitCount(b.TransportShip)>=t.config().boatMaxNumber())return t.displayMessage(`No boats available, max ${t.config().boatMaxNumber()}`,S.ATTACK_FAILED,this.attacker.id()),void(this.active=!1);if(null===this.targetID||this.targetID===this.mg.terraNullius().id()?this.target=t.terraNullius():this.target=t.player(this.targetID),this.startTroops??(this.startTroops=this.mg.config().boatAttackAmount(this.attacker,this.target)),this.startTroops=Math.min(this.startTroops,this.attacker.troops()),this.dst=ni(this.mg,this.ref),null===this.dst)return console.warn(`${this.attacker} cannot send ship to ${this.target}, cannot find attack tile`),void(this.active=!1);const i=this.attacker.canBuild(b.TransportShip,this.dst);if(!1===i)return console.warn("can't build transport ship"),void(this.active=!1);null===this.src?this.src=i:this.mg.owner(this.src)===this.attacker&&this.mg.isShore(this.src)||(console.warn(`src is not a shore tile or not owned by: ${this.attacker.name()}`),this.src=i),this.boat=this.attacker.buildUnit(b.TransportShip,this.src,{troops:this.startTroops}),null!==this.dst?this.boat.setTargetTile(this.dst):this.boat.setTargetTile(void 0),this.targetID&&this.targetID!==t.terraNullius().id()&&t.displayIncomingUnit(this.boat.id(),`Naval invasion incoming from ${this.attacker.displayName()}`,S.NAVAL_INVASION_INBOUND,this.targetID),this.mg.stats().boatSendTroops(this.attacker,this.target,this.boat.troops())}tick(t){if(null===this.dst)return void(this.active=!1);if(!this.active)return;if(!this.boat.isActive())return void(this.active=!1);if(t-this.lastMove<this.ticksPerMove)return;this.lastMove=t,this.boat.retreating()&&(this.dst=this.src,this.boat.targetTile()!==this.dst&&this.boat.setTargetTile(this.dst));const e=this.pathFinder.nextTile(this.boat.tile(),this.dst);switch(e.type){case fe.Completed:return this.mg.owner(this.dst)===this.attacker?(this.attacker.addTroops(this.boat.troops()),this.boat.delete(!1),this.active=!1,void this.mg.stats().boatArriveTroops(this.attacker,this.target,this.boat.troops())):(this.attacker.conquer(this.dst),this.target.isPlayer()&&this.attacker.isFriendly(this.target)?this.attacker.addTroops(this.boat.troops()):this.mg.addExecution(new Vt(this.boat.troops(),this.attacker,this.targetID,this.dst,!1)),this.boat.delete(!1),this.active=!1,void this.mg.stats().boatArriveTroops(this.attacker,this.target,this.boat.troops()));case fe.NextTile:this.boat.move(e.node);break;case fe.Pending:break;case fe.PathNotFound:return console.warn("path not found to dst"),this.attacker.addTroops(this.boat.troops()),this.boat.delete(!1),void(this.active=!1)}}owner(){return this.attacker}isActive(){return this.active}}class hi{constructor(t,e){this.nation=e,this.active=!0,this.behavior=null,this.player=null,this.lastEmojiSent=new Map,this.lastNukeSent=[],this.embargoMalusApplied=new Set,this.random=new J(j(e.playerInfo.id)+j(t)),this.attackRate=this.random.nextInt(40,80),this.attackTick=this.random.nextInt(0,this.attackRate),this.triggerRatio=this.random.nextInt(50,60)/100,this.reserveRatio=this.random.nextInt(30,40)/100,this.expandRatio=this.random.nextInt(10,20)/100}init(t){this.mg=t,this.random.chance(10)}updateRelationsFromEmbargos(){const t=this.player;null!==t&&this.mg.players().filter((e=>e.id()!==t.id())).forEach((e=>{e.hasEmbargoAgainst(t)&&!this.embargoMalusApplied.has(e.id())?(t.updateRelation(e,-20),this.embargoMalusApplied.add(e.id())):!e.hasEmbargoAgainst(t)&&this.embargoMalusApplied.has(e.id())&&(t.updateRelation(e,20),this.embargoMalusApplied.delete(e.id()))}))}handleEmbargoesToHostileNations(){const t=this.player;null!==t&&this.mg.players().filter((e=>e.id()!==t.id())).forEach((e=>{t.relation(e)<=v.Hostile&&!t.hasEmbargoAgainst(e)&&!t.isOnSameTeam(e)?t.addEmbargo(e,!1):t.relation(e)>=v.Neutral&&t.hasEmbargoAgainst(e)&&t.stopEmbargo(e)}))}tick(t){if(t%this.attackRate===this.attackTick){if(this.mg.inSpawnPhase()){const t=this.randomSpawnLand();return null===t?void console.warn(`cannot spawn ${this.nation.playerInfo.name}`):void this.mg.addExecution(new ce(this.nation.playerInfo,t))}if(null!==this.player||(this.player=this.mg.players().find((t=>t.id()===this.nation.playerInfo.id))??null,null!==this.player))if(this.player.isAlive()){if(null===this.behavior)return this.behavior=new ee(this.random,this.mg,this.player,this.triggerRatio,this.reserveRatio,this.expandRatio),void this.behavior.forceSendAttack(this.mg.terraNullius());this.updateRelationsFromEmbargos(),this.behavior.handleAllianceRequests(),this.behavior.handleAllianceExtensionRequests(),this.handleUnits(),this.handleEmbargoesToHostileNations(),this.maybeAttack()}else this.active=!1}}maybeConsiderBetrayal(t){if(null===this.player)throw new Error("not initialized");const e=this.player.allianceWith(t);return!!e&&(this.player.breakAlliance(e),!0)}maybeAttack(){if(null===this.player||null===this.behavior)throw new Error("not initialized");const t=Array.from(this.player.borderTiles()).flatMap((t=>this.mg.neighbors(t))).filter((t=>this.mg.isLand(t)&&this.mg.ownerID(t)!==this.player?.smallID()));if(0===t.length)return void(this.random.chance(10)&&this.sendBoatRandomly());if(this.random.chance(20))return void this.sendBoatRandomly();const e=t.map((t=>this.mg.playerBySmallID(this.mg.ownerID(t))));if(e.some((t=>!t.isPlayer())))return void this.behavior.sendAttack(this.mg.terraNullius());const i=e.filter((t=>t.isPlayer())).sort(((t,e)=>t.troops()-e.troops()));if(this.random.chance(20)){const t=this.random.randElement(i);this.player.canSendAllianceRequest(t)&&this.player.createAllianceRequest(t)}this.behavior.forgetOldEnemies(),this.behavior.assistAllies();const s=this.behavior.selectEnemy(i);s&&(this.maybeSendEmoji(s),this.maybeSendNuke(s),this.player.sharesBorderWith(s)?this.behavior.sendAttack(s):this.maybeSendBoatAttack(s))}maybeSendEmoji(t){if(null===this.player)throw new Error("not initialized");if(t.type()!==A.Human)return;const e=this.lastEmojiSent.get(t)??-300;this.mg.ticks()-e<=300||(this.lastEmojiSent.set(t,this.mg.ticks()),this.mg.addExecution(new Kt(this.player,t.id(),this.random.randElement(te))))}maybeSendNuke(t){if(null===this.player)throw new Error("not initialized");const e=this.player.units(b.MissileSilo);if(0===e.length||this.player.gold()<this.cost(b.AtomBomb)||t.type()===A.Bot||this.player.isOnSameTeam(t))return;const i=this.player.gold()>this.cost(b.HydrogenBomb)?b.HydrogenBomb:b.AtomBomb,s=i===b.HydrogenBomb?60:15,r=t.units(b.City,b.DefensePost,b.MissileSilo,b.Port,b.SAMLauncher),n=r.map((t=>t.tile())),a=this.randTerritoryTileArray(10).concat(n);let o=null,h=0;this.removeOldNukeEvents();t:for(const n of new Set(a)){if(null===n)continue;const a=B(this.mg,n,s).concat(B(this.mg,n,Math.floor(s/2)));for(const e of a)if(this.mg.owner(e)!==t)continue t;if(!this.player.canBuild(i,n))continue;const l=this.nukeTileScore(n,e,r);l>h&&(o=n,h=l)}null!==o&&this.sendNuke(o,i)}removeOldNukeEvents(){const t=this.mg.ticks();for(;this.lastNukeSent.length>0&&this.lastNukeSent[0][0]+500<t;)this.lastNukeSent.shift()}sendNuke(t,e){if(null===this.player)throw new Error("not initialized");const i=this.mg.ticks();this.lastNukeSent.push([i,t]),this.mg.addExecution(new He(e,this.player,t))}nukeTileScore(t,e,i){const s=ne(t,25,!1);let r=i.filter((t=>s(this.mg,t.tile()))).map((t=>{switch(t.type()){case b.City:return 25e3;case b.DefensePost:return 5e3;case b.MissileSilo:return 5e4;case b.Port:return 1e4;default:return 0}})).reduce(((t,e)=>t+e),0);const n=ne(t,50,!1);r-=5e4*i.filter((t=>t.type()===b.SAMLauncher&&n(this.mg,t.tile()))).length;const a=e.map((t=>t.tile())),o=le(this.mg,a,[t]);if(null===o)throw new Error("Missing result");const{x:h}=o,l=this.mg.euclideanDistSquared(t,h);return r-=30*Math.sqrt(l),r-=this.lastNukeSent.filter((([t,e])=>s(this.mg,e))).map((t=>1e6)).reduce(((t,e)=>t+e),0),r}maybeSendBoatAttack(t){if(null===this.player)throw new Error("not initialized");if(this.player.isFriendly(t))return;const e=le(this.mg,Array.from(this.player.borderTiles()).filter((t=>this.mg.isOceanShore(t))),Array.from(t.borderTiles()).filter((t=>this.mg.isOceanShore(t))));null!==e&&this.mg.addExecution(new oi(this.player,t.id(),e.y,this.player.troops()/5,null))}handleUnits(){return this.maybeSpawnStructure(b.City,(t=>t))||this.maybeSpawnStructure(b.Port,(t=>t))||this.maybeSpawnWarship()||this.maybeSpawnStructure(b.Factory,(t=>t))||this.maybeSpawnStructure(b.DefensePost,(t=>(t+2)**2))||this.maybeSpawnStructure(b.SAMLauncher,(t=>t**2))||this.maybeSpawnStructure(b.MissileSilo,(t=>t**2))}maybeSpawnStructure(t,e){if(null===this.player)throw new Error("not initialized");const i=e(this.player.unitsOwned(t)+1),s=this.cost(t)*BigInt(i);if(this.player.gold()<s)return!1;const r=this.structureSpawnTile(t);return null!==r&&(!1!==this.player.canBuild(t,r)&&(this.mg.addExecution(new Ze(this.player,t,r)),!0))}structureSpawnTile(t){if(void 0===this.mg)throw new Error("Not initialized");if(null===this.player)throw new Error("Not initialized");const e=t===b.Port?this.randCoastalTileArray(25):this.randTerritoryTileArray(25);if(0===e.length)return null;const i=function(t,e,i){const s=e.borderTiles(),r=e.units(i),n=t.config().nukeMagnitudes(b.AtomBomb).outer,a=2*n;switch(i){case b.City:case b.Factory:case b.MissileSilo:return e=>{let i=0;i+=t.magnitude(e);const[,o]=he(t,s,e);i+=Math.min(o,n);const h=new Set(r.map((t=>t.tile())));h.delete(e);const l=le(t,h,[e]);if(null!==l){const s=t.manhattanDist(l.x,e);i+=Math.min(s,a)}return i};case b.Port:return e=>{let i=0;const s=new Set(r.map((t=>t.tile())));s.delete(e);const[,n]=he(t,s,e);return i+=Math.min(n,a),i};case b.DefensePost:return i=>{let o=0;o+=t.magnitude(i);const[h,l]=he(t,s,i);if(null!==h){o+=Math.max(0,n-Math.abs(n-l));const i=new Set;for(const s of t.neighbors(h)){if(!t.isLand(s))continue;const r=t.ownerID(s);if(r===e.smallID())continue;const n=t.playerBySmallID(r);n.isPlayer()&&i.add(n)}for(const t of i)o+=n*(v.Friendly-e.relation(t))}const c=new Set(r.map((t=>t.tile())));c.delete(i);const u=le(t,c,[i]);if(null!==u){const e=t.manhattanDist(u.x,i);o+=Math.min(e,a)}return o};case b.SAMLauncher:{const i=new Set;for(const t of e.units())switch(t.type()){case b.City:case b.Factory:case b.MissileSilo:case b.Port:i.add(t.tile())}const o=t.config().defaultSamRange(),h=o*o;return e=>{let o=0;o+=t.magnitude(e);const l=le(t,s,[e]);if(null!==l){const i=t.manhattanDist(l.x,e);o+=Math.min(i,n)}const c=new Set(r.map((t=>t.tile())));c.delete(e);const u=le(t,c,[e]);if(null!==u){const i=t.manhattanDist(u.x,e);o+=Math.min(i,a)}for(const s of i)t.euclideanDistSquared(e,s)>h||(o+=a);return o}}default:throw new Error(`Value function not implemented for ${i}`)}}(this.mg,this.player,t);let s=null,r=0;for(const n of e){const e=i(n);e<=r&&null!==s||this.player.canBuild(t,n)&&(s=n,r=e)}return s}randCoastalTileArray(t){const e=Array.from(this.player.borderTiles()).filter((t=>this.mg.isOceanShore(t)));return Array.from(this.arraySampler(e,t))}*arraySampler(t,e){if(t.length<=e)yield*t;else{const i=new Set(t);for(;e--;){const t=this.random.randFromSet(i);i.delete(t),yield t}}}maybeSpawnWarship(){if(null===this.player)throw new Error("not initialized");if(!this.random.chance(50))return!1;const t=this.player.units(b.Port),e=this.player.units(b.Warship);if(t.length>0&&0===e.length&&this.player.gold()>this.cost(b.Warship)){const e=this.random.randElement(t),i=this.warshipSpawnTile(e.tile());return null!==i&&(!1===this.player.canBuild(b.Warship,i)?(console.warn("cannot spawn destroyer"),!1):(this.mg.addExecution(new Ze(this.player,b.Warship,i)),!0))}return!1}randTerritoryTileArray(t){const e=N(this.mg,this.player.borderTiles()),i=[];for(let s=0;s<t;s++){const t=this.randTerritoryTile(this.player,e);null!==t&&i.push(t)}return i}randTerritoryTile(t,e=null){e??(e=N(this.mg,t.borderTiles()));for(let i=0;i<100;i++){const i=this.random.nextInt(e.min.x,e.max.x),s=this.random.nextInt(e.min.y,e.max.y);if(!this.mg.isOnMap(new D(i,s)))continue;const r=this.mg.ref(i,s);if(this.mg.owner(r)===t)return r}return null}warshipSpawnTile(t){const e=250;for(let i=0;i<50;i++){const i=this.random.nextInt(this.mg.x(t)-e,this.mg.x(t)+e),s=this.random.nextInt(this.mg.y(t)-e,this.mg.y(t)+e);if(!this.mg.isValidCoord(i,s))continue;const r=this.mg.ref(i,s);if(this.mg.isOcean(r))return r}return null}cost(t){if(null===this.player)throw new Error("not initialized");return this.mg.unitInfo(t).cost(this.player)}sendBoatRandomly(){if(null===this.player)throw new Error("not initialized");const t=Array.from(this.player.borderTiles()).filter((t=>this.mg.isOceanShore(t)));if(0===t.length)return;const e=this.random.randElement(t),i=this.randomBoatTarget(e,150);null!==i&&this.mg.addExecution(new oi(this.player,this.mg.owner(i).id(),i,this.player.troops()/5,null))}randomSpawnLand(){let t=0;for(;t<50;){t++;const e=this.nation.spawnCell,i=this.random.nextInt(e.x-25,e.x+25),s=this.random.nextInt(e.y-25,e.y+25);if(!this.mg.isValidCoord(i,s))continue;const r=this.mg.ref(i,s);if(this.mg.isLand(r)&&!this.mg.hasOwner(r)){if(this.mg.terrainType(r)===_.Mountain&&this.random.chance(2))continue;return r}}return null}randomBoatTarget(t,e){if(null===this.player)throw new Error("not initialized");const i=this.mg.x(t),s=this.mg.y(t);for(let t=0;t<500;t++){const t=this.random.nextInt(i-e,i+e),r=this.random.nextInt(s-e,s+e);if(!this.mg.isValidCoord(t,r))continue;const n=this.mg.ref(t,r);if(!this.mg.isLand(n))continue;const a=this.mg.owner(n);if(!a.isPlayer())return n;if(!a.isFriendly(this.player))return n}return null}isActive(){return this.active}activeDuringSpawnPhase(){return!0}}class li{constructor(t,e){this.player=t,this.isDisconnected=e}init(t,e){this.player.markDisconnected(this.isDisconnected)}tick(t){}isActive(){return!1}activeDuringSpawnPhase(){return!1}}class ci{constructor(t,e,i){this.owner=t,this.unitId=e,this.position=i}init(t,e){if(!t.isValidRef(this.position))return void console.warn(`MoveWarshipExecution: position ${this.position} not valid`);const i=this.owner.units(b.Warship).find((t=>t.id()===this.unitId));i?i.isActive()?(i.setPatrolTile(this.position),i.setTargetTile(void 0)):console.warn("MoveWarshipExecution: warship is not active"):console.warn("MoveWarshipExecution: warship not found")}tick(t){}isActive(){return!1}activeDuringSpawnPhase(){return!1}}class ui{isActive(){return!1}activeDuringSpawnPhase(){return!1}init(t,e){}tick(t){}}class di{constructor(t,e,i,s){this.sender=t,this.recipientID=e,this.quickChatKey=i,this.target=s,this.active=!0}init(t,e){if(this.mg=t,!t.hasPlayer(this.recipientID))return console.warn(`QuickChatExecution: recipient ${this.recipientID} not found`),void(this.active=!1);this.recipient=t.player(this.recipientID)}tick(t){const e=this.getMessageFromKey(this.quickChatKey);this.mg.displayChat(e[1],e[0],this.target,this.recipient.id(),!0,this.sender.id()),this.mg.displayChat(e[1],e[0],this.target,this.sender.id(),!1,this.recipient.id()),console.log(`[QuickChat] ${this.sender.name} ‚Üí ${this.recipient.displayName}: ${e}`),this.active=!1}owner(){return this.sender}isActive(){return this.active}activeDuringSpawnPhase(){return!1}getMessageFromKey(t){return t.split(".")}}class gi{constructor(t,e){this.player=t,this.attackID=e,this.active=!0,this.retreatOrdered=!1}init(t,e){this.mg=t,this.startTick=t.ticks()}tick(t){this.retreatOrdered||(this.player.orderRetreat(this.attackID),this.retreatOrdered=!0),this.mg.ticks()>=this.startTick+20&&(this.player.executeRetreat(this.attackID),this.active=!1)}owner(){return this.player}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class pi{constructor(t,e){this.requestor=t,this.targetID=e,this.active=!0}init(t,e){if(!t.hasPlayer(this.targetID))return console.warn(`TargetPlayerExecution: target ${this.targetID} not found`),void(this.active=!1);this.target=t.player(this.targetID)}tick(t){this.requestor.canTarget(this.target)&&(this.requestor.target(this.target),this.target.updateRelation(this.requestor,-40)),this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class mi{constructor(t,e){this.player=t,this.unitId=e}init(t,e){this.structure=this.player.units().find((t=>t.id()===this.unitId)),void 0!==this.structure?this.player.canUpgradeUnit(this.structure.type())?this.player.upgradeUnit(this.structure):console.warn(`[UpgradeStructureExecution] unit type ${this.structure.type()} cannot be upgraded`):console.warn("structure is undefined")}tick(t){}isActive(){return!1}activeDuringSpawnPhase(){return!1}}class fi{constructor(t,e,i){this.mg=t,this.gameID=e,this.clientID=i,this.random=new J(j(e)+1)}createExecs(t){return t.intents.map((t=>this.createExec(t)))}createExec(t){const e=this.mg.playerByClientID(t.clientID);if(!e)return console.warn(`player with clientID ${t.clientID} not found`),new ui;switch(t.type){case"attack":return new Vt(t.troops,e,t.targetID,null);case"cancel_attack":return new gi(e,t.attackID);case"cancel_boat":return new zt(e,t.unitID);case"move_warship":return new ci(e,t.unitId,t.tile);case"spawn":return new ce(e.info(),t.tile);case"boat":return new oi(e,t.targetID,t.dst,t.troops,t.src);case"allianceRequest":return new Lt(e,t.recipient);case"allianceRequestReply":return new qt(t.requestor,e,t.accept);case"breakAlliance":return new $t(e,t.recipient);case"targetPlayer":return new pi(e,t.target);case"emoji":return new Kt(e,t.recipient,t.emoji);case"donate_troops":return new ii(e,t.recipient,t.troops);case"donate_gold":return new ei(e,t.recipient,t.gold);case"embargo":return new si(e,t.targetID,t.action);case"build_unit":return new Ze(e,t.unit,t.tile);case"allianceExtension":return new Ft(e,t.recipient);case"upgrade_structure":return new mi(e,t.unitId);case"delete_unit":return new ti(e,t.unitId);case"quick_chat":return new di(e,t.recipient,t.quickChatKey,t.target);case"mark_disconnected":return new li(e,t.isDisconnected);default:throw new Error(`intent type ${t} not found`)}}spawnBots(t){return new ge(this.mg,this.gameID).spawnBots(t)}fakeHumanExecutions(){const t=[];for(const e of this.mg.nations())t.push(new hi(this.gameID,e));return t}}class yi{constructor(){this.active=!0,this.mg=null}init(t,e){this.mg=t}tick(t){if(t%10==0){if(null===this.mg)throw new Error("Not initialized");this.mg.config().gameConfig().gameMode===y.FFA?this.checkWinnerFFA():this.checkWinnerTeam()}}checkWinnerFFA(){if(null===this.mg)throw new Error("Not initialized");const t=this.mg.players().sort(((t,e)=>e.numTilesOwned()-t.numTilesOwned()));if(0===t.length)return;const e=t[0],i=(this.mg.ticks()-this.mg.config().numSpawnPhaseTurns())/10,s=this.mg.numLandTiles()-this.mg.numTilesWithFallout();(e.numTilesOwned()/s*100>this.mg.config().percentageTilesOwnedToWin()||void 0!==this.mg.config().gameConfig().maxTimerValue&&i-60*this.mg.config().gameConfig().maxTimerValue>=0)&&(this.mg.setWinner(e,this.mg.stats().stats()),console.log(`${e.name()} has won the game`),this.active=!1)}checkWinnerTeam(){if(null===this.mg)throw new Error("Not initialized");const t=new Map;for(const e of this.mg.players()){const i=e.team();null!==i&&t.set(i,(t.get(i)??0)+e.numTilesOwned())}const e=Array.from(t.entries()).sort(((t,e)=>e[1]-t[1]));if(0===e.length)return;const i=e[0],s=(this.mg.ticks()-this.mg.config().numSpawnPhaseTurns())/10,r=this.mg.numLandTiles()-this.mg.numTilesWithFallout();if(i[1]/r*100>this.mg.config().percentageTilesOwnedToWin()||void 0!==this.mg.config().gameConfig().maxTimerValue&&s-60*this.mg.config().gameConfig().maxTimerValue>=0){if(i[0]===p)return;this.mg.setWinner(i[0],this.mg.stats().stats()),console.log(`${i[0]} has won the game`),this.active=!1}}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class wi{constructor(t,e,i,s,r){this.mg=t,this.requestor_=e,this.recipient_=i,this.createdAt_=s,this.id_=r,this.extensionRequestedRequestor_=!1,this.extensionRequestedRecipient_=!1,this.expiresAt_=s+t.config().allianceDuration()}other(t){return this.requestor_===t?this.recipient_:this.requestor_}requestor(){return this.requestor_}recipient(){return this.recipient_}createdAt(){return this.createdAt_}expire(){this.mg.expireAlliance(this)}addExtensionRequest(t){this.requestor_===t?this.extensionRequestedRequestor_=!0:this.recipient_===t&&(this.extensionRequestedRecipient_=!0)}bothAgreedToExtend(){return this.extensionRequestedRequestor_&&this.extensionRequestedRecipient_}onlyOneAgreedToExtend(){return this.extensionRequestedRequestor_!==this.extensionRequestedRecipient_}id(){return this.id_}extend(){this.extensionRequestedRequestor_=!1,this.extensionRequestedRecipient_=!1,this.expiresAt_=this.mg.ticks()+this.mg.config().allianceDuration()}expiresAt(){return this.expiresAt_}}class bi{constructor(t,e,i,s){this.requestor_=t,this.recipient_=e,this.tickCreated=i,this.game=s,this.status_="pending"}status(){return this.status_}requestor(){return this.requestor_}recipient(){return this.recipient_}createdAt(){return this.tickCreated}accept(){this.status_="accepted",this.game.acceptAllianceRequest(this)}reject(){this.status_="rejected",this.game.rejectAllianceRequest(this)}toUpdate(){return{type:pe.AllianceRequest,requestorID:this.requestor_.smallID(),recipientID:this.recipient_.smallID(),createdAt:this.tickCreated}}}var Ti=i(16720);const Mi=new Ti.mV({...Ti.zp.build(),...Ti.I0,...(0,Ti.rp)(),...(0,Ti.R)(),...(0,Ti.pX)(),...(0,Ti.uA)()}),vi=/^[a-zA-Z0-9_[\] üêàüçÄ√º√ú]+$/u,_i=["NicePeopleOnly","BeKindPlz","LearningManners","StayClassy","BeNicer","NeedHugs","MakeFriends"];class Ai{constructor(t,e,i,s,r,n,a){this._id=t,this._target=e,this._attacker=i,this._troops=s,this._sourceTile=r,this._border=n,this._mg=a,this._isActive=!0,this._borderSize=0,this._retreating=!1,this._retreated=!1}sourceTile(){return this._sourceTile}target(){return this._target}attacker(){return this._attacker}troops(){return this._troops}setTroops(t){this._troops=t}isActive(){return this._isActive}id(){return this._id}delete(){this._target.isPlayer()&&(this._target._incomingAttacks=this._target._incomingAttacks.filter((t=>t!==this))),this._attacker._outgoingAttacks=this._attacker._outgoingAttacks.filter((t=>t!==this)),this._isActive=!1}orderRetreat(){this._retreating=!0}executeRetreat(){this._retreated=!0}retreating(){return this._retreating}retreated(){return this._retreated}borderSize(){return this._borderSize}clearBorder(){this._borderSize=0,this._border.clear()}addBorderTile(t){this._border.has(t)||(this._borderSize+=1,this._border.add(t))}removeBorderTile(t){this._border.has(t)&&(this._borderSize-=1,this._border.delete(t))}averagePosition(){if(0===this._borderSize){if(null===this.sourceTile())return null;const t=this.sourceTile();return new D(this._mg.map().x(t),this._mg.map().y(t))}let t=0,e=0;for(const i of this._border)t+=this._mg.map().x(i),e+=this._mg.map().y(i);return t/=this._borderSize,e/=this._borderSize,new D(t,e)}}class Si{constructor(t,e,i,s,r,n={}){switch(this._type=t,this.mg=e,this._tile=i,this._id=s,this._owner=r,this._active=!0,this._retreating=!1,this._targetedBySAM=!1,this._reachedTarget=!1,this._lastOwner=null,this._missileTimerQueue=[],this._hasTrainStation=!1,this._level=1,this._targetable=!0,this._trajectoryIndex=0,this._lastTile=i,this._health=L(this.mg.unitInfo(t).maxHealth??1),this._targetTile="targetTile"in n?n.targetTile??void 0:void 0,this._trajectory="trajectory"in n?n.trajectory??[]:[],this._troops="troops"in n?n.troops??0:0,this._lastSetSafeFromPirates="lastSetSafeFromPirates"in n?n.lastSetSafeFromPirates??0:0,this._patrolTile="patrolTile"in n?n.patrolTile??void 0:void 0,this._targetUnit="targetUnit"in n?n.targetUnit??void 0:void 0,this._loaded="loaded"in n?n.loaded??void 0:void 0,this._trainType="trainType"in n?n.trainType:void 0,this._type){case b.Warship:case b.Port:case b.MissileSilo:case b.DefensePost:case b.SAMLauncher:case b.City:this.mg.stats().unitBuild(r,this._type)}}setTargetable(t){this._targetable!==t&&(this._targetable=t,this.mg.addUpdate(this.toUpdate()))}isTargetable(){return this._targetable}setPatrolTile(t){this._patrolTile=t}patrolTile(){return this._patrolTile}isUnit(){return!0}touch(){this.mg.addUpdate(this.toUpdate())}setTileTarget(t){this._targetTile=t}tileTarget(){return this._targetTile}id(){return this._id}toUpdate(){return{type:pe.Unit,unitType:this._type,id:this._id,troops:this._troops,ownerID:this._owner.smallID(),lastOwnerID:this._lastOwner?.smallID(),isActive:this._active,reachedTarget:this._reachedTarget,retreating:this._retreating,pos:this._tile,targetable:this._targetable,lastPos:this._lastTile,health:this.hasHealth()?Number(this._health):void 0,constructionType:this._constructionType,targetUnitId:this._targetUnit?.id()??void 0,targetTile:this.targetTile()??void 0,missileTimerQueue:this._missileTimerQueue,level:this.level(),hasTrainStation:this._hasTrainStation,trainType:this._trainType,loaded:this._loaded}}type(){return this._type}lastTile(){return this._lastTile}move(t){if(null===t)throw new Error("tile cannot be null");this._lastTile=this._tile,this._tile=t,this.mg.updateUnitTile(this),this.mg.addUpdate(this.toUpdate())}setTroops(t){this._troops=t}troops(){return this._troops}health(){return Number(this._health)}hasHealth(){return void 0!==this.info().maxHealth}tile(){return this._tile}owner(){return this._owner}info(){return this.mg.unitInfo(this._type)}setOwner(t){switch(this._type){case b.Warship:case b.Port:case b.MissileSilo:case b.DefensePost:case b.SAMLauncher:case b.City:this.mg.stats().unitCapture(t,this._type),this.mg.stats().unitLose(this._owner,this._type)}this._lastOwner=this._owner,this._lastOwner._units=this._lastOwner._units.filter((t=>t!==this)),this._owner=t,this._owner._units.push(this),this.mg.addUpdate(this.toUpdate()),this.mg.displayMessage(`Your ${this.type()} was captured by ${t.displayName()}`,S.UNIT_CAPTURED_BY_ENEMY,this._lastOwner.id()),this.mg.displayMessage(`Captured ${this.type()} from ${this._lastOwner.displayName()}`,S.CAPTURED_ENEMY_UNIT,t.id())}modifyHealth(t,e){var i;this._health=q((i=this._health+L(t))>0n?i:0n,L(this.info().maxHealth??1)),0n===this._health&&this.delete(!0,e)}delete(t,e){if(!this.isActive())throw new Error(`cannot delete ${this} not active`);if(this._owner._units=this._owner._units.filter((t=>t!==this)),this._active=!1,this.mg.addUpdate(this.toUpdate()),this.mg.removeUnit(this),!1!==t&&this._type!==b.MIRVWarhead&&this.mg.displayMessage(`Your ${this._type} was destroyed`,S.UNIT_DESTROYED,this.owner().id()),void 0!==e)switch(this._type){case b.TransportShip:this.mg.stats().boatDestroyTroops(e,this._owner,this._troops);break;case b.TradeShip:this.mg.stats().boatDestroyTrade(e,this._owner);break;case b.City:case b.DefensePost:case b.MissileSilo:case b.Port:case b.SAMLauncher:case b.Warship:case b.Factory:this.mg.stats().unitDestroy(e,this._type),this.mg.stats().unitLose(this.owner(),this._type)}}isActive(){return this._active}retreating(){return this._retreating}orderBoatRetreat(){if(this.type()!==b.TransportShip)throw new Error(`Cannot retreat ${this.type()}`);this._retreating=!0}constructionType(){if(this.type()!==b.Construction)throw new Error(`Cannot get construction type on ${this.type()}`);return this._constructionType??null}setConstructionType(t){if(this.type()!==b.Construction)throw new Error(`Cannot set construction type on ${this.type()}`);this._constructionType=t,this.mg.addUpdate(this.toUpdate())}hash(){return this.tile()+j(this.type())*this._id}toString(){return`Unit:${this._type},owner:${this.owner().name()}`}launch(){this._missileTimerQueue.push(this.mg.ticks()),this.mg.addUpdate(this.toUpdate())}ticksLeftInCooldown(){return this._missileTimerQueue[0]}isInCooldown(){return this._missileTimerQueue.length===this._level}missileTimerQueue(){return this._missileTimerQueue}reloadMissile(){this._missileTimerQueue.shift(),this.mg.addUpdate(this.toUpdate())}setTargetTile(t){this._targetTile=t}targetTile(){return this._targetTile}setTrajectoryIndex(t){const e=this._trajectory.length-1;this._trajectoryIndex=t<0?0:t>e?e:t}trajectoryIndex(){return this._trajectoryIndex}trajectory(){return this._trajectory}setTargetUnit(t){this._targetUnit=t}targetUnit(){return this._targetUnit}setTargetedBySAM(t){this._targetedBySAM=t}targetedBySAM(){return this._targetedBySAM}setReachedTarget(){this._reachedTarget=!0}reachedTarget(){return this._reachedTarget}setSafeFromPirates(){this._lastSetSafeFromPirates=this.mg.ticks()}isSafeFromPirates(){return this.mg.ticks()-this._lastSetSafeFromPirates<this.mg.config().safeFromPiratesCooldownMax()}level(){return this._level}setTrainStation(t){this._hasTrainStation=t,this.mg.addUpdate(this.toUpdate())}hasTrainStation(){return this._hasTrainStation}increaseLevel(){this._level++,[b.MissileSilo,b.SAMLauncher].includes(this.type())&&this._missileTimerQueue.push(this.mg.ticks()),this.mg.addUpdate(this.toUpdate())}decreaseLevel(t){this._level--,[b.MissileSilo,b.SAMLauncher].includes(this.type())&&this._missileTimerQueue.pop(),this._level<=0?this.delete(!0,t):this.mg.addUpdate(this.toUpdate())}trainType(){return this._trainType}isLoaded(){return this._loaded}setLoaded(t){this._loaded!==t&&(this._loaded=t,this.mg.addUpdate(this.toUpdate()))}}class ki{constructor(t,e){this.recipient=t,this.tick=e}}class Ei{constructor(t,e,i,s,r){var n;this.mg=t,this._smallID=e,this.playerInfo=i,this._team=r,this._lastTileChange=0,this.markedTraitorTick=-1,this.embargoes=new Map,this._borderTiles=new Set,this._units=[],this._tiles=new Set,this.pastOutgoingAllianceRequests=[],this._expiredAlliances=[],this.targets_=[],this.outgoingEmojis_=[],this.sentDonations=[],this.relations=new Map,this.lastDeleteUnitTick=-1,this._incomingAttacks=[],this._outgoingAttacks=[],this._outgoingLandAttacks=[],this._hasSpawned=!1,this._isDisconnected=!1,this.numUnitsConstructed={},this._name=(n=i.name,Array.from(n).filter((t=>vi.test(t))).join("").slice(0,27).padEnd(3,"x")),this._troops=L(s),this._gold=0n,this._displayName=this._name,this._pseudo_random=new J(j(this.playerInfo.id))}toUpdate(){const t=this.outgoingAllianceRequests().map((t=>t.recipient().id())),e=this.mg.stats().getPlayerStats(this);return{type:pe.Player,clientID:this.clientID(),name:this.name(),displayName:this.displayName(),id:this.id(),team:this.team()??void 0,smallID:this.smallID(),playerType:this.type(),isAlive:this.isAlive(),isDisconnected:this.isDisconnected(),tilesOwned:this.numTilesOwned(),gold:this._gold,troops:this.troops(),allies:this.alliances().map((t=>t.other(this).smallID())),embargoes:new Set([...this.embargoes.keys()].map((t=>t.toString()))),isTraitor:this.isTraitor(),traitorRemainingTicks:this.getTraitorRemainingTicks(),targets:this.targets().map((t=>t.smallID())),outgoingEmojis:this.outgoingEmojis(),outgoingAttacks:this._outgoingAttacks.map((t=>({attackerID:t.attacker().smallID(),targetID:t.target().smallID(),troops:t.troops(),id:t.id(),retreating:t.retreating()}))),incomingAttacks:this._incomingAttacks.map((t=>({attackerID:t.attacker().smallID(),targetID:t.target().smallID(),troops:t.troops(),id:t.id(),retreating:t.retreating()}))),outgoingAllianceRequests:t,alliances:this.alliances().map((t=>({id:t.id(),other:t.other(this).id(),createdAt:t.createdAt(),expiresAt:t.expiresAt()}))),hasSpawned:this.hasSpawned(),betrayals:e?.betrayals,lastDeleteUnitTick:this.lastDeleteUnitTick}}smallID(){return this._smallID}name(){return this._name}displayName(){return this._displayName}clientID(){return this.playerInfo.clientID}id(){return this.playerInfo.id}type(){return this.playerInfo.playerType}clan(){return this.playerInfo.clan}units(...t){if(0===t.length)return this._units;const e=new Set(t);return this._units.filter((t=>e.has(t.type())))}recordUnitConstructed(t){void 0!==this.numUnitsConstructed[t]?this.numUnitsConstructed[t]++:this.numUnitsConstructed[t]=1}unitsConstructed(t){const e=this.numUnitsConstructed[t]??0;let i=0;for(const e of this._units)e.type()===b.Construction&&e.constructionType()===t&&i++;return i+e}unitCount(t){let e=0;for(const i of this._units)i.type()===t&&(e+=i.level());return e}unitsOwned(t){let e=0;for(const i of this._units)i.type()!==t?i.type()===b.Construction&&i.constructionType()===t&&e++:e+=i.level();return e}sharesBorderWith(t){for(const e of this._borderTiles)for(const i of this.mg.map().neighbors(e))if(this.mg.map().ownerID(i)===t.smallID())return!0;return!1}numTilesOwned(){return this._tiles.size}tiles(){return new Set(this._tiles.values())}borderTiles(){return this._borderTiles}neighbors(){const t=new Set;for(const e of this.borderTiles())for(const i of this.mg.map().neighbors(e))if(this.mg.map().isLand(i)){const e=this.mg.map().ownerID(i);e!==this.smallID()&&t.add(this.mg.playerBySmallID(e))}return Array.from(t)}isPlayer(){return!0}setTroops(t){this._troops=L(t)}conquer(t){this.mg.conquer(this,t)}orderRetreat(t){const e=this._outgoingAttacks.filter((e=>e.id()===t));e&&e[0]?e[0].orderRetreat():console.warn(`Didn't find outgoing attack with id ${t}`)}executeRetreat(t){const e=this._outgoingAttacks.filter((e=>e.id()===t));e&&e[0]&&e[0].executeRetreat()}relinquish(t){if(this.mg.owner(t)!==this)throw new Error("Cannot relinquish tile not owned by this player");this.mg.relinquish(t)}info(){return this.playerInfo}isAlive(){return this._tiles.size>0}hasSpawned(){return this._hasSpawned}setHasSpawned(t){this._hasSpawned=t}incomingAllianceRequests(){return this.mg.allianceRequests.filter((t=>t.recipient()===this))}outgoingAllianceRequests(){return this.mg.allianceRequests.filter((t=>t.requestor()===this))}alliances(){return this.mg.alliances_.filter((t=>t.requestor()===this||t.recipient()===this))}expiredAlliances(){return[...this._expiredAlliances]}allies(){return this.alliances().map((t=>t.other(this)))}isAlliedWith(t){return t!==this&&null!==this.allianceWith(t)}allianceWith(t){return t===this?null:this.alliances().find((e=>e.recipient()===t||e.requestor()===t))??null}canSendAllianceRequest(t){if(t===this)return!1;if(this.isFriendly(t)||!this.isAlive())return!1;if(this.outgoingAllianceRequests().some((e=>e.recipient()===t)))return!1;const e=this.pastOutgoingAllianceRequests.filter((e=>e.recipient()===t)).sort(((t,e)=>e.createdAt()-t.createdAt()));return 0===e.length||this.mg.ticks()-e[0].createdAt()>=this.mg.config().allianceRequestCooldown()}breakAlliance(t){this.mg.breakAlliance(this,t)}isTraitor(){return this.getTraitorRemainingTicks()>0}getTraitorRemainingTicks(){if(this.markedTraitorTick<0)return 0;const t=this.mg.ticks()-this.markedTraitorTick,e=this.mg.config().traitorDuration()-t;return e>0?e:0}markTraitor(){this.markedTraitorTick=this.mg.ticks(),this.mg.stats().betray(this)}createAllianceRequest(t){if(this.isAlliedWith(t))throw new Error("cannot create alliance request, already allies");return this.mg.createAllianceRequest(this,t)}relation(t){if(t===this)throw new Error(`cannot get relation with self: ${this}`);const e=this.relations.get(t)??0;return this.relationFromValue(e)}relationFromValue(t){return t<-50?v.Hostile:t<0?v.Distrustful:t<50?v.Neutral:v.Friendly}allRelationsSorted(){return Array.from(this.relations,(([t,e])=>({player:t,relation:e}))).sort(((t,e)=>t.relation-e.relation)).map((t=>({player:t.player,relation:this.relationFromValue(t.relation)})))}updateRelation(t,e){if(t===this)throw new Error(`cannot update relation with self: ${this}`);const i=P((this.relations.get(t)??0)+e,-100,100);this.relations.set(t,i)}decayRelations(){this.relations.forEach(((t,e)=>{t+=-1*Math.sign(t)*.05,Math.abs(t)<.1&&(t=0),this.relations.set(e,t)}))}canTarget(t){if(this===t)return!1;if(this.isFriendly(t))return!1;for(const t of this.targets_)if(this.mg.ticks()-t.tick<this.mg.config().targetCooldown())return!1;return!0}target(t){this.targets_.push({tick:this.mg.ticks(),target:t}),this.mg.target(this,t)}targets(){return this.targets_.filter((t=>this.mg.ticks()-t.tick<this.mg.config().targetDuration())).map((t=>t.target))}transitiveTargets(){const t=this.alliances().map((t=>t.other(this))).flatMap((t=>t.targets()));return t.push(...this.targets()),[...new Set(t)]}sendEmoji(t,e){if(t===this)throw Error(`Cannot send emoji to oneself: ${this}`);const i={message:e,senderID:this.smallID(),recipientID:t===s?t:t.smallID(),createdAt:this.mg.ticks()};this.outgoingEmojis_.push(i),this.mg.sendEmojiUpdate(i)}outgoingEmojis(){return this.outgoingEmojis_.filter((t=>this.mg.ticks()-t.createdAt<this.mg.config().emojiMessageDuration())).sort(((t,e)=>e.createdAt-t.createdAt))}canSendEmoji(t){if(t===this)return!1;const e=t===s?s:t.smallID(),i=this.outgoingEmojis_.filter((t=>t.recipientID===e));for(const t of i)if(this.mg.ticks()-t.createdAt<this.mg.config().emojiMessageCooldown())return!1;return!0}canDonateGold(t){if(!this.isAlive()||!t.isAlive()||!this.isFriendly(t))return!1;if(t.type()===A.Human&&!1===this.mg.config().donateGold())return!1;for(const e of this.sentDonations)if(e.recipient===t&&this.mg.ticks()-e.tick<this.mg.config().donateCooldown())return!1;return!0}canDonateTroops(t){if(!this.isAlive()||!t.isAlive()||!this.isFriendly(t))return!1;if(t.type()===A.Human&&!1===this.mg.config().donateTroops())return!1;for(const e of this.sentDonations)if(e.recipient===t&&this.mg.ticks()-e.tick<this.mg.config().donateCooldown())return!1;return!0}donateTroops(t,e){if(e<=0)return!1;const i=this.removeTroops(e);return 0!==i&&(t.addTroops(i),this.sentDonations.push(new ki(t,this.mg.ticks())),this.mg.displayMessage(`Sent ${Wt(e)} troops to ${t.name()}`,S.SENT_TROOPS_TO_PLAYER,this.id()),this.mg.displayMessage(`Received ${Wt(e)} troops from ${this.name()}`,S.RECEIVED_TROOPS_FROM_PLAYER,t.id()),!0)}donateGold(t,e){if(e<=0n)return!1;const i=this.removeGold(e);return 0n!==i&&(t.addGold(i),this.sentDonations.push(new ki(t,this.mg.ticks())),this.mg.displayMessage(`Sent ${Ht(e)} gold to ${t.name()}`,S.SENT_GOLD_TO_PLAYER,this.id()),this.mg.displayMessage(`Received ${Ht(e)} gold from ${this.name()}`,S.RECEIVED_GOLD_FROM_PLAYER,t.id(),e),!0)}canDeleteUnit(){return this.mg.ticks()-this.lastDeleteUnitTick>=this.mg.config().deleteUnitCooldown()}recordDeleteUnit(){this.lastDeleteUnitTick=this.mg.ticks()}hasEmbargoAgainst(t){return this.embargoes.has(t.id())}canTrade(t){return!(t.hasEmbargoAgainst(this)||this.hasEmbargoAgainst(t))&&t.id()!==this.id()}getEmbargoes(){return[...this.embargoes.values()]}addEmbargo(t,e){const i=this.embargoes.get(t.id());(void 0===i||i.isTemporary)&&(this.mg.addUpdate({type:pe.EmbargoEvent,event:"start",playerID:this.smallID(),embargoedID:t.smallID()}),this.embargoes.set(t.id(),{createdAt:this.mg.ticks(),isTemporary:e,target:t}))}stopEmbargo(t){this.embargoes.delete(t.id()),this.mg.addUpdate({type:pe.EmbargoEvent,event:"stop",playerID:this.smallID(),embargoedID:t.smallID()})}endTemporaryEmbargo(t){const e=this.embargoes.get(t.id());(void 0===e||e.isTemporary)&&this.stopEmbargo(t)}tradingPartners(){return this.mg.players().filter((t=>t!==this&&this.canTrade(t)))}team(){return this._team}isOnSameTeam(t){return t!==this&&null!==this.team()&&null!==t.team()&&this.team()!==p&&t.team()!==p&&this._team===t.team()}isFriendly(t){return!t.isDisconnected()&&(this.isOnSameTeam(t)||this.isAlliedWith(t))}gold(){return this._gold}addGold(t,e){this._gold+=t,e&&this.mg.addUpdate({type:pe.BonusEvent,player:this.id(),tile:e,gold:Number(t),troops:0})}removeGold(t){if(t<=0n)return 0n;const e=q(this._gold,t);return this._gold-=e,e}troops(){return Number(this._troops)}addTroops(t){t<0?this.removeTroops(-1*t):this._troops+=L(t)}removeTroops(t){if(t<=0)return 0;const e=q(this._troops,L(t));return this._troops-=e,Number(e)}captureUnit(t){if(t.owner()===this)throw new Error(`Cannot capture unit, ${this} already owns ${t}`);t.setOwner(this)}buildUnit(t,e,i){if(this.mg.config().isUnitDisabled(t))throw new Error(`Attempted to build disabled unit ${t} at tile ${e} by player ${this.name()}`);const s=this.mg.unitInfo(t).cost(this),r=new Si(t,this.mg,e,this.mg.nextUnitID(),this,i);return this._units.push(r),this.recordUnitConstructed(t),this.removeGold(s),this.removeTroops("troops"in i?i.troops??0:0),this.mg.addUpdate(r.toUpdate()),this.mg.addUnit(r),r}findUnitToUpgrade(t,e){const i=this.mg.config().structureMinDist(),s=this.mg.nearbyUnits(e,i,t).sort(((t,e)=>t.distSquared-e.distSquared));if(0===s.length)return!1;const r=s[0].unit;return!!this.canUpgradeUnit(r.type())&&r}canUpgradeUnit(t){return!(!this.mg.config().unitInfo(t).upgradable||this.mg.config().isUnitDisabled(t)||this._gold<this.mg.config().unitInfo(t).cost(this))}upgradeUnit(t){const e=this.mg.unitInfo(t.type()).cost(this);this.removeGold(e),t.increaseLevel(),this.recordUnitConstructed(t.type())}buildableUnits(t){const e=null!==t?this.validStructureSpawnTiles(t):[];return Object.values(b).map((i=>{let s=!1;if(!this.mg.inSpawnPhase()){const e=null!==t&&this.findUnitToUpgrade(i,t);!1!==e&&(s=e.id())}return{type:i,canBuild:!this.mg.inSpawnPhase()&&null!==t&&this.canBuild(i,t,e),canUpgrade:s,cost:this.mg.config().unitInfo(i).cost(this)}}))}canBuild(t,e,i=null){if(this.mg.config().isUnitDisabled(t))return!1;const s=this.mg.unitInfo(t).cost(this);if(!this.isAlive()||this.gold()<s)return!1;switch(t){case b.MIRV:return!!this.mg.hasOwner(e)&&this.nukeSpawn(e);case b.AtomBomb:case b.HydrogenBomb:return this.nukeSpawn(e);case b.MIRVWarhead:return e;case b.Port:return this.portSpawn(e,i);case b.Warship:return this.warshipSpawn(e);case b.Shell:case b.SAMMissile:return e;case b.TransportShip:return function(t,e,i){if(e.unitCount(b.TransportShip)>=t.config().boatMaxNumber())return!1;const s=ni(t,i);if(null===s)return!1;const r=t.owner(i);if(r===e)return!1;if(r.isPlayer()&&e.isFriendly(r))return!1;if(t.isOceanShore(s)){let n=!1;for(const i of e.borderTiles())if(t.isOceanShore(i)){n=!0;break}let a=!1;if(t.hasOwner(i)){for(const e of r.borderTiles())if(t.isOceanShore(e)){a=!0;break}}else a=!0;return!(!n||!a)&&ri(t,e,s)}const n=t.bfs(s,oe(ae(s,300),((e,i)=>t.isLake(i)||t.isShore(i)))),a=Array.from(n).sort(((e,i)=>t.manhattanDist(s,e)-t.manhattanDist(s,i)));for(const i of a)if(t.owner(i)===e)return ri(t,e,i);return!1}(this.mg,this,e);case b.TradeShip:return this.tradeShipSpawn(e);case b.Train:return this.landBasedUnitSpawn(e);case b.MissileSilo:case b.DefensePost:case b.SAMLauncher:case b.City:case b.Factory:case b.Construction:return this.landBasedStructureSpawn(e,i);default:F(t)}}nukeSpawn(t){const e=this.mg.owner(t);if(e.isPlayer()&&this.isOnSameTeam(e))return!1;const i=this.units(b.MissileSilo).filter((t=>!t.isInCooldown())).sort(R(this.mg,t));return 0!==i.length&&i[0].tile()}portSpawn(t,e){const i=Array.from(this.mg.bfs(t,ae(t,this.mg.config().radiusPortSpawn()))).filter((t=>this.mg.owner(t)===this&&this.mg.isOceanShore(t))).sort(((e,i)=>this.mg.manhattanDist(e,t)-this.mg.manhattanDist(i,t))),s=new Set(e??this.validStructureSpawnTiles(t));for(const t of i)if(s.has(t))return t;return!1}warshipSpawn(t){if(!this.mg.isOcean(t))return!1;const e=this.units(b.Port).sort(((e,i)=>this.mg.manhattanDist(e.tile(),t)-this.mg.manhattanDist(i.tile(),t)));return 0!==e.length&&e[0].tile()}landBasedUnitSpawn(t){return!!this.mg.isLand(t)&&t}landBasedStructureSpawn(t,e=null){const i=e??this.validStructureSpawnTiles(t);return 0!==i.length&&i[0]}validStructureSpawnTiles(t){if(this.mg.owner(t)!==this)return[];const e=Object.values(b).filter((t=>this.mg.config().unitInfo(t).territoryBound)),i=this.mg.nearbyUnits(t,30,e),s=this.mg.bfs(t,((e,i)=>this.mg.euclideanDistSquared(t,i)<225&&e.ownerID(i)===this.smallID())),r=new Set(s),n=this.mg.config().structureMinDist()**2;for(const t of s)for(const{unit:e}of i)if(this.mg.euclideanDistSquared(e.tile(),t)<n){r.delete(t);break}const a=Array.from(r);return a.sort(((e,i)=>this.mg.euclideanDistSquared(e,t)-this.mg.euclideanDistSquared(i,t))),a}tradeShipSpawn(t){const e=this.units(b.Port).filter((e=>e.tile()===t));return 0!==e.length&&e[0].tile()}lastTileChange(){return this._lastTileChange}isDisconnected(){return this._isDisconnected}markDisconnected(t){this._isDisconnected=t}hash(){return j(this.id())*(this.troops()+this.numTilesOwned())+this._units.reduce(((t,e)=>t+e.hash()),0)}toString(){return`Player:{name:${this.info().name},clientID:${this.info().clientID},isAlive:${this.isAlive()},troops:${this._troops},numTileOwned:${this.numTilesOwned()}}]`}playerProfile(){return{relations:Object.fromEntries(this.allRelationsSorted().map((({player:t,relation:e})=>[t.smallID(),e]))),alliances:this.alliances().map((t=>t.other(this).smallID()))}}createAttack(t,e,i,s){const r=new Ai(this._pseudo_random.nextID(),t,this,e,i,s,this.mg);return this._outgoingAttacks.push(r),t.isPlayer()&&t._incomingAttacks.push(r),r}outgoingAttacks(){return this._outgoingAttacks}incomingAttacks(){return this._incomingAttacks}canAttack(t){if(this.mg.hasOwner(t)&&this.mg.config().numSpawnPhaseTurns()+this.mg.config().spawnImmunityDuration()>this.mg.ticks())return!1;if(this.mg.owner(t)===this)return!1;const e=this.mg.owner(t);if(e.isPlayer()&&this.isFriendly(e))return!1;if(!this.mg.isLand(t))return!1;if(this.mg.hasOwner(t))return this.sharesBorderWith(e);for(const e of this.mg.bfs(t,oe(((t,e)=>!t.hasOwner(e)&&t.isLand(e)),ae(t,200))))for(const t of this.mg.neighbors(e))if(this.mg.owner(t)===this)return!0;return!1}bestTransportShipSpawn(t){return function(t,e,i){const s=ni(t,i);if(null===s)return!1;const r=function(t,e,i){let s=1/0,r=1/0,n=1/0,a=-1/0,o=-1/0,h=null;const l={minX:null,minY:null,maxX:null,maxY:null},c=Array.from(e.borderTiles()).filter((e=>t.isShore(e)));for(const e of c){const c=t.manhattanDist(e,i),u=t.cell(e);c<s&&(s=c,h=e),u.x<r?(r=u.x,l.minX=e):u.y<n?(n=u.y,l.minY=e):u.x>a?(a=u.x,l.maxX=e):u.y>o&&(o=u.y,l.maxY=e)}const u=Math.max(10,Math.ceil(c.length/50)),d=c.filter(((t,e)=>e%u===0));return[h,l.minX,l.minY,l.maxX,l.maxY,...d].filter(Boolean)}(t,e,s),n=new Be(t,t.miniMap(),r,s,1e6,1),a=n.compute();if(a!==fe.Completed)return console.warn(`bestShoreDeploymentSource: path not found: ${a}`),!1;const o=n.reconstructPath();if(0===o.length)return!1;const h=o[0],l=t.neighbors(h).filter((i=>t.isShore(i)&&t.owner(i)===e));return 0!==l.length&&l[0]}(this.mg,this,t)}tradingPorts(t){const e=this.mg.players().filter((e=>e!==t.owner()&&e.canTrade(t.owner()))).flatMap((t=>t.units(b.Port))).sort(((e,i)=>this.mg.manhattanDist(t.tile(),e.tile())-this.mg.manhattanDist(t.tile(),i.tile()))),i=[];for(const[s,r]of e.entries()){const n=new Array(r.level()).fill(r);i.push(...n),s<this.mg.config().proximityBonusPortsNb(e.length)&&i.push(...n),t.owner().isFriendly(r.owner())&&i.push(...n)}return i}}class Ii{constructor(t){this.railRoad=t,this.active=!0,this.headIndex=0,this.tailIndex=0,this.increment=3,this.railTiles=[],this.tailIndex=t.tiles.length}isActive(){return this.active}init(t,e){this.mg=t;const i=this.railRoad.tiles;this.railTiles.push({tile:i[0],railType:i.length>0?this.computeExtremityDirection(i[0],i[1]):me.VERTICAL});for(let t=1;t<i.length-1;t++){const e=this.computeDirection(i[t-1],i[t],i[t+1]);this.railTiles.push({tile:i[t],railType:e})}this.railTiles.push({tile:i[i.length-1],railType:i.length>0?this.computeExtremityDirection(i[i.length-1],i[i.length-2]):me.VERTICAL})}computeExtremityDirection(t,e){const i=this.mg.x(t),s=this.mg.y(t),r=this.mg.x(e)-i,n=this.mg.y(e)-s;return 0===r&&0===n||0===r?me.VERTICAL:0===n?me.HORIZONTAL:me.VERTICAL}computeDirection(t,e,i){if(null===this.mg)throw new Error("Not initialized");const s=this.mg.x(t),r=this.mg.y(t),n=this.mg.x(e),a=this.mg.y(e),o=n-s,h=a-r,l=this.mg.x(i)-n,c=this.mg.y(i)-a;if(o===l&&h===c){if(0!==o)return me.HORIZONTAL;if(0!==h)return me.VERTICAL}if(0===o&&0!==l||0!==o&&0===l){if(0===o&&1===l&&-1===h)return me.BOTTOM_RIGHT;if(0===o&&-1===l&&-1===h)return me.BOTTOM_LEFT;if(0===o&&1===l&&1===h)return me.TOP_RIGHT;if(0===o&&-1===l&&1===h)return me.TOP_LEFT;if(1===o&&0===l&&-1===c)return me.TOP_LEFT;if(-1===o&&0===l&&-1===c)return me.TOP_RIGHT;if(1===o&&0===l&&1===c)return me.BOTTOM_LEFT;if(-1===o&&0===l&&1===c)return me.BOTTOM_RIGHT}return console.warn(`Invalid rail segment: ${o}:${h}, ${l}:${c}`),me.VERTICAL}tick(t){if(null===this.mg)throw new Error("Not initialized");if(!this.activeSourceOrDestination())return void(this.active=!1);if(this.headIndex>this.tailIndex)return void this.constructionComplete();let e;this.tailIndex-this.headIndex<=2*this.increment?(e=this.railTiles.slice(this.headIndex,this.tailIndex),this.constructionComplete()):(e=this.railTiles.slice(this.headIndex,this.headIndex+this.increment),e=e.concat(this.railTiles.slice(this.tailIndex-this.increment,this.tailIndex)),this.headIndex+=this.increment,this.tailIndex-=this.increment),e&&this.mg.addUpdate({type:pe.RailroadEvent,isActive:!0,railTiles:e})}activeDuringSpawnPhase(){return!1}activeSourceOrDestination(){return this.railRoad.from.isActive()&&this.railRoad.to.isActive()}constructionComplete(){this.redrawBuildings(),this.active=!1}redrawBuildings(){this.railRoad.from.unit.isActive()&&this.railRoad.from.unit.touch(),this.railRoad.to.unit.isActive()&&this.railRoad.to.unit.touch()}}class Di{constructor(){this.stations=new Set}addStation(t){this.stations.add(t)}removeStation(t){this.stations.delete(t)}findStation(t){for(const e of this.stations)if(e.unit===t)return e;return null}getAll(){return this.stations}}class xi{constructor(t){this.game=t}findTilePath(t,e){const i=new Be(this.game.map(),this.game.miniMap(),t,e,5e3,20,!1,3);return i.compute()===fe.Completed?i.reconstructPath():[]}findStationsPath(t,e){const i=new je(t,e,5e3,20,new Me(this.game));return i.compute()===fe.Completed?i.reconstructPath():[]}}class Ci{constructor(t,e,i){this.game=t,this.stationManager=e,this.pathService=i,this.maxConnectionDistance=4}connectStation(t){this.stationManager.addStation(t),this.connectToNearbyStations(t)}removeStation(t){const e=this.stationManager.findStation(t);if(!e)return;const i=e.neighbors();this.disconnectFromNetwork(e),this.stationManager.removeStation(e);const s=e.getCluster();if(s){if(1===i.length)s.removeStation(e);else if(i.length>1)for(const t of i){const e=this.computeCluster(t);(new ve).addStations(e)}e.unit.setTrainStation(!1)}}findStationsPath(t,e){return this.pathService.findStationsPath(t,e)}connectToNearbyStations(t){const e=this.game.nearbyUnits(t.tile(),this.game.config().trainStationMaxRange(),[b.City,b.Factory,b.Port]),i=new Set;e.sort(((t,e)=>t.distSquared-e.distSquared));for(const s of e){if(s.unit===t.unit)continue;const e=this.stationManager.findStation(s.unit);if(!e)continue;const r=this.distanceFrom(e,t,this.maxConnectionDistance),n=e.getCluster();null!==n&&((r>this.maxConnectionDistance||-1===r)&&s.distSquared>this.game.config().trainStationMinRange()**2&&this.connect(t,e)&&(n.addStation(t),i.add(n)))}i.size>1?this.mergeClusters(i):0===i.size&&(new ve).addStation(t)}disconnectFromNetwork(t){for(const e of t.getRailroads())e.delete(this.game);t.clearRailroads();const e=t.getCluster();null!==e&&1===e.size()&&this.deleteCluster(e)}deleteCluster(t){for(const e of t.stations)e.setCluster(null);t.clear()}connect(t,e){const i=this.pathService.findTilePath(t.tile(),e.tile());if(i.length>0&&i.length<this.game.config().railroadMaxSize()){const s=new Ae(t,e,i);return this.game.addExecution(new Ii(s)),t.addRailroad(s),e.addRailroad(s),!0}return!1}distanceFrom(t,e,i){if(t===e)return 0;const s=new Set,r=[{station:t,distance:0}];for(;r.length>0;){const{station:t,distance:n}=r.shift();if(!(s.has(t)||(s.add(t),n>=i)))for(const i of t.neighbors()){if(i===e)return n+1;s.has(i)||r.push({station:i,distance:n+1})}}return-1}computeCluster(t){const e=new Set,i=[t];for(;i.length>0;){const t=i.shift();if(!e.has(t)){e.add(t);for(const s of t.neighbors())e.has(s)||i.push(s)}}return e}mergeClusters(t){const e=new ve;for(const i of t)e.merge(i)}}const Pi=z.k5(["abomb","hbomb","mirv","mirvw"]),Ri={[b.AtomBomb]:"abomb",[b.HydrogenBomb]:"hbomb",[b.MIRV]:"mirv",[b.MIRVWarhead]:"mirvw"},ji=z.k5(["trade","trans"]),Ni=z.k5(["city","defp","port","wshp","silo","saml","fact"]),Bi={[b.City]:"city",[b.DefensePost]:"defp",[b.MissileSilo]:"silo",[b.Port]:"port",[b.SAMLauncher]:"saml",[b.Warship]:"wshp",[b.Factory]:"fact"},Oi=z.vk((t=>"string"==typeof t&&/^-?\d+$/.test(t)?BigInt(t):t),z.o()),Ui=Oi.array().min(1);function Fi(t){switch(typeof t){case"bigint":return t;case"number":return BigInt(Math.floor(t))}}z.Ik({attacks:Ui.optional(),betrayals:Oi.optional(),killedAt:Oi.optional(),conquests:Oi.optional(),boats:z.jg(ji,Ui).optional(),bombs:z.jg(Pi,Ui).optional(),gold:Ui.optional(),units:z.jg(Ni,Ui).optional()}).optional();class Li{constructor(){this.data={}}getPlayerStats(t){const e=t.clientID();if(null!==e)return this.data[e]}stats(){return this.data}_makePlayerStats(t){const e=t.clientID();if(null===e)return;if(e in this.data)return this.data[e];const i={};return this.data[e]=i,i}_addAttack(t,e,i){const s=this._makePlayerStats(t);if(void 0!==s){for(s.attacks??(s.attacks=[0n]);s.attacks.length<=e;)s.attacks.push(0n);s.attacks[e]+=Fi(i)}}_addBetrayal(t,e){const i=this._makePlayerStats(t);void 0!==i&&(void 0===i.betrayals?i.betrayals=Fi(e):i.betrayals+=Fi(e))}_addBoat(t,e,i,s){var r;const n=this._makePlayerStats(t);if(void 0!==n){for(n.boats??(n.boats={[e]:[0n]}),(r=n.boats)[e]??(r[e]=[0n]);n.boats[e].length<=i;)n.boats[e].push(0n);n.boats[e][i]+=Fi(s)}}_addBomb(t,e,i,s){var r;const n=Ri[e],a=this._makePlayerStats(t);if(void 0!==a){for(a.bombs??(a.bombs={[n]:[0n]}),(r=a.bombs)[n]??(r[n]=[0n]);a.bombs[n].length<=i;)a.bombs[n].push(0n);a.bombs[n][i]+=Fi(s)}}_addGold(t,e,i){const s=this._makePlayerStats(t);if(void 0!==s){for(s.gold??(s.gold=[0n]);s.gold.length<=e;)s.gold.push(0n);s.gold[e]+=Fi(i)}}_addOtherUnit(t,e,i,s){var r;const n=Bi[e],a=this._makePlayerStats(t);if(void 0!==a){for(a.units??(a.units={[n]:[0n]}),(r=a.units)[n]??(r[n]=[0n]);a.units[n].length<=i;)a.units[n].push(0n);a.units[n][i]+=Fi(s)}}_addConquest(t){const e=this._makePlayerStats(t);void 0!==e&&(void 0===e.conquests?e.conquests=Fi(1):e.conquests+=Fi(1))}_addPlayerKilled(t,e){const i=this._makePlayerStats(t);void 0!==i&&(i.killedAt=Fi(e))}attack(t,e,i){this._addAttack(t,0,i),e.isPlayer()&&this._addAttack(e,1,i)}attackCancel(t,e,i){this._addAttack(t,2,i),this._addAttack(t,0,-i),e.isPlayer()&&this._addAttack(e,1,-i)}betray(t){this._addBetrayal(t,1)}boatSendTrade(t,e){this._addBoat(t,"trade",0,1)}boatArriveTrade(t,e,i){this._addBoat(t,"trade",1,1),this._addGold(t,2,i),this._addGold(e,2,i)}boatCapturedTrade(t,e,i){this._addBoat(t,"trade",2,1),this._addGold(t,3,i)}boatDestroyTrade(t,e){this._addBoat(t,"trade",3,1)}boatSendTroops(t,e,i){this._addBoat(t,"trans",0,1)}boatArriveTroops(t,e,i){this._addBoat(t,"trans",1,1)}boatDestroyTroops(t,e,i){this._addBoat(t,"trans",3,1)}bombLaunch(t,e,i){this._addBomb(t,i,0,1)}bombLand(t,e,i){this._addBomb(t,i,1,1)}bombIntercept(t,e,i){this._addBomb(t,e,2,i)}goldWork(t,e){this._addGold(t,0,e)}goldWar(t,e,i){this._addGold(t,1,i),this._addConquest(t)}unitBuild(t,e){this._addOtherUnit(t,e,0,1)}unitCapture(t,e){this._addOtherUnit(t,e,2,1)}unitUpgrade(t,e){this._addOtherUnit(t,e,4,1)}unitDestroy(t,e){this._addOtherUnit(t,e,1,1)}unitLose(t,e){this._addOtherUnit(t,e,3,1)}playerKilled(t,e){this._addPlayerKilled(t,e)}}class qi{constructor(){}smallID(){return 0}clientID(){return"TERRA_NULLIUS_CLIENT_ID"}id(){return null}isPlayer(){return!1}}class $i{constructor(t){this.gm=t,this.cellSize=100,this.grid=Array(Math.ceil(t.height()/this.cellSize)).fill(null).map((()=>Array(Math.ceil(t.width()/this.cellSize)).fill(null).map((()=>new Map))))}getGridCoords(t,e){return[Math.floor(t/this.cellSize),Math.floor(e/this.cellSize)]}addUnit(t){const e=t.tile(),[i,s]=this.getGridCoords(this.gm.x(e),this.gm.y(e));if(this.isValidCell(i,s)){const e=this.grid[s][i].get(t.type());void 0!==e?e.add(t):this.grid[s][i].set(t.type(),new Set([t]))}}removeUnit(t){const e=t.tile();this.removeUnitByTile(t,e)}removeUnitByTile(t,e){const[i,s]=this.getGridCoords(this.gm.x(e),this.gm.y(e));if(this.isValidCell(i,s)){const e=this.grid[s][i].get(t.type());void 0!==e&&e.delete(t)}}updateUnitCell(t){const e=t.tile(),i=t.lastTile(),[s,r]=this.getGridCoords(this.gm.x(i),this.gm.y(i)),[n,a]=this.getGridCoords(this.gm.x(e),this.gm.y(e));s===n&&r===a||(this.removeUnitByTile(t,i),this.addUnit(t))}isValidCell(t,e){return t>=0&&t<this.grid[0].length&&e>=0&&e<this.grid.length}getCellsInRange(t,e){const i=this.gm.x(t),s=this.gm.y(t),r=this.cellSize,[n,a]=this.getGridCoords(i,s);return{startGridX:Math.max(0,n-Math.ceil((e-i%r)/r)),endGridX:Math.min(this.grid[0].length-1,n+Math.ceil((e-(r-i%r))/r)),startGridY:Math.max(0,a-Math.ceil((e-s%r)/r)),endGridY:Math.min(this.grid.length-1,a+Math.ceil((e-(r-s%r))/r))}}squaredDistanceFromTile(t,e){const i=this.gm.x(e),s=this.gm.y(e),r=this.gm.x(t.tile())-i,n=this.gm.y(t.tile())-s;return r*r+n*n}nearbyUnits(t,e,i,s){const r=[],{startGridX:n,endGridX:a,startGridY:o,endGridY:h}=this.getCellsInRange(t,e),l=e*e,c=Array.isArray(i)?new Set(i):new Set([i]);for(let e=o;e<=h;e++)for(let i=n;i<=a;i++)for(const n of c){const a=this.grid[e][i].get(n);if(void 0!==a)for(const e of a){if(!e.isActive())continue;const i=this.squaredDistanceFromTile(e,t);if(i>l)continue;const n={unit:e,distSquared:i};(void 0===s||s(n))&&r.push(n)}}return r}unitIsInRange(t,e,i,s){return!!t.isActive()&&((void 0===s||t.owner().id()===s)&&this.squaredDistanceFromTile(t,e)<=i)}hasUnitNearby(t,e,i,s){const{startGridX:r,endGridX:n,startGridY:a,endGridY:o}=this.getCellsInRange(t,e),h=e*e;for(let e=a;e<=o;e++)for(let a=r;a<=n;a++){const r=this.grid[e][a].get(i);if(void 0!==r)for(const e of r)if(this.unitIsInRange(e,t,h,s))return!0}return!1}}class Wi{constructor(t,e,i,s,r,n){this._humans=t,this._nations=e,this._map=i,this.miniGameMap=s,this._config=r,this._stats=n,this._ticks=0,this.unInitExecs=[],this._players=new Map,this._playersBySmallID=[],this.execs=[],this.allianceRequests=[],this.alliances_=[],this.nextPlayerID=1,this._nextUnitID=1,this.updates=Hi(),this.botTeam=p,this._railNetwork=function(t){const e=new Di,i=new xi(t);return new Ci(t,e,i)}(this),this.nextAllianceID=0,this._terraNullius=new qi,this._width=i.width(),this._height=i.height(),this.unitGrid=new $i(this._map),r.gameConfig().gameMode===y.Team&&this.populateTeams(),this.addPlayers()}populateTeams(){let t=this._config.playerTeams();if("number"!=typeof t){const e=this._humans.length+this._nations.length;switch(t){case n:t=Math.ceil(e/2);break;case a:t=Math.ceil(e/3);break;case o:t=Math.ceil(e/4);break;default:throw new Error(`Unknown TeamCountConfig ${t}`)}}if(t<2)throw new Error(`Too few teams: ${t}`);if(t<8)this.playerTeams=["Red",h],t>=3&&this.playerTeams.push(u),t>=4&&this.playerTeams.push(g),t>=5&&this.playerTeams.push(c),t>=6&&this.playerTeams.push(d),t>=7&&this.playerTeams.push(l);else{this.playerTeams=[];for(let e=1;e<=t;e++)this.playerTeams.push(`Team ${e}`)}}addPlayers(){if(this.config().gameConfig().gameMode!==y.Team)return this._humans.forEach((t=>this.addPlayer(t))),void this._nations.forEach((t=>this.addPlayer(t.playerInfo)));const t=function(t,e){const i=new Map,s=new Map,r=new Map,n=[];for(const e of t)e.clan?(r.has(e.clan)||r.set(e.clan,[]),r.get(e.clan).push(e)):n.push(e);const a=Math.ceil(t.length/e.length),o=Array.from(r.entries()).sort(((t,e)=>e[1].length-t[1].length));for(const[t,r]of o){let t=null,n=0;for(const i of e){const e=s.get(i)??0;null!==t&&n<=e||(n=e,t=i)}if(null!==t){for(const e of r)n<a?(n++,i.set(e,t)):i.set(e,"kicked");s.set(t,n)}}let h=n.filter((t=>t.playerType===A.FakeHuman));h.length>0&&(h=new J(j(h[0].id)).shuffleArray(h));const l=n.filter((t=>t.playerType!==A.FakeHuman));for(const t of l.concat(h)){let r=null,n=0;for(const t of e){const e=s.get(t)??0;null!==r&&n<=e||(n=e,r=t)}null!==r&&(s.set(r,n+1),i.set(t,r))}return i}([...this._humans,...this._nations.map((t=>t.playerInfo))],this.playerTeams);for(const[e,i]of t.entries())"kicked"!==i?this.addPlayer(e,i):console.warn(`Player ${e.name} was kicked from team`)}isOnEdgeOfMap(t){return this._map.isOnEdgeOfMap(t)}owner(t){return this.playerBySmallID(this.ownerID(t))}alliances(){return this.alliances_}playerBySmallID(t){return 0===t?this.terraNullius():this._playersBySmallID[t-1]}map(){return this._map}miniMap(){return this.miniGameMap}addUpdate(t){this.updates[t.type].push(t)}nextUnitID(){const t=this._nextUnitID;return this._nextUnitID++,t}setFallout(t,e){if(e&&this.hasOwner(t))throw Error(`cannot set fallout, tile ${t} has owner`);this._map.hasFallout(t)||(this._map.setFallout(t,e),this.addUpdate({type:pe.Tile,update:this.toTileUpdate(t)}))}units(...t){return Array.from(this._players.values()).flatMap((e=>e.units(...t)))}unitCount(t){let e=0;for(const i of this._players.values())e+=i.unitCount(t);return e}unitInfo(t){return this.config().unitInfo(t)}nations(){return this._nations}createAllianceRequest(t,e){if(t.isAlliedWith(e))return console.log("cannot request alliance, already allied"),null;if(void 0!==e.incomingAllianceRequests().find((e=>e.requestor()===t)))return console.log(`duplicate alliance request from ${t.name()}`),null;const i=t.incomingAllianceRequests().find((t=>t.requestor()===e));if(void 0!==i)return console.log("got corresponding alliance requests, accepting"),i.accept(),null;const s=new bi(t,e,this._ticks,this);return this.allianceRequests.push(s),this.addUpdate(s.toUpdate()),s}acceptAllianceRequest(t){this.allianceRequests=this.allianceRequests.filter((e=>e!==t));const e=t.requestor(),i=t.recipient();if(e.allianceWith(i))throw new Error(`cannot accept alliance request, already allied with ${i.name()}`);const s=new wi(this,e,i,this._ticks,this.nextAllianceID++);this.alliances_.push(s),t.requestor().pastOutgoingAllianceRequests.push(t),e.hasEmbargoAgainst(i)&&e.endTemporaryEmbargo(i),i.hasEmbargoAgainst(e)&&i.endTemporaryEmbargo(e),this.addUpdate({type:pe.AllianceRequestReply,request:t.toUpdate(),accepted:!0})}rejectAllianceRequest(t){this.allianceRequests=this.allianceRequests.filter((e=>e!==t)),t.requestor().pastOutgoingAllianceRequests.push(t),this.addUpdate({type:pe.AllianceRequestReply,request:t.toUpdate(),accepted:!1})}hasPlayer(t){return this._players.has(t)}config(){return this._config}inSpawnPhase(){return this._ticks<=this.config().numSpawnPhaseTurns()}ticks(){return this._ticks}executeNextTick(){this.updates=Hi(),this.execs.forEach((t=>{this.inSpawnPhase()&&!t.activeDuringSpawnPhase()||!t.isActive()||t.tick(this._ticks)}));const t=[],e=[];this.unInitExecs.forEach((i=>{!this.inSpawnPhase()||i.activeDuringSpawnPhase()?(i.init(this,this._ticks),t.push(i)):e.push(i)})),this.removeInactiveExecutions(),this.execs.push(...t),this.unInitExecs=e;for(const t of this._players.values())this.addUpdate(t.toUpdate());return this.ticks()%10==0&&this.addUpdate({type:pe.Hash,tick:this.ticks(),hash:this.hash()}),this._ticks++,this.updates}hash(){let t=1;return this._players.forEach((e=>{t+=e.hash()})),t}terraNullius(){return this._terraNullius}removeInactiveExecutions(){const t=[];for(const e of this.execs)this.inSpawnPhase()?e.activeDuringSpawnPhase()?e.isActive()&&t.push(e):t.push(e):e.isActive()&&t.push(e);this.execs=t}players(){return Array.from(this._players.values()).filter((t=>t.isAlive()))}allPlayers(){return Array.from(this._players.values())}executions(){return[...this.execs,...this.unInitExecs]}addExecution(...t){this.unInitExecs.push(...t)}removeExecution(t){this.execs=this.execs.filter((e=>e!==t)),this.unInitExecs=this.unInitExecs.filter((e=>e!==t))}playerView(t){return this.player(t)}addPlayer(t,e=null){const i=new Ei(this,this.nextPlayerID,t,this.config().startManpower(t),e??this.maybeAssignTeam(t));return this._playersBySmallID.push(i),this.nextPlayerID++,this._players.set(t.id,i),i}maybeAssignTeam(t){if(this._config.gameConfig().gameMode!==y.Team)return null;if(t.playerType===A.Bot)return this.botTeam;const e=j(t.id);return this.playerTeams[e%this.playerTeams.length]}player(t){const e=this._players.get(t);if(void 0===e)throw new Error(`Player with id ${t} not found`);return e}playerByClientID(t){for(const[,e]of this._players)if(e.clientID()===t)return e;return null}isOnMap(t){return t.x>=0&&t.x<this._width&&t.y>=0&&t.y<this._height}neighborsWithDiag(t){const e=this.x(t),i=this.y(t),s=[];for(let t=-1;t<=1;t++)for(let r=-1;r<=1;r++){if(0===t&&0===r)continue;const n=e+t,a=i+r;n>=0&&n<this._width&&a>=0&&a<this._height&&s.push(this._map.ref(n,a))}return s}conquer(t,e){if(!this.isLand(e))throw Error("cannot conquer water");const i=this.owner(e);i.isPlayer()&&(i._lastTileChange=this._ticks,i._tiles.delete(e),i._borderTiles.delete(e)),this._map.setOwnerID(e,t.smallID()),t._tiles.add(e),t._lastTileChange=this._ticks,this.updateBorders(e),this._map.setFallout(e,!1),this.addUpdate({type:pe.Tile,update:this.toTileUpdate(e)})}relinquish(t){if(!this.hasOwner(t))throw new Error("Cannot relinquish tile because it is unowned");if(this.isWater(t))throw new Error("Cannot relinquish water");const e=this.owner(t);e._lastTileChange=this._ticks,e._tiles.delete(t),e._borderTiles.delete(t),this._map.setOwnerID(t,0),this.updateBorders(t),this.addUpdate({type:pe.Tile,update:this.toTileUpdate(t)})}updateBorders(t){const e=[];e.push(t),this.neighbors(t).forEach((t=>e.push(t)));for(const t of e)this.hasOwner(t)&&(this.calcIsBorder(t)?this.owner(t)._borderTiles.add(t):this.owner(t)._borderTiles.delete(t))}calcIsBorder(t){if(!this.hasOwner(t))return!1;for(const e of this.neighbors(t))if(this.owner(t)!==this.owner(e))return!0;return!1}target(t,e){this.addUpdate({type:pe.TargetPlayer,playerID:t.smallID(),targetID:e.smallID()})}breakAlliance(t,e){let i;if(i=e.requestor()===t?e.recipient():e.requestor(),!t.isAlliedWith(i))throw new Error(`${t} not allied with ${i}, cannot break alliance`);i.isTraitor()||i.isDisconnected()||t.markTraitor();const s=new Set(t.alliances()),r=i.alliances().filter((t=>s.has(t)));if(1!==r.length)throw new Error(`must have exactly one alliance, have ${r.length}`);this.alliances_=this.alliances_.filter((t=>t!==r[0])),this.addUpdate({type:pe.BrokeAlliance,traitorID:t.smallID(),betrayedID:i.smallID()})}expireAlliance(t){const e=new Set(t.recipient().alliances()),i=t.requestor().alliances().filter((t=>e.has(t)));if(1!==i.length)throw new Error(`cannot expire alliance: must have exactly one alliance, have ${i.length}`);this.alliances_=this.alliances_.filter((t=>t!==i[0])),this.addUpdate({type:pe.AllianceExpired,player1ID:t.requestor().smallID(),player2ID:t.recipient().smallID()})}sendEmojiUpdate(t){this.addUpdate({type:pe.Emoji,emoji:t})}setWinner(t,e){this.addUpdate({type:pe.Win,winner:this.makeWinner(t),allPlayersStats:e})}makeWinner(t){if("string"==typeof t)return["team",t,...this.players().filter((e=>e.team()===t&&null!==e.clientID())).map((t=>t.clientID()))];{const e=t.clientID();if(null===e)return;return["player",e]}}teams(){return this._config.gameConfig().gameMode!==y.Team?[]:[this.botTeam,...this.playerTeams]}displayMessage(t,e,i,s,r){let n=null;null!==i&&(n=this.player(i).smallID()),this.addUpdate({type:pe.DisplayEvent,messageType:e,message:t,playerID:n,goldAmount:s,params:r})}displayChat(t,e,i,s,r,n){let a=null;null!==s&&(a=this.player(s).smallID()),this.addUpdate({type:pe.DisplayChatEvent,key:t,category:e,target:i,playerID:a,isFrom:r,recipient:n})}displayIncomingUnit(t,e,i,s){const r=this.player(s).smallID();this.addUpdate({type:pe.UnitIncoming,unitID:t,message:e,messageType:i,playerID:r})}addUnit(t){this.unitGrid.addUnit(t)}removeUnit(t){this.unitGrid.removeUnit(t),t.hasTrainStation()&&this._railNetwork.removeStation(t)}updateUnitTile(t){this.unitGrid.updateUnitCell(t)}hasUnitNearby(t,e,i,s){return this.unitGrid.hasUnitNearby(t,e,i,s)}nearbyUnits(t,e,i,s){return this.unitGrid.nearbyUnits(t,e,i,s)}ref(t,e){return this._map.ref(t,e)}isValidRef(t){return this._map.isValidRef(t)}x(t){return this._map.x(t)}y(t){return this._map.y(t)}cell(t){return this._map.cell(t)}width(){return this._map.width()}height(){return this._map.height()}numLandTiles(){return this._map.numLandTiles()}isValidCoord(t,e){return this._map.isValidCoord(t,e)}isLand(t){return this._map.isLand(t)}isOceanShore(t){return this._map.isOceanShore(t)}isOcean(t){return this._map.isOcean(t)}isShoreline(t){return this._map.isShoreline(t)}magnitude(t){return this._map.magnitude(t)}ownerID(t){return this._map.ownerID(t)}hasOwner(t){return this._map.hasOwner(t)}setOwnerID(t,e){return this._map.setOwnerID(t,e)}hasFallout(t){return this._map.hasFallout(t)}isBorder(t){return this._map.isBorder(t)}neighbors(t){return this._map.neighbors(t)}isWater(t){return this._map.isWater(t)}isLake(t){return this._map.isLake(t)}isShore(t){return this._map.isShore(t)}cost(t){return this._map.cost(t)}terrainType(t){return this._map.terrainType(t)}forEachTile(t){return this._map.forEachTile(t)}manhattanDist(t,e){return this._map.manhattanDist(t,e)}euclideanDistSquared(t,e){return this._map.euclideanDistSquared(t,e)}bfs(t,e){return this._map.bfs(t,e)}toTileUpdate(t){return this._map.toTileUpdate(t)}updateTile(t){return this._map.updateTile(t)}numTilesWithFallout(){return this._map.numTilesWithFallout()}stats(){return this._stats}railNetwork(){return this._railNetwork}conquerPlayer(t,e){const i=e.gold();this.displayMessage(`Conquered ${e.displayName()} received ${Ht(i)} gold`,S.CONQUERED_PLAYER,t.id(),i),t.addGold(i),e.removeGold(i),this.addUpdate({type:pe.ConquestEvent,conquerorId:t.id(),conqueredId:e.id(),gold:i}),this.stats().goldWar(t,e,i)}}const Hi=()=>{const t={};return Object.values(pe).filter((t=>!isNaN(Number(t)))).forEach((e=>{t[e]=[]})),t},Gi=new Map;async function Vi(t,e){if(e.length!==t.width*t.height)throw new Error(`Invalid data: buffer size ${e.length} incorrect for ${t.width}x${t.height} terrain plus 4 bytes for dimensions.`);return new re(t.width,t.height,e,t.num_land_tiles)}async function zi(t,e,i,s){const r=await Ut(t.config,null),n=await async function(t,e,i){const s=Gi.get(t);if(void 0!==s)return s;const r=i.getMapData(t),n=await r.manifest(),a=e===w.Normal?await Vi(n.map,await r.mapBin()):await Vi(n.map4x,await r.map4xBin()),o=e===w.Normal?await Vi(e===w.Normal?n.map4x:n.map16x,await r.map4xBin()):await Vi(n.map16x,await r.map16xBin());e===w.Compact&&n.nations.forEach((t=>{t.coordinates=[Math.floor(t.coordinates[0]/2),Math.floor(t.coordinates[1]/2)]}));const h={nations:n.nations,gameMap:a,miniGameMap:o};return Gi.set(t,h),h}(t.config.gameMap,t.config.gameMapSize,i),a=new J(j(t.gameID)),o=function(t,e,i,s,r){const n=new Li;return new Wi(t,e,i,s,r,n)}(t.players.map((t=>{return new x(t.clientID===e?U(t.username):function(t){return Mi.hasMatch(t)}(i=U(t.username))?_i[j(i)%_i.length]:i,A.Human,t.clientID,a.nextID());var i})),t.config.disableNPCs?[]:n.nations.map((t=>new I(new D(t.coordinates[0],t.coordinates[1]),t.strength,new x(t.name,A.FakeHuman,null,a.nextID())))),n.gameMap,n.miniGameMap,r),h=new Ki(o,new fi(o,t.gameID,e),s);return h.init(),h}class Ki{constructor(t,e,i){this.game=t,this.execManager=e,this.callBack=i,this.turns=[],this.currTurn=0,this.isExecuting=!1,this.playerViewData={}}init(){this.game.config().bots()>0&&this.game.addExecution(...this.execManager.spawnBots(this.game.config().numBots())),this.game.config().spawnNPCs()&&this.game.addExecution(...this.execManager.fakeHumanExecutions()),this.game.addExecution(new yi)}addTurn(t){this.turns.push(t)}executeNextTick(){if(this.isExecuting)return;if(this.currTurn>=this.turns.length)return;let t;this.isExecuting=!0,this.game.addExecution(...this.execManager.createExecs(this.turns[this.currTurn])),this.currTurn++;try{t=this.game.executeNextTick()}catch(t){return void(t instanceof Error?(console.error("Game tick error:",t.message),this.callBack({errMsg:t.message,stack:t.stack})):console.error("Game tick error:",t))}this.game.inSpawnPhase()&&this.game.ticks()%2==0&&this.game.players().filter((t=>t.type()===A.Human||t.type()===A.FakeHuman)).forEach((t=>this.playerViewData[t.id()]=H(this.game,t))),(this.game.ticks()<3||this.game.ticks()%30==0)&&this.game.players().forEach((t=>{this.playerViewData[t.id()]=H(this.game,t)}));const e=t[pe.Tile].map((t=>t.update));t[pe.Tile]=[],this.callBack({tick:this.game.ticks(),packedTileUpdates:new BigUint64Array(e),updates:t,playerNameViewData:this.playerViewData}),this.isExecuting=!1}playerActions(t,e,i){const r=this.game.player(t),n=void 0!==e&&void 0!==i?this.game.ref(e,i):null,a={canAttack:null!==n&&r.canAttack(n),buildableUnits:r.buildableUnits(n),canSendEmojiAllPlayers:r.canSendEmoji(s)};if(null!==n&&this.game.hasOwner(n)){const t=this.game.owner(n);a.interaction={sharedBorder:r.sharesBorderWith(t),canSendEmoji:r.canSendEmoji(t),canTarget:r.canTarget(t),canSendAllianceRequest:r.canSendAllianceRequest(t),canBreakAlliance:r.isAlliedWith(t),canDonateGold:r.canDonateGold(t),canDonateTroops:r.canDonateTroops(t),canEmbargo:!r.hasEmbargoAgainst(t)};const e=r.allianceWith(t);e&&(a.interaction.allianceExpiresAt=e.expiresAt())}return a}playerProfile(t){const e=this.game.playerBySmallID(t);if(!e.isPlayer())throw new Error(`player with id ${t} not found`);return e.playerProfile()}playerBorderTiles(t){const e=this.game.player(t);if(!e.isPlayer())throw new Error(`player with id ${t} not found`);return{borderTiles:e.borderTiles()}}attackAveragePosition(t,e){const i=this.game.playerBySmallID(t);if(!i.isPlayer())throw new Error(`player with id ${t} not found`);const s=t=>t.id()===e,r=i.outgoingAttacks().find(s)??i.incomingAttacks().find(s);return void 0===r?null:r.averagePosition()}bestTransportShipSpawn(t,e){const i=this.game.player(t);if(!i.isPlayer())throw new Error(`player with id ${t} not found`);return i.bestTransportShipSpawn(e)}}const Yi=self;let Xi=null;const Qi=new class{constructor(t,e){this.prefix=t,this.cacheBuster=e,this.maps=new Map}getMapData(t){const e=this.maps.get(t);if(e)return e;const i=Object.keys(m).find((e=>m[e]===t)),s=i?.toLowerCase();if(!s)throw new Error(`Unknown map: ${t}`);const r={mapBin:()=>this.loadBinaryFromUrl(this.url(s,"map.bin")),map4xBin:()=>this.loadBinaryFromUrl(this.url(s,"map4x.bin")),map16xBin:()=>this.loadBinaryFromUrl(this.url(s,"map16x.bin")),manifest:()=>this.loadJsonFromUrl(this.url(s,"manifest.json")),webpPath:async()=>this.url(s,"thumbnail.webp")};return this.maps.set(t,r),r}url(t,e){let i=`${this.prefix}/${t}/${e}`;return this.cacheBuster&&(i+=`${i.includes("?")?"&":"?"}v=${this.cacheBuster}`),i}async loadBinaryFromUrl(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load ${t}: ${e.statusText}`);const i=await e.arrayBuffer();return new Uint8Array(i)}async loadJsonFromUrl(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load ${t}: ${e.statusText}`);return e.json()}}("/maps","EXPERIMENTAL BUILD\nFOR INTERNAL USE ONLY\n");function Ji(t){"updates"in t&&Zi({type:"game_update",gameUpdate:t})}function Zi(t){Yi.postMessage(t)}Yi.addEventListener("message",(async t=>{const e=t.data;switch(e.type){case"heartbeat":(await Xi)?.executeNextTick();break;case"init":try{Xi=zi(e.gameStartInfo,e.clientID,Qi,Ji).then((t=>(Zi({type:"initialized",id:e.id}),t)))}catch(t){throw console.error("Failed to initialize game runner:",t),t}break;case"turn":if(!Xi)throw new Error("Game runner not initialized");try{const t=await Xi;await t.addTurn(e.turn)}catch(t){throw console.error("Failed to process turn:",t),t}break;case"player_actions":if(!Xi)throw new Error("Game runner not initialized");try{const t=(await Xi).playerActions(e.playerID,e.x,e.y);Zi({type:"player_actions_result",id:e.id,result:t})}catch(t){throw console.error("Failed to check borders:",t),t}break;case"player_profile":if(!Xi)throw new Error("Game runner not initialized");try{const t=(await Xi).playerProfile(e.playerID);Zi({type:"player_profile_result",id:e.id,result:t})}catch(t){throw console.error("Failed to check borders:",t),t}break;case"player_border_tiles":if(!Xi)throw new Error("Game runner not initialized");try{const t=(await Xi).playerBorderTiles(e.playerID);Zi({type:"player_border_tiles_result",id:e.id,result:t})}catch(t){throw console.error("Failed to get border tiles:",t),t}break;case"attack_average_position":if(!Xi)throw new Error("Game runner not initialized");try{const t=(await Xi).attackAveragePosition(e.playerID,e.attackID);Zi({type:"attack_average_position_result",id:e.id,x:t?t.x:null,y:t?t.y:null})}catch(t){throw console.error("Failed to get attack average position:",t),t}break;case"transport_ship_spawn":if(!Xi)throw new Error("Game runner not initialized");try{const t=(await Xi).bestTransportShipSpawn(e.playerID,e.targetTile);Zi({type:"transport_ship_spawn_result",id:e.id,result:t})}catch(t){console.error("Failed to spawn transport ship:",t)}break;default:console.warn("Unknown message :",e)}})),Yi.addEventListener("error",(t=>{console.error("Worker error:",t)})),Yi.addEventListener("unhandledrejection",(t=>{console.error("Unhandled promise rejection in worker:",t)}))},41234:()=>{}},s={};function r(t){var e=s[t];if(void 0!==e)return e.exports;var n=s[t]={id:t,loaded:!1,exports:{}};return i[t].call(n.exports,n,n.exports,r),n.loaded=!0,n.exports}r.m=i,r.x=()=>{var t=r.O(void 0,[96],(()=>r(38001)));return r.O(t)},r.amdD=function(){throw new Error("define cannot be used indirect")},r.amdO={},t=[],r.O=(e,i,s,n)=>{if(!i){var a=1/0;for(c=0;c<t.length;c++){for(var[i,s,n]=t[c],o=!0,h=0;h<i.length;h++)(!1&n||a>=n)&&Object.keys(r.O).every((t=>r.O[t](i[h])))?i.splice(h--,1):(o=!1,n<a&&(a=n));if(o){t.splice(c--,1);var l=s();void 0!==l&&(e=l)}}return e}n=n||0;for(var c=t.length;c>0&&t[c-1][2]>n;c--)t[c]=t[c-1];t[c]=[i,s,n]},r.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return r.d(e,{a:e}),e},r.d=(t,e)=>{for(var i in e)r.o(e,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},r.f={},r.e=t=>Promise.all(Object.keys(r.f).reduce(((e,i)=>(r.f[i](t,e),e)),[])),r.u=t=>"js/vendors.3d26e67ee769e91382ce.js",r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.nmd=t=>(t.paths=[],t.children||(t.children=[]),t),r.j=418,r.p="/",(()=>{var t={418:1};r.f.i=(e,i)=>{t[e]||importScripts(r.p+r.u(e))};var e=self.webpackChunkopenfront_client=self.webpackChunkopenfront_client||[],i=e.push.bind(e);e.push=e=>{var[s,n,a]=e;for(var o in n)r.o(n,o)&&(r.m[o]=n[o]);for(a&&a(r);s.length;)t[s.pop()]=1;i(e)}})(),r.nc=void 0,e=r.x,r.x=()=>r.e(96).then(e),r.x()})();